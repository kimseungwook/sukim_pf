# overlays/prod/goyoai-gointern-web/configmap_promtail_sidecar.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: goyoai-gointern-web-promtail-config
  namespace: goyoai-web
data:
  promtail.yaml: |
    server:
      http_listen_port: 9080
      grpc_listen_port: 0
      log_level: info

    positions:
      filename: /tmp/positions.yaml

    clients:
      - url: http://goyo-loki-distributed-gateway.monitoring.svc.cluster.local:80/loki/api/v1/push
        timeout: 10s
        backoff_config:
          min_period: 100ms
          max_period: 10s
          max_retries: 10

    scrape_configs:
      - job_name: goyoai-gointern-web
        static_configs:
          - targets:
              - localhost
            labels:
              job: goyoai-gointern-web
              namespace: goyoai-web
              app: goyoai-gointern-web-app
              environment: prod
              node_type: virtual
              service_name: goyoai-gointern-web-app
              __path__: /var/log/app/application.log
        
        pipeline_stages:
          # 1. 타임스탬프 파싱 (로그 형식: 09:30:45.123 LEVEL [thread] logger - message)
          - regex:
              expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}\.\d{3})\s+(?P<level>DEBUG|INFO|WARN|ERROR|FATAL)\s+\[(?P<thread>[^\]]+)\]\s+(?P<logger>\S+)\s+-\s+(?P<message>.*)$'
          
          # 2. 타임스탬프 파싱
          - timestamp:
              source: timestamp
              format: "2006-01-02 15:04:05.000" # "yyyy-MM-dd HH:mm:ss.SSS"
              location: "Asia/Seoul"
          
          # 3. 로그 레벨 레이블 추가
          - labels:
              level:
          
          # 4. 트레이스 정보 추출 (있는 경우)
          - regex:
              expression: '\[(?P<traceId>[a-f0-9]{16,32}),(?P<spanId>[a-f0-9]{16,32})\]'
              source: message
          
          - labels:
              traceId:
              spanId:
          
          # 5. 에러 로그 플래그
          - match:
              selector: '{level="ERROR"}'
              stages:
                - static_labels:
                    error_flag: "true"
          
          # 6. 출력 메시지 설정
          - output:
              source: message
