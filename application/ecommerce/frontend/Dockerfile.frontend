# Dockerfile.frontend
# Optimized Dockerfile for ecommerce-react React+Vite Frontend
# Optimized for OKE Virtual Node (Harbor Layer Cache only, no PVC)
#
# Usage: docker build -f Dockerfile.frontend -t ecommerce-frontend:latest . 

ARG NODE_VERSION=20.18.3
ARG ALPINE_VERSION=3.21

# ============================================================================
# Dependencies Stage - npm ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ (Layer Cache í™œìš©)
# ============================================================================
FROM node:${NODE_VERSION}-alpine${ALPINE_VERSION} AS dependencies

WORKDIR /app

# â­ Step 1: package.jsonê³¼ lock íŒŒì¼ë§Œ ë¨¼ì € ë³µì‚¬ (ê±°ì˜ ë³€í•˜ì§€ ì•ŠìŒ)
COPY package.json package-lock.json ./

# â­ Step 2: ì˜ì¡´ì„±ë§Œ ë‹¤ìš´ë¡œë“œ (ì´ LayerëŠ” package.json ë³€ê²½ ì‹œì—ë§Œ ì¬ë¹Œë“œ)
RUN echo "=========================================" && \
    echo "ğŸ“¦ Downloading NPM Dependencies" && \
    echo "=========================================" && \
    echo "Project: ecommerce-react-frontend" && \
    echo "Node Version: $(node --version)" && \
    echo "NPM Version: $(npm --version)" && \
    echo "=========================================" && \
    echo "" && \
    npm ci --no-audit --no-fund && \
    echo "" && \
    echo "âœ… Dependencies downloaded successfully" && \
    echo ""

# ============================================================================
# Builder Stage - ì†ŒìŠ¤ ì»´íŒŒì¼ (ì†ŒìŠ¤ ë³€ê²½ ì‹œì—ë§Œ ì¬ë¹Œë“œ)
# ============================================================================
FROM node:${NODE_VERSION}-alpine${ALPINE_VERSION} AS builder

WORKDIR /app

# â­ Step 3: ë‹¤ìš´ë¡œë“œëœ node_modules ë³µì‚¬ (dependencies stageì—ì„œ)
COPY --from=dependencies /app/node_modules ./node_modules

# â­ Step 4: ì†ŒìŠ¤ì½”ë“œ ë³µì‚¬ (ì´ LayerëŠ” ì†ŒìŠ¤ ë³€ê²½ ì‹œì—ë§Œ ì¬ë¹Œë“œ)
COPY . .

# â­ Step 5: ë¹Œë“œ ì‹¤í–‰ (Vite build)
RUN echo "=========================================" && \
    echo "ğŸ”¨ Building React Application (Vite)" && \
    echo "=========================================" && \
    echo "Project: ecommerce-react-frontend" && \
    echo "Node Version: $(node --version)" && \
    echo "Build Tool: Vite" && \
    echo "=========================================" && \
    echo "" && \
    npm run build && \
    echo "" && \
    echo "=========================================" && \
    echo "âœ… Build Completed" && \
    echo "=========================================" && \
    echo "" && \
    if [ -d "dist" ]; then \
        echo "ğŸ“¦ Build Output (dist directory):" && \
        ls -lh dist/ && \
        echo "" && \
        echo "Total dist size:" && \
        du -sh dist && \
        echo ""; \
    else \
        echo "âŒ CRITICAL: dist directory not found!" && \
        echo "Available directories:" && \
        ls -la && \
        exit 1; \
    fi && \
    echo "=========================================" && \
    echo "" && \
    # ë¹Œë“œ ìµœì í™”: ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œê±°
    rm -rf /root/.npm /tmp/* /root/.cache 2>/dev/null || true

# ============================================================================
# Runtime Stage - Nginxë¡œ ì •ì  íŒŒì¼ ì„œë¹™ (ê²½ëŸ‰í™”)
# ============================================================================
FROM nginx:1.27-alpine

# íƒ€ì„ì¡´ ì„¤ì •
ENV TZ=Asia/Seoul
RUN apk add --no-cache tzdata && \
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && \
    echo $TZ > /etc/timezone

WORKDIR /usr/share/nginx/html

# ê¸°ë³¸ nginx íŒŒì¼ ì œê±°
RUN rm -rf /usr/share/nginx/html/*

# ë¹Œë“œëœ dist íŒŒì¼ ë³µì‚¬
COPY --from=builder /app/dist /usr/share/nginx/html

# Nginx ì„¤ì • íŒŒì¼ ë³µì‚¬
COPY nginx.conf /etc/nginx/conf.d/default.conf

# í—¬ìŠ¤ì²´í¬ (Kubernetesì—ì„œ ì‚¬ìš©)
HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:80/ || exit 1

# ë©”íƒ€ë°ì´í„°
LABEL maintainer="sukim-pf@example.com" \
      description="Ecommerce React - Frontend (React + Vite)" \
      version="1.0" \
      app="ecommerce-frontend" \
      node.version="${NODE_VERSION}" \
      build.tool="vite"

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 80

# Nginx ì‹¤í–‰
CMD ["nginx", "-g", "daemon off;"]
