# Dockerfile.unified
# Unified Dockerfile for all goyoai-backend-system modules
# Optimized for Virtual Node (Harbor Layer Cache only)
#
# Usage: docker build --build-arg MODULE_NAME=goyoai-gointern-portal \
#                      --build-arg BASE_IMAGE=openjdk:17-jdk-oraclelinux8 \
#                      -f Dockerfile.unified . 

ARG BASE_IMAGE=gdhb.goyoai.com/common/openjdk:17-jdk-oraclelinux8-otel-2.21.0

# ============================================================================
# Dependencies Stage - ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ (Layer Cache í™œìš©)
# ============================================================================
FROM gdhb.goyoai.com/common/gradle:8.11.0-jdk17-corretto AS dependencies

ARG MODULE_NAME
ARG GRADLE_WORKERS=12
ARG GRADLE_MAX_MEMORY=5g

WORKDIR /app

# â­ Step 1: Gradle Wrapper íŒŒì¼ë§Œ ë¨¼ì € ë³µì‚¬ (ê±°ì˜ ë³€í•˜ì§€ ì•ŠìŒ)
COPY gradle gradle
COPY gradlew gradlew.bat ./

# â­ Step 2: ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ë“¤ë§Œ ë³µì‚¬ (ì˜ì¡´ì„± ì •ì˜)
COPY build.gradle.kts settings.gradle.kts ./

# ê³µí†µ ëª¨ë“ˆ build.gradle.ktsë§Œ ë³µì‚¬
# COPY goyoai-backend-common/build.gradle.kts goyoai-backend-common/
COPY goyoai-common/build.gradle.kts goyoai-common/
COPY goyoai-common-domain/build.gradle.kts goyoai-common-domain/
COPY goyoai-common-service/build.gradle.kts goyoai-common-service/

# íƒ€ê²Ÿ ëª¨ë“ˆ build.gradle.ktsë§Œ ë³µì‚¬
COPY ${MODULE_NAME}/build.gradle.kts ${MODULE_NAME}/

# â­ Step 3: gradle.properties ìƒì„± (ìµœì í™” ì„¤ì •)
RUN cat > gradle.properties <<EOF
# === JVM ë©”ëª¨ë¦¬ ì„¤ì • ===
org.gradle.jvmargs=-Xmx${GRADLE_MAX_MEMORY} -Xms4g -XX:MaxMetaspaceSize=2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200
kotlin.daemon.jvmargs=-Xmx40g -XX:+UseG1GC

# === ë³‘ë ¬ ë¹Œë“œ ì„¤ì • ===
org.gradle.parallel=true
org.gradle.workers.max=${GRADLE_WORKERS}
org.gradle.daemon=false

# === ìºì‹± ì„¤ì • ===
org.gradle.caching=true
org.gradle.configuration-cache=true
org.gradle.configuration-cache.problems=warn

# === Kotlin ìµœì í™” ===
kotlin.incremental=true
kotlin.incremental.usePreciseJavaTracking=true
kotlin.compiler.execution.strategy=in-process

# === Kapt ìµœì í™” ===
kapt.use.worker.api=true
kapt.incremental.apt=true
kapt.include.compile.classpath=false

# === ê¸°íƒ€ ===
org.gradle.vfs.watch=false
org.gradle.welcome=never
org.gradle.console=plain
EOF

# â­ Step 4: ì˜ì¡´ì„±ë§Œ ë‹¤ìš´ë¡œë“œ (ì´ LayerëŠ” build.gradle ë³€ê²½ ì‹œì—ë§Œ ì¬ë¹Œë“œ)
RUN echo "=========================================" && \
    echo "ğŸ“¦ Downloading Dependencies" && \
    echo "=========================================" && \
    echo "Module: ${MODULE_NAME}" && \
    echo "Workers: ${GRADLE_WORKERS}" && \
    echo "Memory: ${GRADLE_MAX_MEMORY}" && \
    echo "=========================================" && \
    echo "" && \
    ./gradlew dependencies \
    --no-daemon \
    --parallel \
    --max-workers=${GRADLE_WORKERS} \
    --stacktrace && \
    echo "" && \
    echo "âœ… Dependencies downloaded successfully" && \
    echo ""

# ============================================================================
# Builder Stage - ì†ŒìŠ¤ ì»´íŒŒì¼ (ì†ŒìŠ¤ ë³€ê²½ ì‹œì—ë§Œ ì¬ë¹Œë“œ)
# ============================================================================
FROM dependencies AS builder

ARG MODULE_NAME
ARG GRADLE_WORKERS=12

WORKDIR /app

# â­ Step 5: ì†ŒìŠ¤ì½”ë“œ ë³µì‚¬ (ì´ LayerëŠ” ì†ŒìŠ¤ ë³€ê²½ ì‹œì—ë§Œ ì¬ë¹Œë“œ)
# COPY goyoai-backend-common/src goyoai-backend-common/src
COPY goyoai-common/src goyoai-common/src
COPY goyoai-common-domain/src goyoai-common-domain/src
COPY goyoai-common-service/src goyoai-common-service/src
COPY ${MODULE_NAME}/src ${MODULE_NAME}/src

# â­ Step 6: ë¹Œë“œ ì‹¤í–‰
RUN echo "=========================================" && \
    echo "ğŸ”¨ Building Module" && \
    echo "=========================================" && \
    echo "Module: ${MODULE_NAME}" && \
    echo "Workers: ${GRADLE_WORKERS}" && \
    echo "=========================================" && \
    echo "" && \
    ./gradlew :${MODULE_NAME}:bootJar \
    -x test \
    --no-daemon \
    --parallel \
    --max-workers=${GRADLE_WORKERS} \
    --configuration-cache \
    --build-cache \
    --stacktrace && \
    echo "" && \
    echo "=========================================" && \
    echo "âœ… Build Completed" && \
    echo "=========================================" && \
    ls -lh /app/${MODULE_NAME}/build/libs/ && \
    echo "=========================================" && \
    echo "" && \
    # ì„ì‹œ íŒŒì¼ ì •ë¦¬
    rm -rf /tmp/hsperfdata_root/ && \
    rm -rf /tmp/kotlin-daemon* && \
    rm -rf /root/.kotlin/daemon && \
    find /root/.gradle/caches -type f -name "*.lock" -delete 2>/dev/null || true

# ============================================================================
# Runtime Stage - ìµœì¢… ì‹¤í–‰ ì´ë¯¸ì§€
# ============================================================================
FROM ${BASE_IMAGE}

ARG MODULE_NAME

# íƒ€ì„ì¡´ ì„¤ì •
ENV TZ=Asia/Seoul
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

WORKDIR /app

# ë¹Œë“œëœ JAR íŒŒì¼ ë³µì‚¬
COPY --from=builder /app/${MODULE_NAME}/build/libs/*.jar /app/app.jar
RUN chmod 644 /app/app.jar

# í—¬ìŠ¤ì²´í¬ (ì„ íƒì‚¬í•­)
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

# ë©”íƒ€ë°ì´í„°
LABEL module="${MODULE_NAME}" \
      maintainer="goyoai-devops@goyoai.com" \
      description="GoyoAI Backend System - ${MODULE_NAME}" \
      version="1.0"