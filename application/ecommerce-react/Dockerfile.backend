# Dockerfile.backend
# Optimized Dockerfile for ecommerce-react Go Backend
# Optimized for OKE Virtual Node (Harbor Layer Cache only, no PVC)
#
# Usage: docker build -f Dockerfile.backend -t ecommerce-backend:latest .

# ============================================================================
# Dependencies Stage - Go ëª¨ë“ˆ ë‹¤ìš´ë¡œë“œ (Layer Cache í™œìš©)
# ============================================================================
FROM golang:1.24.1-alpine3.21 AS dependencies

WORKDIR /app

# â­ Step 1: Go ëª¨ë“ˆ íŒŒì¼ë§Œ ë¨¼ì € ë³µì‚¬ (ê±°ì˜ ë³€í•˜ì§€ ì•ŠìŒ)
COPY go.mod go.sum ./

# â­ Step 2: ì˜ì¡´ì„±ë§Œ ë‹¤ìš´ë¡œë“œ (ì´ LayerëŠ” go.mod/go.sum ë³€ê²½ ì‹œì—ë§Œ ì¬ë¹Œë“œ)
RUN echo "=========================================" && \
    echo "ğŸ“¦ Downloading Go Dependencies" && \
    echo "=========================================" && \
    echo "Module: ecommerce_clean" && \
    echo "Go Version: $(go version)" && \
    echo "=========================================" && \
    echo "" && \
    go mod download && \
    go mod verify && \
    echo "" && \
    echo "âœ… Dependencies downloaded successfully" && \
    echo ""

# ============================================================================
# Builder Stage - ì†ŒìŠ¤ ì»´íŒŒì¼ (ì†ŒìŠ¤ ë³€ê²½ ì‹œì—ë§Œ ì¬ë¹Œë“œ)
# ============================================================================
FROM golang:1.24.1-alpine3.21 AS builder

WORKDIR /app

# â­ Step 3: ë‹¤ìš´ë¡œë“œëœ ëª¨ë“ˆ ë³µì‚¬ (dependencies stageì—ì„œ)
COPY --from=dependencies /go/pkg /go/pkg

# â­ Step 4: ì†ŒìŠ¤ì½”ë“œ ë³µì‚¬ (ì´ LayerëŠ” ì†ŒìŠ¤ ë³€ê²½ ì‹œì—ë§Œ ì¬ë¹Œë“œ)
COPY . .

# â­ Step 5: ë¹Œë“œ ì‹¤í–‰
RUN echo "=========================================" && \
    echo "ğŸ”¨ Building Go Application" && \
    echo "=========================================" && \
    echo "Module: ecommerce_clean" && \
    echo "Output: /bin/app" && \
    echo "=========================================" && \
    echo "" && \
    mkdir -p /bin && \
    CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
    go build -ldflags="-w -s" -o /bin/app ./cmd/app && \
    echo "" && \
    echo "=========================================" && \
    echo "âœ… Build Completed" && \
    echo "=========================================" && \
    ls -lh /bin/app && \
    echo "=========================================" && \
    echo "" && \
    # ë¹Œë“œ ìµœì í™”: ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œê±°
    rm -rf /root/.cache/go-build 2>/dev/null || true && \
    rm -rf /tmp/* 2>/dev/null || true

# ============================================================================
# Runtime Stage - ìµœì¢… ì‹¤í–‰ ì´ë¯¸ì§€ (ê²½ëŸ‰í™”)
# ============================================================================
FROM alpine:3.21

# íƒ€ì„ì¡´ ì„¤ì •
ENV TZ=Asia/Seoul
RUN apk add --no-cache tzdata && \
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && \
    echo $TZ > /etc/timezone

WORKDIR /app

# í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜ (í—¬ìŠ¤ì²´í¬ìš© curl í¬í•¨)
RUN apk add --no-cache \
    ca-certificates \
    curl

# ë¹Œë“œëœ ë°”ì´ë„ˆë¦¬ ë³µì‚¬
COPY --from=builder /bin/app /app/app
RUN chmod +x /app/app

# ì„¤ì • íŒŒì¼ ë° ì •ì±… íŒŒì¼ ë³µì‚¬
COPY --from=builder /app/policy /app/policy
COPY --from=builder /app/configs /app/configs

# Entrypoint ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬ (ìˆëŠ” ê²½ìš°)
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# í—¬ìŠ¤ì²´í¬ (Kubernetesì—ì„œ ì‚¬ìš©)
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8080/health || exit 1

# ë©”íƒ€ë°ì´í„°
LABEL maintainer="sukim-pf@example.com" \
      description="Ecommerce React - Go Backend API" \
      version="1.0" \
      app="ecommerce-backend"

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8080

# Entrypoint ì‹¤í–‰
ENTRYPOINT ["/entrypoint.sh"]
