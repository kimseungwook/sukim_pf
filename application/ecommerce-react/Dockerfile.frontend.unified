# Dockerfile.frontend.unified 
# Unified Dockerfile for goyoai-frontend monorepo - Development Environment
# Optimized for Virtual Node (Harbor Layer Cache) - Speed Priority
#
# Usage: docker build --build-arg APP=goyoai-gointern-web \
#                      --target=runtime-standalone \
#                      -f Dockerfile.frontend.unified . 

ARG NODE_VERSION=20.18.3
ARG ALPINE_VERSION=3.21
ARG BASE_IMAGE=gdhb.goyoai.com/common/node:${NODE_VERSION}-alpine${ALPINE_VERSION}

# ============================================================================
# Dependencies Stage - ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ (Layer Cache í™œìš©)
# ============================================================================
FROM ${BASE_IMAGE} AS dependencies

ARG APP
ARG PNPM_VERSION=9.12.0

WORKDIR /app

# â­ Step 1: pnpm ì„¤ì¹˜ (ê±°ì˜ ë³€í•˜ì§€ ì•ŠìŒ)
RUN npm install -g pnpm@${PNPM_VERSION}

# â­ Step 2: Workspace ì„¤ì • íŒŒì¼ë§Œ ë¨¼ì € ë³µì‚¬ (ê±°ì˜ ë³€í•˜ì§€ ì•ŠìŒ)
COPY pnpm-workspace.yaml ./
COPY .npmrc ./ 

# â­ Step 3: Root package.jsonê³¼ lockfileë§Œ ë³µì‚¬ (ì˜ì¡´ì„± ì •ì˜)
COPY package.json pnpm-lock.yaml ./

# â­ Step 4: package.json íŒŒì¼ë“¤ë§Œ ë³µì‚¬ (ê°„ì†Œí™”)
# appsì™€ packagesì˜ package.jsonë§Œ ë³µì‚¬í•˜ì—¬ ì˜ì¡´ì„± ì„¤ì¹˜
COPY apps/*/package.json /tmp/apps-pkg/
COPY packages/*/package.json /tmp/packages-pkg/

# apps êµ¬ì¡° ìƒì„±
RUN mkdir -p apps && \
    cd /tmp/apps-pkg && \
    for file in *; do \
        if [ -f "$file" ]; then \
            appname=$(echo "$file" | sed 's/package.json//'); \
            if [ -n "$appname" ]; then \
                mkdir -p /app/apps/$appname && \
                cp "$file" /app/apps/$appname/package.json; \
            fi; \
        fi; \
    done

# packages êµ¬ì¡° ìƒì„±
RUN mkdir -p packages && \
    cd /tmp/packages-pkg && \
    for file in *; do \
        if [ -f "$file" ]; then \
            pkgname=$(echo "$file" | sed 's/package.json//'); \
            if [ -n "$pkgname" ]; then \
                mkdir -p /app/packages/$pkgname && \
                cp "$file" /app/packages/$pkgname/package.json; \
            fi; \
        fi; \
    done && \
    rm -rf /tmp/apps-pkg /tmp/packages-pkg

# â­â­â­ Step 4.5: packages ë””ë ‰í† ë¦¬ ì „ì²´ ë³µì‚¬ (workspace íŒ¨í‚¤ì§€ í•´ê²°ìš©)
# ì´ ë‹¨ê³„ê°€ ì¶”ê°€ë˜ì–´ì•¼ @repo/* íŒ¨í‚¤ì§€ë“¤ì´ ì œëŒ€ë¡œ ì¸ì‹ë©ë‹ˆë‹¤
COPY packages/ ./packages/

# â­â­â­ Step 5: ì˜ì¡´ì„± ì„¤ì¹˜ (production=false, shamefully-hoist ì ìš©)
RUN echo "=========================================" && \
    echo "ğŸ“¦ Installing Dependencies" && \
    echo "=========================================" && \
    echo "Target APP: ${APP}" && \
    echo "PNPM Version: ${PNPM_VERSION}" && \
    echo "Install Mode: Development (includes devDependencies)" && \
    echo "Hoisting: Enabled (--shamefully-hoist)" && \
    echo "=========================================" && \
    echo "" && \
    pnpm install --no-frozen-lockfile --shamefully-hoist && \
    echo "" && \
    echo "=========================================" && \
    echo "âœ… Dependencies installed successfully" && \
    echo "=========================================" && \
    echo "" && \
    echo "--- Verification ---" && \
    echo "Checking critical build tools:" && \
    ls -la /app/node_modules/.bin/env-cmd 2>/dev/null && echo "  âœ“ env-cmd found" || echo "  âœ— env-cmd MISSING" && \
    ls -la /app/node_modules/.bin/next 2>/dev/null && echo "  âœ“ next found" || echo "  âœ— next MISSING" && \
    ls -la /app/node_modules/.bin/tailwindcss 2>/dev/null && echo "  âœ“ tailwindcss found" || echo "  âœ— tailwindcss MISSING" && \
    echo "" && \
    echo "Workspace packages:" && \
    ls -d /app/packages/*/ 2>/dev/null | xargs -n1 basename || echo "  No packages found" && \
    echo "" && \
    echo "Total node_modules size:" && \
    du -sh /app/node_modules 2>/dev/null || echo "  node_modules size: N/A" && \
    echo "=========================================" && \
    echo ""

# ============================================================================
# Builder Stage - ì†ŒìŠ¤ ì»´íŒŒì¼ (ì†ŒìŠ¤ ë³€ê²½ ì‹œì—ë§Œ ì¬ë¹Œë“œ)
# ============================================================================
FROM dependencies AS builder

ARG APP

WORKDIR /app

# â­ Step 6: ì†ŒìŠ¤ì½”ë“œ ë³µì‚¬
# packagesëŠ” ì´ë¯¸ dependencies stageì—ì„œ ë³µì‚¬í–ˆìœ¼ë¯€ë¡œ
# ì—¬ê¸°ì„œëŠ” appsë§Œ ì¶”ê°€ë¡œ ë³µì‚¬í•˜ë©´ ë¨
COPY apps/ ./apps/

# turbo.json ë“± ë¹Œë“œì— í•„ìš”í•œ ë£¨íŠ¸ ì„¤ì • íŒŒì¼ë“¤
COPY turbo.json* ./

# â­â­â­ Step 6.5: node_modules ìƒíƒœ í™•ì¸ ë° ì¬ì„¤ì¹˜
# Multi-stage buildì—ì„œ workspace ë§í¬ê°€ ê¹¨ì§€ë¯€ë¡œ ì „ì²´ ì¬ì„¤ì¹˜ í•„ìš”
RUN echo "=========================================" && \
    echo "ğŸ” Verifying Dependencies for Build" && \
    echo "=========================================" && \
    echo "Checking inherited node_modules:" && \
    if [ -d "/app/node_modules" ]; then \
        echo "  âœ“ Root node_modules exists" && \
        echo "  Size: $(du -sh /app/node_modules 2>/dev/null | cut -f1)"; \
    else \
        echo "  âœ— Root node_modules MISSING - CRITICAL ERROR" && \
        exit 1; \
    fi && \
    echo "" && \
    echo "Checking critical build tools:" && \
    test -f /app/node_modules/.bin/env-cmd && echo "  âœ“ env-cmd available" || echo "  âœ— env-cmd MISSING" && \
    test -f /app/node_modules/.bin/next && echo "  âœ“ next available" || echo "  âœ— next MISSING" && \
    test -f /app/node_modules/.bin/tailwindcss && echo "  âœ“ tailwindcss available" || echo "  âœ— tailwindcss MISSING" && \
    echo "" && \
    echo "ğŸ”„ Re-installing workspace dependencies (full install):" && \
    pnpm install --no-frozen-lockfile --shamefully-hoist && \
    echo "  âœ“ Dependencies re-installed successfully" && \
    echo "" && \
    echo "Verifying env-cmd after reinstall:" && \
    ls -la /app/node_modules/.bin/env-cmd && \
    if [ -d "apps/${APP}" ]; then \
        echo "Checking app-level node_modules link:" && \
        ls -la apps/${APP}/node_modules/.bin/env-cmd 2>/dev/null || echo "  (App uses hoisted node_modules)"; \
    fi && \
    echo "=========================================" && \
    echo ""

# â­ Step 7: ë¹Œë“œ ì‹¤í–‰ (ê°œë°œ í™˜ê²½ìš©)
RUN echo "=========================================" && \
    echo "ğŸ”¨ Building Application (Development)" && \
    echo "=========================================" && \
    echo "Target APP: ${APP}" && \
    echo "Node Version: $(node --version)" && \
    echo "PNPM Version: $(pnpm --version)" && \
    echo "=========================================" && \
    echo "" && \
    echo "--- Pre-Build Directory Check ---" && \
    ls -la apps/${APP}/ && \
    echo "" && \
    echo "--- Build Tool Availability ---" && \
    echo "PATH: $PATH" && \
    which env-cmd 2>/dev/null || echo "env-cmd not in PATH (will use from node_modules/.bin)" && \
    /app/node_modules/.bin/env-cmd --version 2>/dev/null || echo "env-cmd direct path check failed" && \
    echo "" && \
    echo "=========================================" && \
    echo "ğŸ” Detecting Available Build Script" && \
    echo "=========================================" && \
    BUILD_SCRIPT="" && \
    cd /app && \
    if grep -q '"build:dev"' apps/${APP}/package.json; then \
        BUILD_SCRIPT="build:dev" && \
        echo "âœ“ Found: build:dev"; \
    elif grep -q '"build"' apps/${APP}/package.json; then \
        BUILD_SCRIPT="build" && \
        echo "âœ“ Found: build (using as fallback)"; \
    else \
        echo "âŒ No build script found in package.json!" && \
        cat apps/${APP}/package.json | grep -A 10 '"scripts"' && \
        exit 1; \
    fi && \
    echo "" && \
    echo "Selected build script: ${BUILD_SCRIPT}" && \
    echo "" && \
    PRE_SCRIPT="pre${BUILD_SCRIPT}" && \
    if grep -q "\"${PRE_SCRIPT}\"" apps/${APP}/package.json; then \
        echo "Running pre-build script: ${PRE_SCRIPT}" && \
        pnpm --filter ${APP} run ${PRE_SCRIPT} || echo "âš ï¸  Pre-build script failed, continuing..."; \
        echo ""; \
    fi && \
    echo "=========================================" && \
    echo "ğŸš€ Starting Build Process" && \
    echo "=========================================" && \
    echo "Command: pnpm --filter ${APP} ${BUILD_SCRIPT}" && \
    echo "" && \
    pnpm --filter ${APP} ${BUILD_SCRIPT} && \
    echo "" && \
    echo "=========================================" && \
    echo "âœ… Build Completed Successfully" && \
    echo "=========================================" && \
    echo "" && \
    if [ -d "apps/${APP}/.next" ]; then \
        echo "ğŸ“¦ Build Output (.next directory):" && \
        ls -lh apps/${APP}/.next/ | head -20 && \
        echo "" && \
        echo "Total .next size:" && \
        du -sh apps/${APP}/.next && \
        echo "" && \
        if [ -d "apps/${APP}/.next/standalone" ]; then \
            echo "âœ“ Standalone build detected" && \
            echo "Standalone size:" && \
            du -sh apps/${APP}/.next/standalone; \
        else \
            echo "âš ï¸  Standalone directory not found (might be using regular build mode)"; \
        fi; \
    else \
        echo "âŒ CRITICAL: .next directory not found!" && \
        echo "Available directories in apps/${APP}/:" && \
        ls -la apps/${APP}/ && \
        exit 1; \
    fi && \
    echo "=========================================" && \
    echo "" && \
    echo "ğŸ§¹ Cleanup: Removing build caches..." && \
    rm -rf /root/.npm /tmp/* /root/.cache && \
    pnpm store prune || true && \
    echo "âœ“ Cleanup completed" && \
    echo ""

# ============================================================================
# Runtime Stage - ìµœì¢… ì‹¤í–‰ ì´ë¯¸ì§€ (Standalone ëª¨ë“œìš©) â­ ê¶Œì¥
# ============================================================================
FROM ${BASE_IMAGE} AS runtime-standalone

ARG APP

# íƒ€ì„ì¡´ ë° í™˜ê²½ ì„¤ì •
ENV TZ=Asia/Seoul \
    NODE_ENV=development \
    PORT=3000 \
    HOSTNAME="0.0.0.0"

# ìµœì†Œ íŒ¨í‚¤ì§€ë§Œ ì„¤ì¹˜
RUN apk add --no-cache \
    tzdata \
    curl \
    ca-certificates && \
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && \
    echo $TZ > /etc/timezone && \
    rm -rf /root/.npm /tmp/*

WORKDIR /app

# â­ Next.js standalone ëª¨ë“œ ì¶œë ¥ë¬¼ë§Œ ë³µì‚¬ (ìš©ëŸ‰ ìµœì†Œí™”)
COPY --from=builder --chown=node:node /app/apps/${APP}/.next/standalone ./

# Static íŒŒì¼ê³¼ Public ë””ë ‰í† ë¦¬ ë³µì‚¬
COPY --from=builder --chown=node:node /app/apps/${APP}/.next/static ./apps/${APP}/.next/static
COPY --from=builder --chown=node:node /app/apps/${APP}/public ./apps/${APP}/public

# ë³´ì•ˆ: non-root ìœ ì €ë¡œ ì‹¤í–‰
USER node

# ëŸ°íƒ€ì„ ê²€ì¦
RUN echo "=========================================" && \
    echo "ğŸš€ Standalone Runtime (Development)" && \
    echo "=========================================" && \
    echo "App: ${APP}" && \
    echo "Node: $(node --version)" && \
    echo "User: $(whoami)" && \
    echo "Working Directory: $(pwd)" && \
    echo "" && \
    echo "Directory structure:" && \
    ls -la . && \
    echo "" && \
    echo "Checking server.js location:" && \
    if [ -f "apps/${APP}/server.js" ]; then \
        echo "  âœ“ Found at: apps/${APP}/server.js" && \
        ls -lh apps/${APP}/server.js; \
    elif [ -f "server.js" ]; then \
        echo "  âœ“ Found at: ./server.js" && \
        ls -lh server.js; \
    else \
        echo "  âœ— server.js not found!" && \
        echo "  Available files:" && \
        find . -name "server.js" -o -name "*.js" | head -10; \
    fi && \
    echo "========================================="

# í—¬ìŠ¤ì²´í¬ (K8s probeìš©)
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:${PORT}/api/health || \
      curl -f http://localhost:${PORT}/ || exit 1

EXPOSE ${PORT}

# â­ Standalone ëª¨ë“œ ì‹¤í–‰
# ARGë¥¼ CMDì—ì„œ ì§ì ‘ ì‚¬ìš©í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ENVë¡œ ì „ë‹¬
ENV APP_NAME=${APP}
CMD node apps/${APP_NAME}/server.js

# ============================================================================
# ë©”íƒ€ë°ì´í„°
# ============================================================================
LABEL app="${APP}" \
      maintainer="goyoai-devops@goyoai.com" \
      description="GoyoAI Frontend System - ${APP}" \
      version="1.0-dev" \
      environment="development" \
      node.version="${NODE_VERSION}" \
      build.type="standalone-development"