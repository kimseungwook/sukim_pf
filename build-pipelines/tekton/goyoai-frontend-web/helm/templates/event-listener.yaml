# goyo_dev/deploy/tekton/goyoai-frontend-web/helm/templates/event-listener.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: EventListener
metadata:
  name: {{ .Values.project_name }}
  namespace: tekton-pipelines
spec:
  serviceAccountName: {{ .Values.el_serviceAccountName }}
  resources:
    kubernetesResource:
      spec:
        template:
          spec:
            nodeSelector:
              {{ .Values.el_node_selector_key }}: {{ .Values.el_node_selector_value }}
            tolerations:
              - key: {{ .Values.el_tolerations_key }}
                operator: {{ .Values.el_tolerations_operator }}
                value: {{ .Values.el_tolerations_value }}
                effect: {{ .Values.el_tolerations_effect }}
            containers:
              - resources:
                  limits:
                    cpu: "500m"
                    memory: "128Mi"
                  requests:
                    cpu: "250m"
                    memory: "64Mi"
  triggers:
    # ═══════════════════════════════════════════════════
    # Trigger 1: aify-web (Dockerfile.unified 사용)
    # ═══════════════════════════════════════════════════
    - name: {{ .Values.project_name }}-aify-web
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: |
                body.ref in [{{ range $index, $revision := .Values.gitRevisions }}{{ if $index }},{{ end }}'refs/heads/{{ $revision }}'{{ end }}] &&
                !body.head_commit.message.contains('[skip-ci]') &&
                (body.head_commit.message.contains('[bd:all]') ||
                 body.head_commit.message.matches('.*\\[bd:[^\\]]*\\baify\\b[^\\]]*\\].*'))

            - name: "overlays"
              value:
                - key: sha
                  expression: "body.head_commit.id"
                - key: short_sha
                  expression: "body.head_commit.id.truncate(7)"
                - key: branch_name
                  expression: "body.ref.replace('refs/heads/', '')"
                - key: safe_branch_name
                  expression: "body.ref.replace('refs/heads/', '').replace('/', '-')"
                - key: module_name
                  expression: "'goyoai-aify-web'"
                - key: dockerfile_name
                  expression: "'Dockerfile.frontend.unified'"
                - key: commit_message
                  expression: "body.head_commit.message"
                - key: author_name
                  expression: "body.head_commit.author.name"
                - key: author_email
                  expression: "body.head_commit.author.email"
      bindings:
        - ref: {{ .Values.project_name }}
      template:
        ref: {{ .Values.project_name }}

    # ═══════════════════════════════════════════════════
    # Trigger 2: cosmos-web (Dockerfile.unified 사용)
    # ═══════════════════════════════════════════════════
    # - name: {{ .Values.project_name }}-cosmos-web
    #   interceptors:
    #     - ref:
    #         name: "github"
    #       params:
    #         - name: "eventTypes"
    #           value: ["push"]
    #     - ref:
    #         name: "cel"
    #       params:
    #         - name: "filter"
    #           value: |
    #             body.ref in [{{ range $index, $revision := .Values.gitRevisions }}{{ if $index }},{{ end }}'refs/heads/{{ $revision }}'{{ end }}] &&
    #             !body.head_commit.message.contains('[skip-ci]') &&
    #             (body.head_commit.message.contains('[bd:all]') ||
    #              body.head_commit.message.matches('.*\\[bd:[^\\]]*\\bcosmos\\b[^\\]]*\\].*'))

    #         - name: "overlays"
    #           value:
    #             - key: sha
    #               expression: "body.head_commit.id"
    #             - key: short_sha
    #               expression: "body.head_commit.id.truncate(7)"
    #             - key: branch_name
    #               expression: "body.ref.replace('refs/heads/', '')"
    #             - key: safe_branch_name
    #               expression: "body.ref.replace('refs/heads/', '').replace('/', '-')"
    #             - key: module_name
    #               expression: "'goyoai-cosmos-web'"
    #             - key: dockerfile_name
    #               expression: "'Dockerfile.frontend.unified'"
    #             - key: commit_message
    #               expression: "body.head_commit.message"
    #             - key: author_name
    #               expression: "body.head_commit.author.name"
    #             - key: author_email
    #               expression: "body.head_commit.author.email"
    #   bindings:
    #     - ref: {{ .Values.project_name }}
    #   template:
    #     ref: {{ .Values.project_name }}

    # ═══════════════════════════════════════════════════
    # Trigger 3: stock-web (Dockerfile.unified 사용)
    # ═══════════════════════════════════════════════════
    # - name: {{ .Values.project_name }}-stock-web
    #   interceptors:
    #     - ref:
    #         name: "github"
    #       params:
    #         - name: "eventTypes"
    #           value: ["push"]
    #     - ref:
    #         name: "cel"
    #       params:
    #         - name: "filter"
    #           value: |
    #             body.ref in [{{ range $index, $revision := .Values.gitRevisions }}{{ if $index }},{{ end }}'refs/heads/{{ $revision }}'{{ end }}] &&
    #             !body.head_commit.message.contains('[skip-ci]') &&
    #             (body.head_commit.message.contains('[bd:all]') ||
    #              body.head_commit.message.matches('.*\\[bd:[^\\]]*\\bstock\\b[^\\]]*\\].*'))
    #         - name: "overlays"
    #           value:
    #             - key: sha
    #               expression: "body.head_commit.id"
    #             - key: short_sha
    #               expression: "body.head_commit.id.truncate(7)"
    #             - key: branch_name
    #               expression: "body.ref.replace('refs/heads/', '')"
    #             - key: safe_branch_name
    #               expression: "body.ref.replace('refs/heads/', '').replace('/', '-')"
    #             - key: module_name
    #               expression: "'goyoai-stock-web'"
    #             - key: dockerfile_name
    #               expression: "'Dockerfile.frontend.unified'"
    #             - key: commit_message
    #               expression: "body.head_commit.message"
    #             - key: author_name
    #               expression: "body.head_commit.author.name"
    #             - key: author_email
    #               expression: "body.head_commit.author.email"
    #   bindings:
    #     - ref: {{ .Values.project_name }}
    #   template:
    #     ref: {{ .Values.project_name }}

    # ═══════════════════════════════════════════════════
    # Trigger 4: backoffice (Dockerfile.unified 사용)
    # ═══════════════════════════════════════════════════
    - name: {{ .Values.project_name }}-backoffice
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: |
                body.ref in [{{ range $index, $revision := .Values.gitRevisions }}{{ if $index }},{{ end }}'refs/heads/{{ $revision }}'{{ end }}] &&
                !body.head_commit.message.contains('[skip-ci]') &&
                (body.head_commit.message.contains('[bd:all]') ||
                 body.head_commit.message.matches('.*\\[bd:[^\\]]*\\bbo\\b[^\\]]*\\].*'))

            - name: "overlays"
              value:
                - key: sha
                  expression: "body.head_commit.id"
                - key: short_sha
                  expression: "body.head_commit.id.truncate(7)"
                - key: branch_name
                  expression: "body.ref.replace('refs/heads/', '')"
                - key: safe_branch_name
                  expression: "body.ref.replace('refs/heads/', '').replace('/', '-')"
                - key: module_name
                  expression: "'goyoai-gointern-bo-web'"
                - key: dockerfile_name
                  expression: "'Dockerfile.frontend.unified'"
                - key: commit_message
                  expression: "body.head_commit.message"
                - key: author_name
                  expression: "body.head_commit.author.name"
                - key: author_email
                  expression: "body.head_commit.author.email"
      bindings:
        - ref: {{ .Values.project_name }}
      template:
        ref: {{ .Values.project_name }}

    # ═══════════════════════════════════════════════════
    # Trigger 5: gointern-web (Dockerfile.unified 사용)
    # ═══════════════════════════════════════════════════
    - name: {{ .Values.project_name }}-gointern-web
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: |
                body.ref in [{{ range $index, $revision := .Values.gitRevisions }}{{ if $index }},{{ end }}'refs/heads/{{ $revision }}'{{ end }}] &&
                !body.head_commit.message.contains('[skip-ci]') &&
                (body.head_commit.message.contains('[bd:all]') ||
                 body.head_commit.message.matches('.*\\[bd:[^\\]]*\\bgo\\b[^\\]]*\\].*'))
            - name: "overlays"
              value:
                - key: sha
                  expression: "body.head_commit.id"
                - key: short_sha
                  expression: "body.head_commit.id.truncate(7)"
                - key: branch_name
                  expression: "body.ref.replace('refs/heads/', '')"
                - key: safe_branch_name
                  expression: "body.ref.replace('refs/heads/', '').replace('/', '-')"
                - key: module_name
                  expression: "'goyoai-gointern-web'"
                - key: dockerfile_name
                  expression: "'Dockerfile.frontend.unified'"
                - key: commit_message
                  expression: "body.head_commit.message"
                - key: author_name
                  expression: "body.head_commit.author.name"
                - key: author_email
                  expression: "body.head_commit.author.email"
      bindings:
        - ref: {{ .Values.project_name }}
      template:
        ref: {{ .Values.project_name }}

    # ═══════════════════════════════════════════════════
    # Trigger 6: aify-studio (Dockerfile.unified 사용)
    # ═══════════════════════════════════════════════════
    # - name: {{ .Values.project_name }}-aify-studio
    #   interceptors:
    #     - ref:
    #         name: "github"
    #       params:
    #         - name: "eventTypes"
    #           value: ["push"]
    #     - ref:
    #         name: "cel"
    #       params:
    #         - name: "filter"
    #           value: |
    #             body.ref in [{{ range $index, $revision := .Values.gitRevisions }}{{ if $index }},{{ end }}'refs/heads/{{ $revision }}'{{ end }}] &&
    #             !body.head_commit.message.contains('[skip-ci]') &&
    #             body.head_commit.message.matches('.*\\[bd:[^\\]]*\\b(st|studio)\\b[^\\]]*\\].*')
    #         - name: "overlays"
    #           value:
    #             - key: sha
    #               expression: "body.head_commit.id"
    #             - key: short_sha
    #               expression: "body.head_commit.id.truncate(7)"
    #             - key: branch_name
    #               expression: "body.ref.replace('refs/heads/', '')"
    #             - key: safe_branch_name
    #               expression: "body.ref.replace('refs/heads/', '').replace('/', '-')"
    #             - key: module_name
    #               expression: "'uclick-aify-studio-web'"
    #             - key: dockerfile_name
    #               expression: "'Dockerfile.frontend.unified'"
    #             - key: commit_message
    #               expression: "body.head_commit.message"
    #             - key: author_name
    #               expression: "body.head_commit.author.name"
    #             - key: author_email
    #               expression: "body.head_commit.author.email"
    #   bindings:
    #     - ref: {{ .Values.project_name }}
    #   template:
    #     ref: {{ .Values.project_name }}

    # ═══════════════════════════════════════════════════
    # Trigger 7: gointern-web-i18n (Dockerfile.unified 사용)
    # ═══════════════════════════════════════════════════
    # - name: {{ .Values.project_name }}-gointern-web-i18n
    #   interceptors:
    #     - ref:
    #         name: "github"
    #       params:
    #         - name: "eventTypes"
    #           value: ["push"]
    #     - ref:
    #         name: "cel"
    #       params:
    #         - name: "filter"
    #           value: |
    #             body.ref in [{{ range $index, $revision := .Values.gitRevisions }}{{ if $index }},{{ end }}'refs/heads/{{ $revision }}'{{ end }}] &&
    #             !body.head_commit.message.contains('[skip-ci]') &&
    #             body.head_commit.message.contains('[bd:i18]')
    #         - name: "overlays"
    #           value:
    #             - key: sha
    #               expression: "body.head_commit.id"
    #             - key: short_sha
    #               expression: "body.head_commit.id.truncate(7)"
    #             - key: branch_name
    #               expression: "body.ref.replace('refs/heads/', '')"
    #             - key: safe_branch_name
    #               expression: "body.ref.replace('refs/heads/', '').replace('/', '-')"
    #             - key: module_name
    #               expression: "'goyoai-gointern-web'"
    #             - key: dockerfile_name
    #               expression: "'Dockerfile.frontend.unified'"
    #             - key: commit_message
    #               expression: "body.head_commit.message"
    #             - key: author_name
    #               expression: "body.head_commit.author.name"
    #             - key: author_email
    #               expression: "body.head_commit.author.email"
    #   bindings:
    #     - ref: {{ .Values.project_name }}
    #   template:
    #     ref: {{ .Values.project_name }}