apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: {{ required "A value for .Values.system_build_task_name is required!" .Values.system_build_task_name }}-trigger
  namespace: tekton-pipelines
spec:
  description: >-
    This Task triggers a Kaniko Job on Build Node and waits for completion.
    Optimized for Go backend builds.
  params:
    - name: container-registry-url
      type: string
    - name: container-registry-cache-url
      type: string
    - name: timestamp
      type: string
    - name: project-name
      type: string
      default: {{ .Values.project_name }}
    - name: git-short-sha
      type: string
    - name: module-name
      type: string
      description: "The module to build"
    - name: dockerfile-name
      type: string
    - name: giturl
      type: string
    - name: revision
      type: string
    # Go ë¹Œë“œìš© íŒŒë¼ë¯¸í„° (Gradle ê´€ë ¨ íŒŒë¼ë¯¸í„°ëŠ” ì œê±°)
    - name: go-context-dir
      type: string
      default: "{{ .Values.go_context_dir }}"
      description: "Go í”„ë¡œì íŠ¸ì˜ context ë””ë ‰í† ë¦¬ (go.modê°€ ìˆëŠ” ìœ„ì¹˜)"
  
  workspaces:
    - name: {{ .Values.project_name }}
      description: Not used, but kept for compatibility
  
  results:
    - name: image-url
      description: The built image URL
  
  steps:
    - name: create-kaniko-job
      image: "harbor.8ai.store/common/kubectl:1.34.2"
      script: |
        #!/bin/sh
        set -e
        
        JOB_NAME="kaniko-build-$(params.module-name)-$(params.timestamp)"
        MODULE_NAME="$(params.module-name)"
        GO_CONTEXT_DIR="$(params.go-context-dir)"
        
        echo "==========================================="
        echo "ğŸ¹ Go Backend Build Configuration"
        echo "==========================================="
        echo "Module: ${MODULE_NAME}"
        echo "Context: ${GO_CONTEXT_DIR}"
        echo "==========================================="
        echo ""

        cat <<EOF | kubectl apply --validate=false -f -
        apiVersion: batch/v1
        kind: Job
        metadata:
          name: ${JOB_NAME}
          namespace: tekton-pipelines
          labels:
            tekton-trigger: "true"
            job-name: ${JOB_NAME}
            module: $(params.module-name)
            build-type: go
        spec:
          ttlSecondsAfterFinished: 3600
          backoffLimit: 0
          template:
            metadata:
              labels:
                app: kaniko-build
                job-name: ${JOB_NAME}
                module: $(params.module-name)
            spec:
              nodeSelector:
                workload-type: build
              tolerations:
              - key: workload
                operator: Equal
                value: sukim-build
                effect: NoSchedule
              restartPolicy: Never
              serviceAccountName: tekton-ci-token
              containers:
              - name: kaniko-build
                image: harbor.8ai.store/common/kaniko-git:v1.23.2
                command:
                - /busybox/sh
                - -c
                - |
                  #!/bin/sh
                  set -e
                  
                  echo "=== Starting Go Backend Build Process ==="
                  echo ""

                  echo "=== Git Credentials ==="
                  if [ -f /secrets/git-token/username ] && [ -f /secrets/git-token/password ]; then
                    GIT_USERNAME=\$(cat /secrets/git-token/username)
                    GIT_PASSWORD=\$(cat /secrets/git-token/password)
                    git config --global credential.helper store
                    mkdir -p /root
                    echo "https://\${GIT_USERNAME}:\${GIT_PASSWORD}@github.com" > /root/.git-credentials
                    chmod 600 /root/.git-credentials
                    echo "âœ“ Git credentials configured"
                  fi
                  echo ""
                  
                  echo "=== Git Clone ==="
                  git config --global user.name "Tekton CI"
                  git config --global user.email "ci@sukim-pf.com"
                  git config --global --add safe.directory /workspace
                  
                  if git clone -b $(params.revision) $(params.giturl) /workspace; then
                    cd /workspace
                    echo "âœ“ Clone successful (commit: \$(git rev-parse --short HEAD))"
                  else
                    echo "âœ— Clone failed"
                    exit 1
                  fi
                  echo ""
                  
                  # ========================================
                  # ğŸ” DEBUG: ìƒì„¸ ë””ë²„ê¹… ì •ë³´
                  # ========================================
                  echo "=========================================="
                  echo "ğŸ” DEBUG: Detailed Debugging Information"
                  echo "=========================================="
                  echo ""
                  
                  echo "ğŸ“ DEBUG: Full workspace structure (max depth 4):"
                  find /workspace -maxdepth 4 -type f -name "*.mod" -o -name "Dockerfile*" -o -name "go.sum" 2>/dev/null | sort
                  echo ""
                  
                  echo "ğŸ“ DEBUG: All directories in workspace:"
                  find /workspace -maxdepth 3 -type d 2>/dev/null | sort
                  echo ""
                  
                  echo "ğŸ“ DEBUG: Environment variables:"
                  echo "  GO_CONTEXT_DIR (from param): ${GO_CONTEXT_DIR}"
                  echo "  CONTEXT_DIR (computed): \${CONTEXT_DIR}"
                  echo "  DOCKERFILE_PATH (computed): \${DOCKERFILE_PATH}"
                  echo ""
                  
                  # Go í”„ë¡œì íŠ¸ context ë””ë ‰í† ë¦¬ ì„¤ì •
                  CONTEXT_DIR="/workspace/${GO_CONTEXT_DIR}"
                  DOCKERFILE_PATH="/workspace/$(params.dockerfile-name)"
                  
                  echo "=== Go Project Structure ==="
                  echo "Context Directory: \${CONTEXT_DIR}"
                  echo "Dockerfile Path: \${DOCKERFILE_PATH}"
                  echo ""
                  
                  # Context ë””ë ‰í† ë¦¬ í™•ì¸
                  if [ -d "\${CONTEXT_DIR}" ]; then
                    echo "âœ“ Context directory exists"
                    echo "Contents of context directory:"
                    ls -la "\${CONTEXT_DIR}/"
                  else
                    echo "âœ— Context directory NOT found: \${CONTEXT_DIR}"
                    echo ""
                    echo "ğŸ“ DEBUG: Searching for possible context directories..."
                    echo "Looking for directories containing go.mod:"
                    find /workspace -name "go.mod" -type f 2>/dev/null | while read gomod; do
                      echo "  Found: \$(dirname \$gomod)"
                    done
                    echo ""
                    echo "All directories in workspace (depth 3):"
                    find /workspace -maxdepth 3 -type d 2>/dev/null | head -30
                    exit 1
                  fi
                  echo ""
                  
                  # go.mod í™•ì¸
                  if [ -f "\${CONTEXT_DIR}/go.mod" ]; then
                    echo "âœ“ go.mod found in context directory"
                    echo "First 10 lines of go.mod:"
                    head -10 "\${CONTEXT_DIR}/go.mod"
                  else
                    echo "âœ— go.mod NOT found in \${CONTEXT_DIR}"
                    echo ""
                    echo "ğŸ“ DEBUG: Searching for go.mod in entire workspace..."
                    find /workspace -name "go.mod" -type f 2>/dev/null | while read gomod; do
                      echo "  Found: \$gomod"
                      echo "  Directory: \$(dirname \$gomod)"
                    done
                    exit 1
                  fi
                  echo ""
                  
                  # Dockerfile í™•ì¸
                  echo "=== Dockerfile Check ==="
                  if [ -f "\${DOCKERFILE_PATH}" ]; then
                    echo "âœ“ Dockerfile found at: \${DOCKERFILE_PATH}"
                    echo "First 15 lines:"
                    head -15 "\${DOCKERFILE_PATH}"
                  else
                    echo "âœ— Dockerfile NOT found at: \${DOCKERFILE_PATH}"
                    echo ""
                    echo "ğŸ“ DEBUG: Searching for Dockerfiles in workspace..."
                    find /workspace -iname "*dockerfile*" -type f 2>/dev/null | while read df; do
                      echo "  Found: \$df"
                    done
                    exit 1
                  fi
                  echo ""
                  
                  echo "=== Kaniko Build Configuration ==="
                  IMAGE_TAG="$(params.container-registry-url):$(params.git-short-sha)-$(params.timestamp)"
                  
                  # Dockerfileì´ context ë””ë ‰í† ë¦¬ ì•ˆì— ìˆëŠ”ì§€ í™•ì¸
                  # Dockerfile.backendê°€ context ë””ë ‰í† ë¦¬ ì•ˆì— ìˆìœ¼ë©´ ìƒëŒ€ ê²½ë¡œ ì‚¬ìš©
                  DOCKERFILE_BASENAME=\$(basename "\${DOCKERFILE_PATH}")
                  
                  if [ -f "\${CONTEXT_DIR}/\${DOCKERFILE_BASENAME}" ]; then
                    echo "âœ“ Dockerfile is inside context directory"
                    DOCKERFILE_ARG="./\${DOCKERFILE_BASENAME}"
                  else
                    # Dockerfileì´ context ì™¸ë¶€ì— ìˆëŠ” ê²½ìš°
                    echo "âš  Dockerfile is outside context directory"
                    echo "  Will use absolute path for Dockerfile"
                    DOCKERFILE_ARG="\${DOCKERFILE_PATH}"
                  fi
                  
                  echo "========================================"
                  echo "ğŸ”¨ Building Go Backend Image"
                  echo "========================================"
                  echo "Image Tag: \${IMAGE_TAG}"
                  echo "Context: \${CONTEXT_DIR}"
                  echo "Dockerfile Arg: \${DOCKERFILE_ARG}"
                  echo "Dockerfile Full Path: \${DOCKERFILE_PATH}"
                  echo "========================================"
                  echo ""
                  
                  /kaniko/executor \
                    --context=\${CONTEXT_DIR} \
                    --dockerfile=\${DOCKERFILE_ARG} \
                    --destination=\${IMAGE_TAG} \
                    --force \
                    --skip-tls-verify \
                    --skip-push-permission-check \
                    --skip-unused-stages \
                    --use-new-run \
                    \
                    --ignore-path=/var/spool/mail \
                    --ignore-path=/var/mail \
                    --ignore-path=/var/spool \
                    --ignore-path=/tmp \
                    \
                    --cache=true \
                    --cache-repo=$(params.container-registry-cache-url)/go-backend \
                    --cache-copy-layers=true \
                    --cache-run-layers=true \
                    \
                    --snapshot-mode=time \
                    --ignore-var-run \
                    --cleanup \
                    --cache-dir=/cache \
                    --verbosity=info
                  
                  BUILD_EXIT=\$?
                  
                  if [ \${BUILD_EXIT} -ne 0 ]; then
                    echo ""
                    echo "âœ— Build failed with exit code \${BUILD_EXIT}"
                    exit 1
                  fi
                  
                  echo ""
                  echo "âœ“ Go Backend Build complete!"

                env:
                # Docker ì¸ì¦ ì„¤ì •
                - name: DOCKER_CONFIG
                  value: "/kaniko/.docker"
                
                volumeMounts:
                - name: workspace
                  mountPath: /workspace
                - name: kaniko-cache
                  mountPath: /cache
                - name: git-credentials
                  mountPath: /secrets/git-token
                  readOnly: true
                - name: harbor-config
                  mountPath: /kaniko/.docker
                  readOnly: true
                
                resources:
                  requests:
                    memory: "4Gi"
                    cpu: "2000m"
                  limits:
                    memory: "8Gi"
                    cpu: "4000m"
                    
              volumes:
              - name: workspace
                emptyDir: {}
              - name: kaniko-cache
                emptyDir: {}
              - name: git-credentials
                secret:
                  secretName: git-token
              - name: harbor-config
                secret:
                  secretName: kaniko-secret
                  items:
                  - key: config.json
                    path: config.json
                    mode: 0644                              
        EOF
        
        echo "Job ${JOB_NAME} created successfully"
        echo "${JOB_NAME}" > /tmp/job-name
      volumeMounts:
        - name: job-info
          mountPath: /tmp
    
    - name: wait-for-job
      image: "harbor.8ai.store/common/kubectl:1.34.2"
      script: |
        #!/bin/sh
        set -e
        
        JOB_NAME=$(cat /tmp/job-name)
        echo "=========================================="
        echo "ğŸ“¦ Waiting for Go Backend Build Job"
        echo "=========================================="
        echo "Job Name: ${JOB_NAME}"
        echo "Timeout: 600 seconds (10 minutes)"
        echo "=========================================="
        echo ""
        
        echo "â³ Waiting for Pod to be created..."
        POD_NAME=""
        for i in $(seq 1 60); do
          POD_NAME=$(kubectl get pods -n tekton-pipelines -l job-name=${JOB_NAME} -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          if [ -n "$POD_NAME" ]; then
            echo "âœ“ Pod created: ${POD_NAME}"
            break
          fi
          sleep 1
        done
        
        if [ -z "$POD_NAME" ]; then
          echo "âœ— Pod creation timeout"
          exit 1
        fi
        
        echo ""
        echo "â³ Waiting for Pod to start running..."
        for i in $(seq 1 120); do
          POD_STATUS=$(kubectl get pod ${POD_NAME} -n tekton-pipelines -o jsonpath='{.status.phase}' 2>/dev/null || echo "")
          if [ "$POD_STATUS" = "Running" ] || [ "$POD_STATUS" = "Succeeded" ]; then
            echo "âœ“ Pod is ${POD_STATUS}"
            break
          fi
          if [ $((i % 10)) -eq 0 ]; then
            echo "  Pod status: ${POD_STATUS} (${i}s)"
          fi
          sleep 1
        done
        
        echo ""
        echo "=========================================="
        echo "ğŸ“‹ Streaming Go Backend Build Logs"
        echo "=========================================="
        echo ""
        
        kubectl logs -f ${POD_NAME} -n tekton-pipelines -c kaniko-build 2>/dev/null &
        LOG_PID=$!
        
        # Go ë¹Œë“œëŠ” Spring Bootë³´ë‹¤ ë¹ ë¥´ë¯€ë¡œ íƒ€ì„ì•„ì›ƒì„ 10ë¶„ìœ¼ë¡œ ì„¤ì •
        TIMEOUT=600
        ELAPSED=0
        INTERVAL=5
        
        while [ $ELAPSED -lt $TIMEOUT ]; do
          STATUS=$(kubectl get job ${JOB_NAME} -n tekton-pipelines -o jsonpath='{.status.conditions[?(@.type=="Complete")].status}' 2>/dev/null || echo "")
          FAILED=$(kubectl get job ${JOB_NAME} -n tekton-pipelines -o jsonpath='{.status.conditions[?(@.type=="Failed")].status}' 2>/dev/null || echo "")
          
          if [ "$STATUS" = "True" ]; then
            sleep 2
            kill $LOG_PID 2>/dev/null || true
            echo ""
            echo "=========================================="
            echo "âœ… Go Backend Build Completed Successfully!"
            echo "=========================================="
            echo "Image: $(params.container-registry-url):$(params.git-short-sha)-$(params.timestamp)"
            echo "=========================================="
            echo "$(params.container-registry-url):$(params.git-short-sha)-$(params.timestamp)" > $(results.image-url.path)
            exit 0
          fi
          
          if [ "$FAILED" = "True" ]; then
            kill $LOG_PID 2>/dev/null || true
            echo ""
            echo "=========================================="
            echo "âŒ Go Backend Build Failed"
            echo "=========================================="
            echo ""
            echo "=== Last 500 lines of logs ==="
            kubectl logs ${POD_NAME} -n tekton-pipelines -c kaniko-build --tail=500 2>/dev/null || true
            echo ""
            echo "=== Pod Status ==="
            kubectl describe pod ${POD_NAME} -n tekton-pipelines | tail -30
            exit 1
          fi
          
          sleep $INTERVAL
          ELAPSED=$((ELAPSED + INTERVAL))
        done
        
        kill $LOG_PID 2>/dev/null || true
        echo ""
        echo "=========================================="
        echo "â±ï¸  Build Timeout (10 minutes)"
        echo "=========================================="
        exit 1
      volumeMounts:
        - name: job-info
          mountPath: /tmp
  
  volumes:
    - name: job-info
      emptyDir: {}