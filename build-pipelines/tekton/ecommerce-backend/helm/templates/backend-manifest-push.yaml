# templates/backend-manifest-push.yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: {{ .Values.project_name }}-manifest
  namespace: tekton-pipelines
spec:
  params:
    - name: container-registry-url
      type: string
    - name: commit-message
      type: string
    - name: kustomize-giturl
      type: string
      default: {{ .Values.kustomize_git_url }}
    - name: project-name
      type: string
      default: {{ .Values.project_name }}
    - name: timestamp
      type: string
    - name: git-short-sha
      type: string
    - name: module-name
      type: string
      description: "The module name to build (e.g., ecommerce-backend)"
    - name: back-kustomize-branch
      type: string
      default: "{{ .Values.back_kustomize_git_branch }}"
    - name: author-name
      type: string
      description: "Git commit author name from webhook"
  workspaces:
    - name: {{ .Values.project_name }}
  steps:
    - name: clean-and-setup-workspace
      image: {{ .Values.common_alpine_git_url }}
      script: |
        #!/bin/sh
        set -e
        
        WORKSPACE_PATH=$(workspaces.{{ .Values.project_name }}.path)
        PROJECT_DIR=$WORKSPACE_PATH/$(params.project-name)-manifest
        MODULE_NAME="$(params.module-name)"
        
        # Workspace ì •ë¦¬
        rm -rf $PROJECT_DIR
        mkdir -p $PROJECT_DIR
        echo "Workspace cleaned and prepared at $PROJECT_DIR"

        # Git ì„¤ì • ë° í´ë¡ 
        KUSTOMIZE_BRANCH="$(params.back-kustomize-branch)"
        git config --global user.name "ecommerce-tekton-ci"
        git config --global user.email "ci@ecommerce.com"
        echo "Cloning manifest repository branch: $KUSTOMIZE_BRANCH"
        git clone --branch $KUSTOMIZE_BRANCH $(params.kustomize-giturl) $PROJECT_DIR
        
        cd $PROJECT_DIR

        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # ë™ì ìœ¼ë¡œ Kustomize ê²½ë¡œ ë° Deployment ì´ë¦„ ì„¤ì •
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        KUSTOMIZE_DIR="ecommerce-gitops/k8s-configs/overlays/dev/${MODULE_NAME}"
        DEPLOYMENT_NAME="${MODULE_NAME}"
        OVERLAY_PATH="$PROJECT_DIR/$KUSTOMIZE_DIR"
        
        echo "Module: ${MODULE_NAME}"
        echo "Kustomize directory: ${KUSTOMIZE_DIR}"
        echo "Deployment name: ${DEPLOYMENT_NAME}"
        
        # ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ìœ¼ë©´)
        mkdir -p $OVERLAY_PATH
        
        echo "Creating deployment patch at $OVERLAY_PATH/deployment_patches.yaml"
        cat <<EOF > $OVERLAY_PATH/deployment_patches.yaml
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: ${DEPLOYMENT_NAME}
        spec:
          template:
            spec:
              serviceAccountName: ecommerce-vault-sa
              containers:
                - name: ${DEPLOYMENT_NAME}-container
                  image: $(params.container-registry-url)/${MODULE_NAME}:$(params.git-short-sha)-$(params.timestamp)
        EOF
        
        echo ""
        echo "Generated deployment_patches.yaml:"
        cat $OVERLAY_PATH/deployment_patches.yaml
        echo ""
        
        # Git ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        git add .
        # ë³€ê²½ ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹ ì‹œë„
        if ! git diff --staged --quiet; then
          COMMIT_MESSAGE="$(params.commit-message) with new image tag $(params.git-short-sha)-$(params.timestamp)"
          git commit -m "$COMMIT_MESSAGE"
          git push origin $KUSTOMIZE_BRANCH
          echo "âœ… Manifest updated and pushed successfully."
        else
          echo "No changes to commit."
        fi

    - name: notify-slack
      image: {{ .Values.common_alpine_url }}
      script: |
        #!/bin/sh
        apk add --no-cache curl tzdata
        
        SLACK_WEBHOOK_URL="{{ .Values.slack_webhook_url }}"
        MODULE_NAME="$(params.module-name)"
        IMAGE_TAG="$(params.git-short-sha)-$(params.timestamp)"
        COMMIT_SHA="$(params.git-short-sha)"
        AUTHOR_NAME="$(params.author-name)"
        
        # í˜„ì¬ ì‹œê°„ (KST)
        CURRENT_TIME=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S')
        
        # ğŸ¨ ìƒì„¸í•œ Slack Block Kit ë©”ì‹œì§€
        SLACK_MESSAGE=$(cat <<EOF
        {
          "blocks": [
            {
              "type": "header",
              "text": {
                "type": "plain_text",
                "text": "âœ… CI/CD Pipeline Completed",
                "emoji": true
              }
            },
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*Module:*\n\`${MODULE_NAME}\`"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Status:*\n:white_check_mark: Success"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Image Tag:*\n\`${IMAGE_TAG}\`"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Commit:*\n\`${COMMIT_SHA}\`"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Committer:*\n${AUTHOR_NAME}"
                }
              ]
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "*Registry:* \`harbor.8ai.store/ecommerce-backend\`\n*Deployment:* Ready for ArgoCD sync"
              }
            },
            {
              "type": "context",
              "elements": [
                {
                  "type": "mrkdwn",
                  "text": "â° ${CURRENT_TIME} KST | ğŸ“¦ Manifest pushed to ArgoCD"
                }
              ]
            },
            {
              "type": "divider"
            }
          ]
        }
        EOF
        )
        
        # Slack ì•Œë¦¼ ì „ì†¡ (ì‹¤íŒ¨í•´ë„ ë¹Œë“œëŠ” ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬)
        if curl -X POST -H 'Content-type: application/json' \
          --data "$SLACK_MESSAGE" \
          $SLACK_WEBHOOK_URL; then
          echo "âœ… Slack notification sent successfully"
        else
          echo "âš ï¸  Slack notification failed (non-critical)"
        fi