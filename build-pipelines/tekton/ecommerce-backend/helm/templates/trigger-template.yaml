# templates/trigger-template.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: {{ .Values.project_name }}
  namespace: tekton-pipelines
spec:
  params:
    - name: gitrevision
    - name: gitrepositoryurl
    - name: git-sha
    - name: git-short-sha
    - name: git-repo-name
    - name: module-name
    - name: dockerfile-name
    - name: commit-message
    - name: author-name
    - name: author-email
    - name: gradle-workers
      default: "12"
    - name: gradle-memory
      default: "10g"

  resourcetemplates:
    - apiVersion: tekton.dev/v1beta1
      kind: PipelineRun
      metadata:
        generateName: "$(tt.params.module-name)-run-"
        namespace: tekton-pipelines
        labels:
          # 기본 라벨
          app: goyoai-gointern-system
          tekton.dev/pipeline: goyoai-gointern-system
          # Git 정보
          git.branch: "$(tt.params.gitrevision)"
          git.commit: "$(tt.params.git-short-sha)"
          # 모듈 정보
          module: "$(tt.params.module-name)"
          # 빌드 트리거 정보
          triggered-by: ci-webhook
        annotations:
          # Git 상세 정보
          git.commit.sha: "$(tt.params.git-sha)"
          git.commit.short-sha: "$(tt.params.git-short-sha)"
          git.branch: "$(tt.params.gitrevision)"
          git.repository: "$(tt.params.gitrepositoryurl)"
          # 커밋 정보
          commit.message: "$(tt.params.commit-message)"
          commit.author.name: "$(tt.params.author-name)"
          commit.author.email: "$(tt.params.author-email)"
          # 빌드 정보
          build.module: "$(tt.params.module-name)"
          build.dockerfile: "$(tt.params.dockerfile-name)"
      spec:
        pipelineRef:
          name: {{ .Values.project_name }}
        params:
          - name: giturl
            value: "$(tt.params.gitrepositoryurl)"
          - name: container-registry-url
            value: "{{ .Values.container_registry_url }}"
          - name: container-registry-cache-url
            value: "{{ .Values.container_registry_cache_url }}"
          - name: manifest-file-name
            value: "{{ .Values.manifestFileName }}"
          # - name: commit-message
            # value: "Update $(tt.params.git-repo-name):$(tt.params.gitrevision) git hash: $(tt.params.git-short-sha)"
          - name: project-name
            value: "$(tt.params.git-repo-name)"
          - name: revision
            value: "$(tt.params.gitrevision)"
          - name: git-short-sha
            value: "$(tt.params.git-short-sha)"
          - name: module-name
            value: "$(tt.params.module-name)"
          - name: dockerfile-name
            value: "$(tt.params.dockerfile-name)"
          - name: gradle-workers
            value: "$(tt.params.gradle-workers)"
          - name: gradle-memory
            value: "$(tt.params.gradle-memory)"
          - name: author-name
            value: "$(tt.params.author-name)"
          - name: commit-message
            value: "$(tt.params.commit-message)"
        workspaces:
          - name: {{ .Values.project_name }}
            emptyDir: {}
        serviceAccountName: tekton-ci-token

        podTemplate:
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: workload-type
                        operator: DoesNotExist
                      - key: {{ .Values.trigger_node_selector_key }}
                        operator: In
                        values:
                          - {{ .Values.trigger_node_selector_value }}
          tolerations:
            - key: {{ .Values.trigger_tolerations_key }}
              operator: {{ .Values.trigger_tolerations_operator }}
              value: {{ .Values.trigger_tolerations_value }}
              effect: {{ .Values.trigger_tolerations_effect }}
