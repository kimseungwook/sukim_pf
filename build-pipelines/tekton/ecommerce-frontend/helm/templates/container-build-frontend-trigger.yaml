# ecommerce-frontend container-build-trigger
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  # â—ï¸ 1. values.yamlì˜ 'frontend_build_task_name' ê°’ì„ ì‚¬ìš©
  name: {{ .Values.frontend_build_task_name }}-trigger
  namespace: tekton-pipelines
spec:
  description: >-
    This Task triggers a Kaniko Job on Virtual Node for Frontend builds.
  params:
    # (íŒŒë¼ë¯¸í„°ëŠ” ë°±ì—”ë“œì™€ ë™ì¼í•˜ê²Œ ìœ ì§€)
    - name: container-registry-url
      type: string
    - name: container-registry-cache-url
      type: string
    - name: timestamp
      type: string
    - name: project-name
      type: string
      default: {{ .Values.project_name }}
    - name: git-short-sha
      type: string
    - name: module-name
      type: string
      description: "The module to build (e.g., goyoai-aify-web)"
    - name: dockerfile-name
      type: string
      description: "The Dockerfile to use (e.g., Dockerfile.frontend.unified)"
    - name: giturl
      type: string
    - name: revision
      type: string
  
  workspaces:
    - name: {{ .Values.project_name }}
      description: Not used, but kept for compatibility
  
  results:
    - name: image-url
      description: The built image URL
  
  steps:
    - name: create-kaniko-job
      image: {{ .Values.common_alpine_url }}
      script: |
        #!/bin/sh
        set -e
        apk add --no-cache curl
        
        echo "Detecting architecture..."
        ARCH=$(uname -m)
        if [ "$ARCH" = "aarch64" ]; then
          K8S_ARCH="arm64"
        elif [ "$ARCH" = "x86_64" ]; then
          K8S_ARCH="amd64"
        else
          echo "Unsupported architecture: $ARCH"
          exit 1
        fi
        echo "Architecture detected: $ARCH (using ${K8S_ARCH} for kubectl)"

        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/${K8S_ARCH}/kubectl"
        chmod +x kubectl
        mv kubectl /usr/local/bin/

        JOB_NAME="kaniko-build-$(params.module-name)-$(params.timestamp)"

        
        echo ""

        cat <<EOF | kubectl apply --validate=false -f -
        apiVersion: batch/v1
        kind: Job
        metadata:
          name: ${JOB_NAME}
          namespace: tekton-pipelines
          labels:
            tekton-trigger: "true"
            job-name: ${JOB_NAME}
            module: $(params.module-name)
        spec:
          ttlSecondsAfterFinished: 3600
          backoffLimit: 0
          template:
            metadata:
              labels:
                app: kaniko-build
                job-name: ${JOB_NAME}
                module: $(params.module-name)
            spec:
              nodeSelector:
                workload-type: build
              tolerations:
              - key: workload
                operator: Equal
                value: sukim-build
                effect: NoSchedule
              restartPolicy: Never
              serviceAccountName: tekton-ci-token
              containers:
              - name: kaniko-build
                image: harbor.8ai.store/common/kaniko-git:v1.23.2
                command:
                - /busybox/sh
                - -c
                - |
                  #!/bin/sh
                  set -e
                  
                  echo "=== Starting Frontend Build Process ==="
                  
                  # ==========================================
                  # ğŸ”¥ NEW: Secretì—ì„œ .env íŒŒì¼ ìƒì„±
                  # ==========================================
                  echo "=== Preparing Environment Variables ==="
                  MODULE_NAME="$(params.module-name)"
                  APP_NAME="\${MODULE_NAME}"
                  SECRET_NAME="\${MODULE_NAME}-development"
                  
                  echo "Module: \${MODULE_NAME}"
                  echo "App: \${APP_NAME}"
                  echo "Secret: \${SECRET_NAME}"
                  echo ""
                  
                  # Secretì´ ë§ˆìš´íŠ¸ëœ ê²½ë¡œì—ì„œ .env íŒŒì¼ ìƒì„±
                  if [ -d "/secrets/env-vars" ]; then
                    ENV_FILE="/tmp/.env.production.local"
                    
                    echo "âœ“ Secret mounted, creating .env file"
                    
                    # Secretì˜ ëª¨ë“  í‚¤ë¥¼ .env í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                    for file in /secrets/env-vars/*; do
                      if [ -f "\${file}" ]; then
                        key=\$(basename "\${file}")
                        value=\$(cat "\${file}")
                        echo "\${key}=\${value}" >> "\${ENV_FILE}"
                      fi
                    done
                    
                    echo "âœ… Environment file created: \${ENV_FILE}"
                    echo "ğŸ“‹ Variables count: \$(wc -l < "\${ENV_FILE}")"
                    echo ""
                    echo "ğŸ” Environment Variables (Debugging):"
                    echo "========================================="
                    
                    # ë¯¼ê°í•œ ì •ë³´ ë§ˆìŠ¤í‚¹í•˜ì—¬ ì¶œë ¥
                    while IFS='=' read -r key value || [ -n "\${key}" ]; do
                      if [ -n "\${key}" ] && [ "\${key#\#}" = "\${key}" ]; then
                        if echo "\${key}" | grep -qiE '(SECRET|KEY|PASSWORD|TOKEN|CLIENT_ID)'; then
                          VALUE_LENGTH=\${#value}
                          if [ \${VALUE_LENGTH} -gt 0 ]; then
                            echo "  \${key}=****** (length: \${VALUE_LENGTH})"
                          else
                            echo "  \${key}=(empty) âš ï¸"
                          fi
                        else
                          echo "  \${key}=\${value}"
                        fi
                      fi
                    done < "\${ENV_FILE}"
                    
                    echo "========================================="
                    echo ""
                  else
                    echo "âš ï¸  Secret not mounted at /secrets/env-vars"
                    echo "âš ï¸  Build will proceed without environment variables"
                    ENV_FILE=""
                  fi
                  
                  # ==========================================
                  # Git Credentials (ë™ì¼)
                  # ==========================================
                  echo "=== Git Credentials ==="
                  if [ -f /secrets/git-token/username ] && [ -f /secrets/git-token/password ]; then
                    GIT_USERNAME=\$(cat /secrets/git-token/username)
                    GIT_PASSWORD=\$(cat /secrets/git-token/password)
                    git config --global credential.helper store
                    mkdir -p /root
                    echo "https://\${GIT_USERNAME}:\${GIT_PASSWORD}@github.com" > /root/.git-credentials
                    chmod 600 /root/.git-credentials
                    echo "âœ“ Git credentials configured"
                  fi
                  
                  # ==========================================
                  # Git Clone (ë™ì¼)
                  # ==========================================
                  echo "=== Git Clone ==="
                  git config --global user.name "Tekton CI"
                  git config --global user.email "ci@sukim-pf.com"
                  git config --global --add safe.directory /workspace
                  
                  if git clone -b $(params.revision) $(params.giturl) /workspace; then
                    cd /workspace
                    echo "âœ“ Clone successful (commit: \$(git rev-parse --short HEAD))"
                  else
                    echo "âœ— Clone failed"
                    exit 1
                  fi
                  
                  # ==========================================
                  # ğŸ”¥ NEW: .env íŒŒì¼ì„ ì•± ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬
                  # ==========================================
                  if [ -n "\${ENV_FILE}" ] && [ -f "\${ENV_FILE}" ]; then
                    # ecommerce í”„ë¡œì íŠ¸ êµ¬ì¡°ì— ë§ëŠ” ê²½ë¡œ
                    APP_DIR="/workspace/{{ .Values.frontend_context_dir }}"
                    
                    if [ -d "\${APP_DIR}" ]; then
                      cp "\${ENV_FILE}" "\${APP_DIR}/.env.production.local"
                      echo "âœ“ .env copied to \${APP_DIR}/.env.production.local"
                      echo ""
                    else
                      echo "âš ï¸  App directory not found: \${APP_DIR}"
                      echo "âš ï¸  Available directories:"
                      ls -la /workspace/ 2>/dev/null || echo "  Cannot list workspace"
                    fi
                  fi
                  
                  # ==========================================
                  # Dockerfile ê²½ë¡œ íƒìƒ‰
                  # ==========================================
                  echo "=== Dockerfile Path Check ==="
                  # ecommerce-frontendëŠ” ë‹¨ì¼ ì•± êµ¬ì¡°
                  CONTEXT_DIR="/workspace/{{ .Values.frontend_context_dir }}"
                  DOCKERFILE_PATH="\${CONTEXT_DIR}/Dockerfile.frontend"
                  
                  if [ -f "\${DOCKERFILE_PATH}" ]; then
                    echo "âœ“ Dockerfile found at: \${DOCKERFILE_PATH}"
                    ls -lh "\${DOCKERFILE_PATH}"
                  else
                    echo "âœ— CRITICAL: Dockerfile NOT found at: \${DOCKERFILE_PATH}"
                    echo "Searching for dockerfile in workspace..."
                    find /workspace -maxdepth 1 -iname "*dockerfile*" -type f 2>/dev/null || echo "No dockerfiles found"
                    exit 1
                  fi
                  
                  # ==========================================
                  # Pre-authenticate with Registry (ë™ì¼)
                  # ==========================================
                  echo "=== Pre-authenticating with Registry ==="
                  
                  if [ -f /kaniko/.docker/config.json ]; then
                    echo "âœ“ Harbor config found"
                    
                    REGISTRY_HOST="harbor.8ai.store"
                    TEST_IMAGE="\${REGISTRY_HOST}/common/alpine:latest"
                    
                    echo "Testing authentication with: \${TEST_IMAGE}"
                    
                    if crane manifest \${TEST_IMAGE} > /dev/null 2>&1; then
                      echo "âœ“ Authentication successful"
                    else
                      echo "âš ï¸  Authentication test failed, but proceeding"
                    fi
                  else
                    echo "âœ— Harbor config not found at /kaniko/.docker/config.json"
                    exit 1
                  fi
                  
                  # ==========================================
                  # â­ Kaniko Build
                  # ==========================================
                  echo "=== Kaniko Build ==="
                  IMAGE_TAG="$(params.container-registry-url)/$(params.module-name):$(params.git-short-sha)-$(params.timestamp)"
                  echo "Image: \${IMAGE_TAG}"
                  echo "Dockerfile: \${DOCKERFILE_PATH}"
                  echo "Context: \${CONTEXT_DIR}"
                  echo "Module: $(params.module-name)"
                  echo ""
                  
                  # Context ë””ë ‰í† ë¦¬ ê¸°ì¤€ ìƒëŒ€ ê²½ë¡œ (Dockerfileì´ context ì•ˆì— ìˆìŒ)
                  RELATIVE_DOCKERFILE="./Dockerfile.frontend"
                  echo "Relative Dockerfile path: \${RELATIVE_DOCKERFILE}"
                  echo ""
                  
                  cd \${CONTEXT_DIR}
                  
                  echo "=== Build Configuration ==="
                  echo "Dockerfile: \${DOCKERFILE_PATH}"
                  echo "Relative Path: \${RELATIVE_DOCKERFILE}"
                  
                  # ğŸ”¥ .env íŒŒì¼ ìµœì¢… í™•ì¸
                  if [ -f "/workspace/{{ .Values.frontend_context_dir }}/.env.production.local" ]; then
                    echo "âœ“ .env.production.local present in app directory"
                    echo "  Variables: \$(wc -l < /workspace/{{ .Values.frontend_context_dir }}/.env.production.local)"
                  else
                    echo "âš ï¸  .env.production.local not found in app directory"
                  fi
                  echo ""
                  
                  # â­ Dockerfileì— ë”°ë¼ ë¹Œë“œ ì „ëµ ìë™ ì„ íƒ
                  BUILD_ARGS=""
                  TARGET_ARGS=""
                  
                  # Dockerfile.frontend.unifiedì¸ ê²½ìš°
                  if echo "\${DOCKERFILE_PATH}" | grep -q "Dockerfile.frontend.unified"; then
                    echo "âœ“ Detected: Dockerfile.frontend.unified (Layer Cache Optimized)"
                    # âš ï¸ Dockerfileì˜ ARG APPëŠ” ì „ì²´ ëª¨ë“ˆëª…ì„ ë°›ìŒ (goyoai-xxx-web)
                    # â­ Production í™˜ê²½ ARG ì¶”ê°€
                    BUILD_ARGS="--build-arg=APP=\${MODULE_NAME}"
                    BUILD_ARGS="\${BUILD_ARGS} --build-arg=BASE_IMAGE=harbor.8ai.store/common/node:20.18.3-alpine3.21"
                    BUILD_ARGS="\${BUILD_ARGS} --build-arg=ENVIRONMENT=production"
                    BUILD_ARGS="\${BUILD_ARGS} --build-arg=PNPM_INSTALL_ARGS=--frozen-lockfile"
                    BUILD_ARGS="\${BUILD_ARGS} --build-arg=BUILD_SCRIPT=build:prod"
                    TARGET_ARGS="--target=runtime-standalone"
                  # ê¸°ì¡´ Dockerfile (dockerfile-*-prod ë“±)ì¸ ê²½ìš°
                  else
                    echo "âœ“ Detected: Legacy Dockerfile (Standard Build)"
                    # ê¸°ì¡´ ë°©ì‹: ARG ì²´í¬ í›„ ì¡°ê±´ë¶€ ì „ë‹¬
                    if grep -qE "(ARG APP_NAME|ARG MODULE_NAME)" "\${DOCKERFILE_PATH}"; then
                      BUILD_ARGS="--build-arg=APP_NAME=\${APP_NAME} --build-arg=MODULE_NAME=\${APP_NAME}"
                    fi
                  fi
                  
                  echo "Build Args: \${BUILD_ARGS}"
                  echo "Target Args: \${TARGET_ARGS}"
                  echo ""    

                  /kaniko/executor \
                    --context=\${CONTEXT_DIR} \
                    --dockerfile=\${RELATIVE_DOCKERFILE} \
                    --destination=\${IMAGE_TAG} \
                    \${BUILD_ARGS} \
                    \${TARGET_ARGS} \
                    --force \
                    --skip-tls-verify \
                    --skip-push-permission-check \
                    --skip-unused-stages \
                    --use-new-run \
                    --ignore-path=/var/spool/mail \
                    --ignore-path=/var/mail \
                    --ignore-path=/var/spool \
                    --cache=true \
                    --cache-ttl=168h \
                    --cache-repo=$(params.container-registry-cache-url)/$(params.module-name) \
                    --cache-copy-layers \
                    --snapshot-mode=time \
                    --compressed-caching=false \
                    --ignore-var-run \
                    --cleanup \
                    --cache-dir=/cache \
                    --verbosity=info
                  
                  BUILD_EXIT=\$?
                  
                  if [ \${BUILD_EXIT} -ne 0 ]; then
                    echo ""
                    echo "âœ— Build failed with exit code \${BUILD_EXIT}"
                    exit 1
                  fi
                  
                  echo ""
                  echo "=========================================="
                  echo "âœ… Build Complete!"
                  echo "=========================================="
                  echo "Image: \${IMAGE_TAG}"
                  echo "Module: $(params.module-name)"
                  if [ -n "\${TARGET_ARGS}" ]; then
                    echo "Mode: Optimized (runtime-standalone)"
                  else
                    echo "Mode: Standard"
                  fi
                  echo "=========================================="

                env:
                - name: DOCKER_CONFIG
                  value: "/kaniko/.docker"
                volumeMounts:
                - name: workspace
                  mountPath: /workspace
                - name: kaniko-cache
                  mountPath: /cache
                - name: git-credentials
                  mountPath: /secrets/git-token
                  readOnly: true
                - name: harbor-config
                  mountPath: /kaniko/.docker
                  readOnly: true
                - name: env-secrets
                  mountPath: /secrets/env-vars
                  readOnly: true
                
                resources:
                  requests:
                    memory: "8Gi"
                    cpu: "4000m"
                  limits:
                    memory: "16Gi"
                    cpu: "8000m"
                    
              volumes:
              - name: workspace
                emptyDir: {}
              - name: kaniko-cache
                emptyDir: {}
              - name: git-credentials
                secret:
                  secretName: git-token
              - name: harbor-config
                secret:
                  secretName: kaniko-secret
                  items:
                  - key: config.json
                    path: config.json
                    mode: 0644
              - name: env-secrets
                secret:
                  secretName: $(params.module-name)-development
                  optional: true
        EOF
        
        echo "Job ${JOB_NAME} created successfully"
        echo "${JOB_NAME}" > /tmp/job-name
      volumeMounts:
        - name: job-info
          mountPath: /tmp
    
    # 'wait-for-job' ìŠ¤í…ì€ ë°±ì—”ë“œì™€ ë™ì¼í•˜ê²Œ ìœ ì§€ (ìˆ˜ì • í•„ìš” ì—†ìŒ)
    - name: wait-for-job
      image: {{ .Values.common_alpine_url }}
      script: |
        #!/bin/sh
        set -e
        apk add --no-cache curl

        echo "Detecting architecture..."
        ARCH=$(uname -m)
        if [ "$ARCH" = "aarch64" ]; then
          K8S_ARCH="arm64"
        elif [ "$ARCH" = "x86_64" ]; then
          K8S_ARCH="amd64"
        else
          echo "Unsupported architecture: $ARCH"
          exit 1
        fi
        
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/${K8S_ARCH}/kubectl"
        chmod +x kubectl
        mv kubectl /usr/local/bin/
        
        JOB_NAME=$(cat /tmp/job-name)
        
        echo "=========================================="
        echo "ğŸ“¦ Waiting for Kaniko Build Job"
        echo "=========================================="
        echo "Job Name: ${JOB_NAME}"
        echo "Timeout: 1800 seconds (30 minutes)"
        echo "=========================================="
        echo ""
        
        # Podê°€ ìƒì„±ë  ë•Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 60ì´ˆ)
        echo "â³ Waiting for Pod to be created..."
        POD_NAME=""
        for i in $(seq 1 60); do
          POD_NAME=$(kubectl get pods -n tekton-pipelines -l job-name=${JOB_NAME} -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          if [ -n "$POD_NAME" ]; then
            echo "âœ“ Pod created: ${POD_NAME}"
            break
          fi
          sleep 1
        done
        
        if [ -z "$POD_NAME" ]; then
          echo "âœ— Pod creation timeout"
          exit 1
        fi
        
        # Podê°€ Running ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 120ì´ˆ)
        echo ""
        echo "â³ Waiting for Pod to start running..."
        for i in $(seq 1 120); do
          POD_STATUS=$(kubectl get pod ${POD_NAME} -n tekton-pipelines -o jsonpath='{.status.phase}' 2>/dev/null || echo "")
          if [ "$POD_STATUS" = "Running" ] || [ "$POD_STATUS" = "Succeeded" ]; then
            echo "âœ“ Pod is ${POD_STATUS}"
            break
          fi
          
          # Pod ìƒíƒœ ì¶œë ¥
          if [ $((i % 10)) -eq 0 ]; then
            echo "  Pod status: ${POD_STATUS} (${i}s)"
          fi
          sleep 1
        done
        
        echo ""
        echo "=========================================="
        echo "ğŸ“‹ Streaming Kaniko Build Logs"
        echo "=========================================="
        echo ""
        
        # ë¡œê·¸ ìŠ¤íŠ¸ë¦¬ë°ì„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
        kubectl logs -f ${POD_NAME} -n tekton-pipelines -c kaniko-build 2>/dev/null &
        LOG_PID=$!
        
        # Job ìƒíƒœ ëª¨ë‹ˆí„°ë§
        TIMEOUT=1800
        ELAPSED=0
        INTERVAL=5
        
        while [ $ELAPSED -lt $TIMEOUT ]; do
          # Job ìƒíƒœ í™•ì¸
          STATUS=$(kubectl get job ${JOB_NAME} -n tekton-pipelines -o jsonpath='{.status.conditions[?(@.type=="Complete")].status}' 2>/dev/null || echo "")
          FAILED=$(kubectl get job ${JOB_NAME} -n tekton-pipelines -o jsonpath='{.status.conditions[?(@.type=="Failed")].status}' 2>/dev/null || echo "")
          
          if [ "$STATUS" = "True" ]; then
            # ë¡œê·¸ í”„ë¡œì„¸ìŠ¤ê°€ ëë‚  ë•Œê¹Œì§€ ì ì‹œ ëŒ€ê¸°
            sleep 2
            kill $LOG_PID 2>/dev/null || true
            
            echo ""
            echo "=========================================="
            echo "âœ… Build Completed Successfully!"
            echo "=========================================="
            echo "Image: $(params.container-registry-url)/$(params.module-name):$(params.git-short-sha)-$(params.timestamp)"
            echo "=========================================="
            
            echo "$(params.container-registry-url)/$(params.module-name):$(params.git-short-sha)-$(params.timestamp)" > $(results.image-url.path)
            exit 0
          fi
          
          if [ "$FAILED" = "True" ]; then
            kill $LOG_PID 2>/dev/null || true
            
            echo ""
            echo "=========================================="
            echo "âŒ Build Failed"
            echo "=========================================="
            echo ""
            echo "=== Last 200 lines of logs ==="
            kubectl logs ${POD_NAME} -n tekton-pipelines -c kaniko-build --tail=200 2>/dev/null || true
            echo ""
            echo "=== Pod Status ==="
            kubectl describe pod ${POD_NAME} -n tekton-pipelines | tail -50
            exit 1
          fi
          
          sleep $INTERVAL
          ELAPSED=$((ELAPSED + INTERVAL))
        done
        
        # Timeout
        kill $LOG_PID 2>/dev/null || true
        
        echo ""
        echo "=========================================="
        echo "â±ï¸  Build Timeout (30 minutes)"
        echo "=========================================="
        echo ""
        echo "=== Last 200 lines of logs ==="
        kubectl logs ${POD_NAME} -n tekton-pipelines -c kaniko-build --tail=200 2>/dev/null || true
        exit 1
      volumeMounts:
        - name: job-info
          mountPath: /tmp
  
  volumes:
    - name: job-info
      emptyDir: {}