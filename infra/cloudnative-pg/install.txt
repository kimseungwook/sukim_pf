# =============================================================================
# CloudNativePG Installation Guide
# =============================================================================
# CloudNativePG: Kubernetes-native PostgreSQL Operator
# 오픈소스, CNCF 프로젝트 - Bitnami 대체
# =============================================================================

# -----------------------------------------------------------------------------
# Step 1: Namespace 생성
# -----------------------------------------------------------------------------
kubectl create namespace cloudnative-pg

# -----------------------------------------------------------------------------
# Step 2: Helm Repository 추가
# -----------------------------------------------------------------------------
helm repo add cnpg https://cloudnative-pg.github.io/charts
helm repo update

# -----------------------------------------------------------------------------
# Step 3: CloudNativePG Operator 설치
# -----------------------------------------------------------------------------
helm upgrade --install cnpg \
  --namespace cloudnative-pg \
  cnpg/cloudnative-pg \
  -f cloudnative-pg/values.yaml \
  --create-namespace \
  --version 0.27.0

# -----------------------------------------------------------------------------
# Step 4: Operator 실행 확인
# -----------------------------------------------------------------------------
kubectl get pods -n cloudnative-pg
kubectl get crds | grep postgresql

# -----------------------------------------------------------------------------
# Step 5: PostgreSQL Secrets 생성
# -----------------------------------------------------------------------------
kubectl apply -f pg-secrets.yaml

# Secret 확인
kubectl get secrets -n cloudnative-pg | grep nocodb-pg

# -----------------------------------------------------------------------------
# Step 6: PostgreSQL Cluster 생성
# -----------------------------------------------------------------------------
kubectl apply -f nocodb-pg-cluster.yaml

# Cluster 상태 확인
kubectl get cluster -n cloudnative-pg
kubectl get pods -n cloudnative-pg -l cnpg.io/cluster=nocodb-pg

# 상세 정보
kubectl describe cluster nocodb-pg -n cloudnative-pg

# -----------------------------------------------------------------------------
# Step 7: 연결 정보 확인
# -----------------------------------------------------------------------------
# Service 확인 (Primary: nocodb-pg-rw, Replicas: nocodb-pg-ro, Any: nocodb-pg-r)
kubectl get svc -n cloudnative-pg

# 연결 문자열
# Read-Write: nocodb-pg-rw.cloudnative-pg.svc.cluster.local:5432
# Read-Only: nocodb-pg-ro.cloudnative-pg.svc.cluster.local:5432

# App credentials 확인
kubectl get secret nocodb-pg-app -n cloudnative-pg -o jsonpath='{.data.username}' | base64 -d
kubectl get secret nocodb-pg-app -n cloudnative-pg -o jsonpath='{.data.password}' | base64 -d

# -----------------------------------------------------------------------------
# Troubleshooting
# -----------------------------------------------------------------------------
# Operator 로그
kubectl logs -n cloudnative-pg -l app.kubernetes.io/name=cloudnative-pg

# PostgreSQL Pod 로그
kubectl logs -n cloudnative-pg nocodb-pg-1

# Cluster 상태
kubectl cnpg status nocodb-pg -n cloudnative-pg

# Cluster 이벤트
kubectl get events -n cloudnative-pg --sort-by='.lastTimestamp'

# -----------------------------------------------------------------------------
# 업그레이드
# -----------------------------------------------------------------------------
# Operator 업그레이드
helm repo update
helm upgrade cnpg cnpg/cloudnative-pg \
  -n cloudnative-pg \
  -f values.yaml

# PostgreSQL 버전 업그레이드 (cluster 파일에서 imageName 변경 후)
kubectl apply -f nocodb-pg-cluster.yaml

# -----------------------------------------------------------------------------
# 백업 & 복구
# -----------------------------------------------------------------------------
# On-demand 백업
cat <<EOF | kubectl apply -f -
apiVersion: postgresql.cnpg.io/v1
kind: Backup
metadata:
  name: nocodb-pg-backup-$(date +%Y%m%d-%H%M%S)
  namespace: cloudnative-pg
spec:
  cluster:
    name: nocodb-pg
EOF

# 백업 리스트
kubectl get backup -n cloudnative-pg

# 스케줄 백업 (매일 2시)
cat <<EOF | kubectl apply -f -
apiVersion: postgresql.cnpg.io/v1
kind: ScheduledBackup
metadata:
  name: nocodb-pg-daily-backup
  namespace: cloudnative-pg
spec:
  schedule: "0 2 * * *"
  backupOwnerReference: self
  cluster:
    name: nocodb-pg
EOF

# -----------------------------------------------------------------------------
# Failover 테스트
# -----------------------------------------------------------------------------
# Primary pod 삭제하여 자동 failover 확인
kubectl delete pod nocodb-pg-1 -n cloudnative-pg

# Failover 상태 확인
kubectl get cluster nocodb-pg -n cloudnative-pg -o jsonpath='{.status.currentPrimary}'

# -----------------------------------------------------------------------------
# 삭제
# -----------------------------------------------------------------------------
# PostgreSQL Cluster 삭제
kubectl delete cluster nocodb-pg -n cloudnative-pg

# PVC 확인 및 삭제 (선택)
kubectl get pvc -n cloudnative-pg
kubectl delete pvc -n cloudnative-pg --all

# Secrets 삭제
kubectl delete -f pg-secrets.yaml

# Operator 삭제
helm uninstall cnpg -n cloudnative-pg

# CRD 삭제 (선택 - 모든 PostgreSQL 리소스 삭제됨)
kubectl delete crd clusters.postgresql.cnpg.io
kubectl delete crd backups.postgresql.cnpg.io
kubectl delete crd scheduledbackups.postgresql.cnpg.io
kubectl delete crd poolers.postgresql.cnpg.io

# Namespace 삭제
kubectl delete namespace cloudnative-pg

# =============================================================================
# NocoDB 통합
# =============================================================================
# NocoDB values.yaml 수정:
#
# env:
#   NC_DB: 'pg://nocodb-pg-rw.cloudnative-pg.svc.cluster.local:5432?u=nocodb&p=<password>&d=nocodb'
#
# 또는 Secret 사용:
# apiVersion: v1
# kind: Secret
# metadata:
#   name: nocodb-env
#   namespace: nocodb
# stringData:
#   NC_DB: 'pg://nocodb-pg-rw.cloudnative-pg.svc.cluster.local:5432?u=nocodb&p=<password>&d=nocodb'
