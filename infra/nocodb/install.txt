# =============================================================================
# NocoDB Installation Guide
# =============================================================================

# -----------------------------------------------------------------------------
# Step 1: Namespace 생성
# -----------------------------------------------------------------------------
kubectl create namespace nocodb

# -----------------------------------------------------------------------------
# Step 2: CloudNativePG PostgreSQL 연결 Secret 생성
# -----------------------------------------------------------------------------
# CloudNativePG는 cloudnative-pg namespace에 설치되어 있어야 함
# PostgreSQL Cluster: nocodb-pg

# 1. CloudNativePG에서 생성한 앱 암호 확인
kubectl get secret nocodb-pg-app -n cloudnative-pg -o jsonpath='{.data.password}' | base64 -d
echo  # 줄바꿈

# 2. 위에서 확인한 암호를 nocodb-env-secret.yaml에 입력
# NC_DB: "pg://nocodb-pg-rw.cloudnative-pg.svc.cluster.local:5432?u=nocodb&p=YOUR_PASSWORD&d=nocodb"

# 3. Secret 적용
kubectl apply -f nocodb/nocodb-env-secret.yaml

# Secret 확인
kubectl get secret nocodb-env-secrets -n nocodb

# -----------------------------------------------------------------------------
# Step 3: Helm Repository 추가
# -----------------------------------------------------------------------------
helm repo add zekker6 https://zekker6.github.io/helm-charts
helm repo update

# -----------------------------------------------------------------------------
# Step 4: NocoDB 설치
# -----------------------------------------------------------------------------
helm upgrade --install nocodb zekker6/nocodb \
  -n nocodb \
  -f nocodb/values.yaml

# -----------------------------------------------------------------------------
# Step 5: 설치 확인
# -----------------------------------------------------------------------------
kubectl get pods -n nocodb
kubectl get svc -n nocodb

# -----------------------------------------------------------------------------
# 업그레이드
# -----------------------------------------------------------------------------
helm repo update
helm upgrade nocodb zekker6/nocodb -n nocodb -f values.yaml

# -----------------------------------------------------------------------------
# 삭제
# -----------------------------------------------------------------------------
helm uninstall nocodb -n nocodb
kubectl delete secret -n nocodb nocodb-secrets
kubectl delete pvc -n nocodb --all
kubectl delete namespace nocodb