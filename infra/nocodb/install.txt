# =============================================================================
# NocoDB Installation Guide
# =============================================================================

# -----------------------------------------------------------------------------
# Step 1: Namespace 생성
# -----------------------------------------------------------------------------
kubectl create namespace nocodb

# -----------------------------------------------------------------------------
# Step 2: PostgreSQL 별도 설치 (Bitnami Chart)
# -----------------------------------------------------------------------------
# NocoDB Chart는 PostgreSQL subchart를 더 이상 지원하지 않음
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update

helm upgrade --install nocodb-postgresql bitnami/postgresql \
  -n nocodb \
  --set auth.username=nocodb \
  --set auth.password=nocodb \
  --set auth.database=nocodb \
  --set auth.postgresPassword=nocodb \
  --set primary.persistence.enabled=false \
  --set primary.nodeSelector.service=tools

# PostgreSQL 실행 확인
kubectl get pods -n nocodb -l app.kubernetes.io/name=postgresql

# -----------------------------------------------------------------------------
# Step 3: Helm Repository 추가
# -----------------------------------------------------------------------------
helm repo add zekker6 https://zekker6.github.io/helm-charts
helm repo update

# -----------------------------------------------------------------------------
# Step 4: NocoDB 설치
# -----------------------------------------------------------------------------
helm upgrade --install nocodb zekker6/nocodb \
  -n nocodb \
  -f nocodb/values.yaml

# -----------------------------------------------------------------------------
# Step 5: 설치 확인
# -----------------------------------------------------------------------------
kubectl get pods -n nocodb
kubectl get svc -n nocodb

# -----------------------------------------------------------------------------
# 업그레이드
# -----------------------------------------------------------------------------
helm repo update
helm upgrade nocodb zekker6/nocodb -n nocodb -f values.yaml

# -----------------------------------------------------------------------------
# 삭제
# -----------------------------------------------------------------------------
helm uninstall nocodb -n nocodb
kubectl delete secret -n nocodb nocodb-secrets
kubectl delete pvc -n nocodb --all
kubectl delete namespace nocodb