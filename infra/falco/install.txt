# =============================================================================
# Falco Installation Guide - Cloud Native Runtime Security
# =============================================================================

# -----------------------------------------------------------------------------
# 개요
# -----------------------------------------------------------------------------
# - Kubernetes 런타임 보안 도구
# - 비정상적인 행위 탐지 (예: 셸 실행, 민감한 파일 접근)
# - eBPF Probe 또는 Kernel Module 사용
# - 위협 탐지 및 알림 (Alert)

# -----------------------------------------------------------------------------
# Step 1: Helm Repo 추가
# -----------------------------------------------------------------------------
helm repo add falcosecurity https://falcosecurity.github.io/charts
helm repo update

# -----------------------------------------------------------------------------
# Step 2: Namespace 생성 및 Secret 설정
# -----------------------------------------------------------------------------
kubectl create namespace falco

# WebUI 접근을 위한 Secret 생성 (falco/values.yaml에서 참조)
kubectl apply -f infra/falco/webui_secret.yaml -n falco

# -----------------------------------------------------------------------------
# Step 3: Falco 설치
# -----------------------------------------------------------------------------
# Kernel Module 방식 사용 시 노드의 커널 헤더 필요
# eBPF 방식 사용 시 driver.kind=ebpf 설정 필요 (values.yaml 참고)

helm upgrade --install falco falcosecurity/falco \
  --version 4.18.0 \
  -f infra/falco/values.yaml \
  -n falco \
  --create-namespace

# Note: values.yaml에서 eBPF, Sidekick 설정 등 확인 필요

# -----------------------------------------------------------------------------
# Step 4: 설치 확인
# -----------------------------------------------------------------------------
kubectl get pods -n falco
kubectl get svc -n falco

# Pod 로그 확인 (정상적으로 로드되었는지 확인)
kubectl logs -n falco -l app.kubernetes.io/name=falco -f

# -----------------------------------------------------------------------------
# Step 5: 동작 테스트
# -----------------------------------------------------------------------------
# 의심스러운 행위 시뮬레이션 (수동 생성)
# 1. Pod 내부로 진입하여 /etc/shadow 조회 시도 (Falco 규칙 위반)
# kubectl exec -it <falco-pod-name> -n falco -- sh -c "cat /etc/shadow"

# 2. 로그에서 'Notice' 또는 'Warning' 확인
# kubectl logs -n falco -l app.kubernetes.io/name=falco | grep "Notice"

# -----------------------------------------------------------------------------
# 업그레이드
# -----------------------------------------------------------------------------
helm upgrade falco falcosecurity/falco \
  --version 4.18.0 \
  -f infra/falco/values.yaml \
  -n falco

# 릴리즈 히스토리 확인
helm history falco -n falco

# 이전 버전으로 롤백 (필요시)
# helm rollback falco [REVISION] -n falco

# -----------------------------------------------------------------------------
# 삭제
# -----------------------------------------------------------------------------
helm uninstall falco -n falco
kubectl delete namespace falco

# -----------------------------------------------------------------------------
# 트러블슈팅
# -----------------------------------------------------------------------------
# 1. CrashLoopBackOff 발생 시
# - 커널 모듈/eBPF 프로브 로드 실패 가능성 높음
# - 노드 커널 버전 호환성 확인
# - logs 확인: kubectl logs -n falco <pod-name>

# 2. 이벤트가 발생하지 않을 때
# - rules 설정 확인
# - json output 설정 확인 (json-output: true)

# -----------------------------------------------------------------------------
# 유용한 명령어
# -----------------------------------------------------------------------------
# Falco 설정(ConfigMap) 확인
kubectl get cm falco -n falco -o yaml

# Falco Rules(ConfigMap) 확인
kubectl get cm falco-rules -n falco -o yaml
