# 1. 드라이버 설정: eBPF 사용
driver:
  kind: "ebpf"

# 2. 스케줄링: Virtual Node (Tekton) 제외
affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
      - matchExpressions:
        # 'node-type=virtual' 레이블이 없는 노드에만 설치
        - key: node-type
          operator: NotIn
          values:
          - virtual
        # 'workload-type=sukim-build' 레이블이 없는 노드에만 설치
        - key: workload
          operator: NotIn
          values:
          - sukim-build

# 3. K8s 메타데이터: 풍부한 정보 수집 활성화
collectors:
  kubernetes:
    enabled: true

# 4. Prometheus 메트릭: Falco 성능 지표 수집
metrics:
  enabled: true

serviceMonitor:
  create: true
  labels:
    release: prometheus-stack
  endpointPort: "metrics"
  path: "/metrics"
  interval: "30s"
  scrapeTimeout: "10s"

# 5. 알림: Falcosidekick 활성화 (Slack 연동)
falcosidekick:
  enabled: true
  webui:
    enabled: true
    existingSecret: "falcosidekick-ui-secret"
  config:
    slack:
      webhookurl: "https://hooks.slack.com/services/xxxxx/xxxxx/xxxxx"
      minimumpriority: "warning"
    loki:
      hostport: "http://loki-gateway.monitoring.svc.cluster.local:80"
      minimumpriority: "notice"
    serviceMonitor:
      create: true
      labels:
        release: prometheus-stack

# 6. (추가됨) Falcoctl: 룰셋 및 플러그인 관리
# 이것이 없으면 Falco가 룰 없이 실행될 수 있습니다.
falcoctl:
  artifact:
    install:
      enabled: true
      refs:
        - falco-rules:5
        # [추가] k8smeta 플러그인 (collectors.kubernetes.enabled=true에 필요)
        - "ghcr.io/falcosecurity/plugins/plugin/k8smeta:0.4.0"
        # [추가] container 플러그인 (컨테이너 메타데이터 수집에 필요)
        - "ghcr.io/falcosecurity/plugins/plugin/container:0.4.1"
    follow:
      enabled: true
      # 'follow'는 룰 업데이트만 추적하므로 이 부분은 수정할 필요 없습니다.
      refs: [falco-rules:5]

  config:
    indexes:
    - name: falcosecurity
      url: https://falcosecurity.github.io/falcoctl/index.yaml

webserver:
    enabled: true
    listen_port: 8765
    prometheus_metrics_enabled: true
    
# 7. (수정됨) 커스텀 룰: 정상적인 시스템 Pod 예외 처리
customRules:
  custom_rules.yaml: |-
    # === Trusted processes list ===
    - list: user_known_k8s_client_container_parens
      items: [
        vault,
        metrics-server,
        pipeline-controller,
        descheduler,
        fleetagent,
        argocd-server,
        argocd-application-controller,
        prometheus,
        kube-controller
      ]
    
    # === Trusted namespaces ===
    - list: user_known_k8s_namespaces
      items: [
        vault,
        argocd,
        tekton-pipelines,
        monitoring,
        cert-manager,
        harbor,
        kube-system,
        kyverno,           # 중요: 정책 검사 및 리포트 생성
        traefik,           # 중요: 인그레스 컨트롤러
        keda,              # 오토스케일링 컨트롤러
        descheduler,       # 스케줄링 최적화
        reloader,          # 설정 변경 감지
        vpa,               # 수직 오토스케일링
        goldilocks,        # VPA 추천
        prometheus,        # (monitoring 대신 실제 존재하는 NS)
        monitoring,              # (로그/모니터링 스택)
        metrics-server,    # 메트릭 집계
        falco,             # 보안
        tekton-operator,   # Tekton Operator
        trivy,             # Trivy
        authentik          # 인증
      ]
    
    # === Override user macro (이미 기본 룰에 정의되어 있음) ===
    - macro: user_known_contact_k8s_api_server_activities
      condition: >
        (proc.name in (user_known_k8s_client_container_parens)) or
        (k8s.ns.name in (user_known_k8s_namespaces))

    # === Rule Exceptions ===
    - rule: Drop and execute new binary in container
      override:
        exceptions: append
      exceptions:
        - name: tekton_kubectl
          fields: [k8s.ns.name, proc.name]
          comps: [=, =]
          values:
            - [tekton-pipelines, kubectl]
        - name: tekton_c_rehash
          fields: [k8s.ns.name, proc.name]
          comps: [=, =]
          values:
            - [tekton-pipelines, c_rehash]