# goyo_prd/lgtm/promtail/values.yaml
global:
  storageClass: "oci-bv"
serviceAccount:
  create: true
rbac:
  create: true
daemonset:
  enabled: true
service:
  enabled: true
nodeSelector:
  goyo-svc: "ai-api"
  
nodeAffinity:
  requiredDuringSchedulingIgnoredDuringExecution:
    nodeSelectorTerms:
    - matchExpressions:
      - key: "goyo-svc"
        operator: In
        values:
        - "ai-api"
    
tolerations:
  - key: "goyo-svc"
    operator: "Equal"
    value: "ai-api"
    effect: "NoSchedule"
config:
  clients:
    - url: http://goyo-loki-distributed-gateway.monitoring.svc.cluster.local:80/loki/api/v1/push
  positions:
    filename: /run/promtail/positions.yaml
    
  snippets:
    pipelineStages:
      # 1. CRI ë¡œê·¸ íŒŒì‹±
      - cri: {}
      
      # 2. íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒì‹±
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      
      # 3. íŠ¸ë ˆì´ìŠ¤ ì •ë³´ ì¶”ì¶œ ([traceId,spanId] íŒ¨í„´)
      - regex:
          expression: '\[(?P<traceId>[a-f0-9]{16,32})\s+(?P<spanId>[a-f0-9]{16,32})\]'
          source: output
      - labels:
          traceId:
          spanId:
      
      # 4. ë¡œê·¸ ë ˆë²¨ ì¶”ì¶œ
      - regex:
          expression: '^\d{2}:\d{2}:\d{2}\.\d{3}\s+(DEBUG|INFO|WARN|ERROR|FATAL)\s+'
          source: output
      - labels:
          level: 
      
      # 5. ì—ëŸ¬ ë¡œê·¸ êµ¬ë¶„ (ğŸš¨ ì´ëª¨ì§€)
      - regex:
          expression: '^ğŸš¨.*'
          source: output
      - labels:
          error_flag: "true"
          
  scrape_configs:
    - job_name: kubernetes-pods
      kubernetes_sd_configs:
        - role: pod
      # snippetsì˜ pipelineStagesê°€ ì—¬ê¸°ì— ìë™ ì ìš©ë¨ (ì¤‘ë³µ ì œê±°)
      relabel_configs:
        # ê¸°ë³¸ ì¿ ë²„ë„¤í‹°ìŠ¤ ë ˆì´ë¸”
        - source_labels: [__meta_kubernetes_namespace]
          target_label: namespace
        - source_labels: [__meta_kubernetes_pod_name]
          target_label: pod
        - source_labels: [__meta_kubernetes_pod_container_name]
          target_label: container
        - source_labels: [__meta_kubernetes_pod_node_name]
          target_label: node
          
        # Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ íŠ¹í™” ë ˆì´ë¸”
        - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
          target_label: service_name
        - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_instance]
          target_label: service_instance
          
        # ëª¨ë“  pod ë ˆì´ë¸”ì„ Loki ë ˆì´ë¸”ë¡œ ë§¤í•‘
        - action: labelmap
          regex: __meta_kubernetes_pod_label_(.+)
          
        # ë¡œê·¸ íŒŒì¼ ê²½ë¡œ ì„¤ì •
        - action: replace
          source_labels: [__meta_kubernetes_pod_uid, __meta_kubernetes_pod_container_name]
          separator: /
          target_label: __path__
          replacement: /var/log/pods/*$1/*.log
          
        # goyoai ê´€ë ¨ podë§Œ ìˆ˜ì§‘
        - source_labels: [__meta_kubernetes_pod_label_name]
          regex: '.*goyoai.*'
          action: keep
networkPolicy:
  enabled: false