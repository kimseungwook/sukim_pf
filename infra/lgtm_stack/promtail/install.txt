# =============================================================================
# Promtail Installation Guide - Grafana Helm Chart
# =============================================================================

# -----------------------------------------------------------------------------
# 개요
# -----------------------------------------------------------------------------
# - server-side pull이 아닌 agent-side push 방식
# - 설치 전에 Loki가 먼저 설치되어 있어야 함
# - Virtual 노드 제외, 일반 노드에만 DaemonSet으로 설치

# -----------------------------------------------------------------------------
# Step 1: Helm Repo 추가
# -----------------------------------------------------------------------------
helm repo add grafana https://grafana.github.io/helm-charts
helm repo update

# -----------------------------------------------------------------------------
# Step 2: Promtail 설치
# -----------------------------------------------------------------------------
helm upgrade --install promtail grafana/promtail \
  -f infra/lgtm_stack/promtail/values.yaml \
  -n promtail \
  --create-namespace

# -----------------------------------------------------------------------------
# Step 3: 설치 확인
# -----------------------------------------------------------------------------
kubectl get pods -n promtail
kubectl get daemonset -n promtail

# Pod 로그 확인
kubectl logs -n promtail -l app.kubernetes.io/name=promtail -f

# Pod 상태 확인
kubectl describe pod -n promtail -l app.kubernetes.io/name=promtail

# -----------------------------------------------------------------------------
# 업그레이드
# -----------------------------------------------------------------------------
helm upgrade promtail grafana/promtail \
  -f infra/lgtm_stack/promtail/values.yaml \
  -n promtail

# 릴리즈 히스토리 확인
helm history promtail -n promtail

# 이전 버전으로 롤백 (필요시)
# helm rollback promtail [REVISION] -n promtail

# -----------------------------------------------------------------------------
# 삭제
# -----------------------------------------------------------------------------
helm uninstall promtail -n promtail
kubectl delete namespace promtail

# -----------------------------------------------------------------------------
# 트러블슈팅
# -----------------------------------------------------------------------------
# 1. Pod가 시작되지 않는 경우
kubectl describe pod -n promtail -l app.kubernetes.io/name=promtail
kubectl logs -n promtail -l app.kubernetes.io/name=promtail --previous

# 2. Loki 연결 확인
kubectl logs -n promtail -l app.kubernetes.io/name=promtail | grep -i "loki\|error"

# 3. Helm 차트 값 확인
helm get values promtail -n promtail
helm get manifest promtail -n promtail

# 4. Pod가 어느 노드에 스케줄 되었는지 확인
kubectl get pods -n promtail -o wide

# -----------------------------------------------------------------------------
# 유용한 명령어
# -----------------------------------------------------------------------------
# Promtail 설정 확인
kubectl exec -it -n promtail <promtail-pod-name> -- cat /etc/promtail/promtail.yaml

# Promtail 타겟 확인 (어떤 Pod 로그를 수집하는지)
kubectl exec -it -n promtail <promtail-pod-name> -- wget -qO- http://localhost:3101/targets