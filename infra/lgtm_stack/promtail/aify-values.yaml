# goyo_prd/lgtm/promtail/aify-values.yaml
global:
  storageClass: "oci-bv"

serviceAccount:
  create: true

rbac:
  create: true

daemonset:
  enabled: true

service:
  enabled: true

nodeSelector:
  goyo-svc: "aify"
  
nodeAffinity:
  requiredDuringSchedulingIgnoredDuringExecution:
    nodeSelectorTerms:
    - matchExpressions:
      - key: "goyo-svc"
        operator: In
        values:
        - "aify"
    
tolerations:
  - key: "goyo-svc"
    operator: "Equal"
    value: "aify"
    effect: "NoSchedule"

config:
  clients:
    - url: http://goyo-loki-distributed-gateway.monitoring.svc.cluster.local:80/loki/api/v1/push
  
  positions:
    filename: /run/promtail/positions.yaml
    
  snippets:
    pipelineStages:
      # 1. CRI ë¡œê·¸ íŒŒì‹± (Kubernetes ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ ë¡œê·¸ í˜•ì‹)
      - cri: {}
      
      # 2. íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒì‹±
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      
      # 3. output í•„ë“œë¥¼ ì‹¤ì œ ë¡œê·¸ ë‚´ìš©ìœ¼ë¡œ ì‚¬ìš©
      - output:
          source: output
      
      # 4. ë¡œê·¸ ë ˆë²¨ ì¶”ì¶œ (labelë¡œ ì¶”ê°€ - low cardinality)
      - regex:
          expression: '^\d{2}:\d{2}:\d{2}\.\d{3}\s+(?P<level>DEBUG|INFO|WARN|ERROR|FATAL)\s+'
      - labels:
          level:
      
      # 5. ì—ëŸ¬ ë¡œê·¸ êµ¬ë¶„ (labelë¡œ ì¶”ê°€ - low cardinality)
      - match:
          selector: '{job=~".+"} |~ "^ğŸš¨.*"'
          stages:
            - static_labels:
                error_flag: "true"
      
      # âš ï¸ ì¤‘ìš”: trace_idì™€ span_idëŠ” labelë¡œ ì¶”ê°€í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!
      # ì´ìœ :
      # 1. High cardinalityë¡œ ì¸í•œ Loki ì„±ëŠ¥ ì €í•˜ ë°©ì§€
      # 2. Grafana Derived Fieldsê°€ ë¡œê·¸ ë‚´ìš©ì—ì„œ ì§ì ‘ ì¶”ì¶œí•˜ë„ë¡ í•¨
      # 3. ë¡œê·¸ í…ìŠ¤íŠ¸ ìì²´ì— [traceId spanId] í˜•ì‹ìœ¼ë¡œ ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆìŒ
          
  scrape_configs:
    - job_name: kubernetes-pods
      kubernetes_sd_configs:
        - role: pod
      
      relabel_configs:
        # ê¸°ë³¸ ì¿ ë²„ë„¤í‹°ìŠ¤ ë©”íƒ€ë°ì´í„°ë¥¼ Loki ë ˆì´ë¸”ë¡œ ë³€í™˜
        - source_labels: [__meta_kubernetes_namespace]
          target_label: namespace
        
        - source_labels: [__meta_kubernetes_pod_name]
          target_label: pod
        
        - source_labels: [__meta_kubernetes_pod_container_name]
          target_label: container
        
        - source_labels: [__meta_kubernetes_pod_node_name]
          target_label: node_name
        
        # app ë ˆì´ë¸” ì¶”ê°€ (ì˜ˆ: dev-goyoai-backend-portal)
        - source_labels: [__meta_kubernetes_pod_label_app]
          target_label: app
        
        # Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ íŠ¹í™” ë ˆì´ë¸”
        - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
          target_label: service_name
        
        - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_instance]
          target_label: service_instance
        
        # ëª¨ë“  pod ë ˆì´ë¸”ì„ Loki ë ˆì´ë¸”ë¡œ ë§¤í•‘
        # ì˜ˆ: app.kubernetes.io/version -> app_kubernetes_io_version
        - action: labelmap
          regex: __meta_kubernetes_pod_label_(.+)
        
        # ë¡œê·¸ íŒŒì¼ ê²½ë¡œ ì„¤ì •
        - action: replace
          source_labels: [__meta_kubernetes_pod_uid, __meta_kubernetes_pod_container_name]
          separator: /
          target_label: __path__
          replacement: /var/log/pods/*$1/*.log
        
        # ì„ íƒì‚¬í•­: íŠ¹ì • ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë§Œ ìˆ˜ì§‘í•˜ë ¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
        # - source_labels: [__meta_kubernetes_namespace]
        #   regex: 'goyoai-web'
        #   action: keep
        
        # ì„ íƒì‚¬í•­: íŠ¹ì • ì•±ë§Œ ìˆ˜ì§‘í•˜ë ¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
        # - source_labels: [__meta_kubernetes_pod_label_app]
        #   regex: '.*goyoai.*'
        #   action: keep

networkPolicy:
  enabled: false