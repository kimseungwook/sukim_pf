# templates/backend-manifest-push.yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: {{ .Values.project_name }}-manifest
  namespace: tekton-pipelines
spec:
  params:
    - name: container-registry-url
      type: string
    - name: commit-message
      type: string
    - name: kustomize-giturl
      type: string
      default: {{ .Values.kustomize_git_url }}
    - name: project-name
      type: string
      default: {{ .Values.project_name }}
    - name: timestamp
      type: string
    - name: git-short-sha
      type: string
    - name: module-name
      type: string
      description: "The module name to build"
    - name: back-kustomize-directory
      type: string
      default: "{{ .Values.back_kustomize_directory }}"
    - name: back-deployment-name
      type: string
      default: "{{ .Values.back_deployment_name }}"
    - name: back-kustomize-branch
      type: string
      default: "{{ .Values.back_kustomize_git_branch }}"
  workspaces:
    - name: {{ .Values.project_name }}
  steps:
    - name: clean-and-setup-workspace
      image: gdhb.goyoai.com/common/git:2.45.2 # git이 포함된 이미지 사용
      script: |
        #!/bin/sh
        set -e
        
        WORKSPACE_PATH=$(workspaces.{{ .Values.project_name }}.path)
        PROJECT_DIR=$WORKSPACE_PATH/$(params.project-name)-manifest
        
        # Workspace 정리
        rm -rf $PROJECT_DIR
        mkdir -p $PROJECT_DIR
        echo "Workspace cleaned and prepared at $PROJECT_DIR"

        # Git 설정 및 클론
        KUSTOMIZE_BRANCH="$(params.back-kustomize-branch)"
        git config --global user.name "goyoai-tekton-ci"
        git config --global user.email "ci@goyoai.com"
        echo "Cloning manifest repository branch: $KUSTOMIZE_BRANCH"
        git clone --branch $KUSTOMIZE_BRANCH $(params.kustomize-giturl) $PROJECT_DIR
        
        cd $PROJECT_DIR

        # 패치 파일 생성
        KUSTOMIZE_DIR="$(params.back-kustomize-directory)"
        DEPLOYMENT_NAME="$(params.back-deployment-name)"
        OVERLAY_PATH="$PROJECT_DIR/$KUSTOMIZE_DIR"
        
        mkdir -p $OVERLAY_PATH
        
        echo "Creating deployment patch at $OVERLAY_PATH/deployment_patches.yaml"
        cat <<EOF > $OVERLAY_PATH/deployment_patches.yaml
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: $DEPLOYMENT_NAME
        spec:
          template:
            spec:
              serviceAccountName: goyoai-vault-sa
              containers:
                - name: ${DEPLOYMENT_NAME}-container
                  image: $(params.container-registry-url)/$(params.module-name):$(params.git-short-sha)-$(params.timestamp)
        EOF
        
        # Git 변경사항 커밋 및 푸시
        git add .
        # 변경 사항이 있을 때만 커밋 시도
        if ! git diff --staged --quiet; then
          COMMIT_MESSAGE="$(params.commit-message) with new image tag $(params.git-short-sha)-$(params.timestamp)"
          git commit -m "$COMMIT_MESSAGE"
          git push origin $KUSTOMIZE_BRANCH
          echo "✓ Manifest updated and pushed successfully."
        else
          echo "No changes to commit."
        fi

    - name: notify-slack
      image: {{ .Values.common_alpine_url }}
      script: |
        #!/bin/sh
        apk add --no-cache curl
        SLACK_WEBHOOK_URL="{{ .Values.slack_webhook_url }}"
        
        SLACK_MESSAGE="✓ Manifest Push complete for $(params.module-name)"
        curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"'"$SLACK_MESSAGE"'"}' \
        $SLACK_WEBHOOK_URL