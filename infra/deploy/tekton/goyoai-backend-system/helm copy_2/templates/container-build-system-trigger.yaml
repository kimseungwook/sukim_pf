# templates/container-build-system-trigger.yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: {{ .Values.system_build_task_name }}-trigger
  namespace: tekton-pipelines
spec:
  description: >-
    This Task triggers a Kaniko Job on Virtual Node and waits for completion.
  params:
    - name: container-registry-url
      type: string
    - name: container-registry-cache-url
      type: string
    - name: timestamp
      type: string
    - name: project-name
      type: string
      default: {{ .Values.project_name }}
    - name: git-short-sha
      type: string
    - name: module-name
      type: string
      description: "The module to build"
    - name: dockerfile-name
      type: string
    - name: giturl
      type: string
    - name: revision
      type: string
  
  workspaces:
    - name: {{ .Values.project_name }}
      description: Not used, but kept for compatibility
  
  results:
    - name: image-url
      description: The built image URL
  
  steps:
    - name: create-kaniko-job
      image: bitnami/kubectl:latest
      script: |
        #!/bin/sh
        set -e
        
        JOB_NAME="kaniko-build-$(params.module-name)-$(params.timestamp)"
        
        # Create Job manifest (--validate=false to avoid FIPS error)
        cat <<EOF | kubectl apply --validate=false -f -
        apiVersion: batch/v1
        kind: Job
        metadata:
          name: ${JOB_NAME}
          namespace: tekton-pipelines
          labels:
            tekton-trigger: "true"
            job-name: ${JOB_NAME} # ⬅️ 로그 조회를 위해 job-name 레이블 추가
            module: $(params.module-name)
        spec:
          ttlSecondsAfterFinished: 3600
          backoffLimit: 2
          template:
            metadata:
              labels:
                app: kaniko-build
                job-name: ${JOB_NAME} # ⬅️ 로그 조회를 위해 job-name 레이블 추가
                module: $(params.module-name)
            spec:
              nodeSelector:
                workload-type: tekton-build
              tolerations:
              - key: workload
                operator: Equal
                value: tekton-build
                effect: NoSchedule
              restartPolicy: Never
              serviceAccountName: tekton-ci-token
              containers:
              - name: kaniko-build
                image: gdhb.goyoai.com/common/kaniko-git:v1.23.2
                command:
                - /busybox/sh
                - -c
                - |
                  #!/bin/sh
                  set -e
                  
                  echo "=== Starting Build Process ==="
                  
                  # Git Credential 설정
                  echo "Setting up Git credentials..."
                  if [ -f /secrets/git-token/username ] && [ -f /secrets/git-token/password ]; then
                    GIT_USERNAME=\$(cat /secrets/git-token/username)
                    GIT_PASSWORD=\$(cat /secrets/git-token/password)
                    git config --global credential.helper store
                    mkdir -p /root
                    echo "https://\${GIT_USERNAME}:\${GIT_PASSWORD}@github.com" > /root/.git-credentials
                    chmod 600 /root/.git-credentials
                    echo "✓ Git credentials configured"
                  else
                    echo "⚠ Warning: Git credentials not found"
                  fi
                  
                  # Git Clone
                  echo "Cloning repository..."
                  git config --global user.name "Tekton CI"
                  git config --global user.email "ci@goyoai.com"
                  git config --global --add safe.directory /workspace
                  git clone -b $(params.revision) $(params.giturl) /workspace
                  cd /workspace
                  echo "✓ Cloned successfully"
                  
                  # Kaniko Build
                  echo "Starting Kaniko build..."
                  /kaniko/executor \
                    --context=/workspace \
                    --dockerfile=/workspace/$(params.dockerfile-name) \
                    --destination=$(params.container-registry-url)/$(params.module-name):$(params.git-short-sha)-$(params.timestamp) \
                    --force \
                    --skip-tls-verify \
                    --skip-unused-stages \
                    --use-new-run \
                    --cache=true \
                    --cache-ttl=168h \
                    --cache-repo=$(params.container-registry-cache-url)/$(params.module-name) \
                    --cache-copy-layers \
                    --snapshot-mode=redo \
                    --compressed-caching=false \
                    --ignore-var-run \
                    --cleanup \
                    --cache-dir=/cache \
                    --verbosity=info
                  
                  echo "✓ Build complete"

                env:
                - name: GRADLE_USER_HOME
                  value: "/root/.gradle"
                - name: GRADLE_OPTS
                  value: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=2"
                volumeMounts:
                - name: workspace
                  mountPath: /workspace
                - name: docker-config
                  mountPath: /kaniko/.docker
                - name: kaniko-cache
                  mountPath: /cache
                - name: git-credentials
                  mountPath: /secrets/git-token
                  readOnly: true
                
                resources:
                  requests:
                    memory: "2Gi"
                    cpu: "1000m"
                  limits:
                    memory: "2Gi"
                    cpu: "1000m"
              volumes:
              - name: workspace
                emptyDir: {}
              - name: docker-config
                secret:
                  secretName: {{ .Values.container_registry_secretName }}
                  items:
                  - key: .dockerconfigjson
                    path: config.json
              - name: kaniko-cache
                emptyDir: {}
              - name: git-credentials
                secret:
                  secretName: git-token
        EOF
        
        echo "Job ${JOB_NAME} created successfully"
        echo "${JOB_NAME}" > /tmp/job-name
      volumeMounts:
        - name: job-info
          mountPath: /tmp
    
    - name: wait-for-job
      image: bitnami/kubectl:latest
      script: |
        #!/bin/sh
        set -e
        
        JOB_NAME=$(cat /tmp/job-name)
        
        echo "Waiting for Job ${JOB_NAME} to complete..."
        
        TIMEOUT=1800
        ELAPSED=0
        INTERVAL=10
        
        while [ $ELAPSED -lt $TIMEOUT ]; do
          STATUS=$(kubectl get job ${JOB_NAME} -n tekton-pipelines -o jsonpath='{.status.conditions[?(@.type=="Complete")].status}' 2>/dev/null || echo "")
          FAILED=$(kubectl get job ${JOB_NAME} -n tekton-pipelines -o jsonpath='{.status.conditions[?(@.type=="Failed")].status}' 2>/dev/null || echo "")
          
          if [ "$STATUS" = "True" ]; then
            echo "Job completed successfully!"
            echo "$(params.container-registry-url)/$(params.module-name):$(params.git-short-sha)-$(params.timestamp)" > $(results.image-url.path)
            exit 0
          fi
          
          if [ "$FAILED" = "True" ]; then
            echo "Job failed! Fetching logs..."
            # Job 이름으로 파드를 찾아서 로그를 가져옵니다.
            kubectl logs -n tekton-pipelines -l job-name=${JOB_NAME} --tail=100
            exit 1
          fi
          
          echo "Job still running... (${ELAPSED}s / ${TIMEOUT}s)"
          sleep $INTERVAL
          ELAPSED=$((ELAPSED + INTERVAL))
        done
        
        echo "Job timed out after ${TIMEOUT} seconds"
        exit 1
      volumeMounts:
        - name: job-info
          mountPath: /tmp
  
  volumes:
    - name: job-info
      emptyDir: {}