# ëª¨ë“ˆí™”ëœ ë™ì  íŠ¸ë¦¬ê±° í…œí”Œë¦¿ (aify ì œê±°)
# templates/triggers.yaml
# ===================================================================

# TriggerBinding - ëª¨ë“  ëª¨ë“ˆì—ì„œ ê³µí†µ ì‚¬ìš©
---
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: {{ .Values.global.project_name }}
  namespace: tekton-pipelines
  labels:
    {{- include "backend-system.labels" . | nindent 4 }}
    type: trigger-binding
  annotations:
    description: "GitHub ì›¹í›… ì´ë²¤íŠ¸ë¥¼ Tekton íŒŒë¼ë¯¸í„°ë¡œ ë°”ì¸ë”©"
spec:
  params:
    - name: gitrevision
      value: $(extensions.branch_name)
      description: "Git ë¸Œëœì¹˜ëª…"
    - name: gitrepositoryurl
      value: $(body.repository.clone_url)
      description: "Git ì €ì¥ì†Œ URL"
    - name: git-repo-name
      value: $(body.repository.name)
      description: "Git ì €ì¥ì†Œ ì´ë¦„"
    - name: git-sha
      value: $(extensions.sha)
      description: "Git ì»¤ë°‹ SHA"
    - name: git-short-sha
      value: $(extensions.short_sha)
      description: "Git ì§§ì€ SHA"
    - name: module-name
      value: $(extensions.module_name)
      description: "ë¹Œë“œí•  ëª¨ë“ˆ ì´ë¦„"
    - name: dockerfile-name
      value: $(extensions.dockerfile_name)
      description: "ì‚¬ìš©í•  Dockerfile ì´ë¦„"
    - name: pvc-name
      value: $(extensions.pvc_name)
      description: "ì‚¬ìš©í•  PVC ì´ë¦„"

# TriggerTemplate - ë™ì  íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
---
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: {{ .Values.global.project_name }}
  namespace: tekton-pipelines
  labels:
    {{- include "backend-system.labels" . | nindent 4 }}
    type: trigger-template
  annotations:
    description: "íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ì„ ìœ„í•œ ë™ì  í…œí”Œë¦¿"
spec:
  params:
    - name: gitrevision
      description: "Git ë¸Œëœì¹˜ëª…"
    - name: gitrepositoryurl
      description: "Git ì €ì¥ì†Œ URL"
    - name: git-repo-name
      description: "Git ì €ì¥ì†Œ ì´ë¦„"
    - name: git-sha
      description: "Git ì»¤ë°‹ SHA"
    - name: git-short-sha
      description: "Git ì§§ì€ SHA"
    - name: module-name
      description: "ë¹Œë“œí•  ëª¨ë“ˆ ì´ë¦„"
    - name: dockerfile-name
      description: "ì‚¬ìš©í•  Dockerfile ì´ë¦„"
    - name: pvc-name
      description: "ì‚¬ìš©í•  PVC ì´ë¦„"
  
  resourcetemplates:
    # ë™ì  PipelineRun ìƒì„±
    - apiVersion: tekton.dev/v1beta1
      kind: PipelineRun
      metadata:
        generateName: $(tt.params.git-repo-name)-$(tt.params.gitrevision)-
        namespace: tekton-pipelines
        labels:
          {{- include "backend-system.labels" . | nindent 10 }}
          pipeline-type: "ci-cd"
          git-branch: $(tt.params.gitrevision)
          module: $(tt.params.module-name)
        annotations:
          triggers.tekton.dev/git-sha: $(tt.params.git-sha)
          triggers.tekton.dev/git-branch: $(tt.params.gitrevision)
          triggers.tekton.dev/module: $(tt.params.module-name)
      spec:
        # ëª¨ë“ˆëª… ê¸°ë°˜ìœ¼ë¡œ ë™ì  íŒŒì´í”„ë¼ì¸ ì„ íƒ
        pipelineRef:
          name: |
            {{- range $moduleName, $moduleConfig := .Values.modules }}
            {{- if $moduleConfig.enabled }}
            {{- if eq $moduleName "system" }}
            goyoai-gointern-system
            {{- else if eq $moduleName "portal" }}
            goyoai-gointern-portal
            {{- end }}
            {{- end }}
            {{- end }}
        
        # íŒŒë¼ë¯¸í„° ì „ë‹¬
        params:
          - name: giturl
            value: $(tt.params.gitrepositoryurl)
          - name: container-registry-url
            value: {{ .Values.global.registry.url }}
          - name: container-registry-cache-url
            value: {{ .Values.global.registry.cache_url }}
          - name: revision
            value: $(tt.params.gitrevision)
          - name: manifest-file-name
            value: {{ .Values.global.kustomize.manifestFileName }}
          - name: commit-message
            value: {{ .Values.global.kustomize.commitMessage }}
          - name: project-name
            value: {{ .Values.global.project_name }}
          - name: git-short-sha
            value: $(tt.params.git-short-sha)
          - name: module-name
            value: $(tt.params.module-name)
          - name: dockerfile-name
            value: $(tt.params.dockerfile-name)
        
        # ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì„¤ì •
        workspaces:
          - name: {{ .Values.global.project_name }}
            persistentVolumeClaim:
              claimName: $(tt.params.pvc-name)
        
        # ìŠ¤ì¼€ì¤„ë§ ë° ë¦¬ì†ŒìŠ¤ ì„¤ì •
        podTemplate:
          nodeSelector:
            {{- toYaml .Values.pipeline.nodeSelector | nindent 12 }}
          tolerations:
            {{- toYaml .Values.pipeline.tolerations | nindent 12 }}
          securityContext:
            {{- toYaml .Values.security.podSecurityContext | nindent 12 }}
        
        # íƒ€ì„ì•„ì›ƒ ì„¤ì •
        timeouts:
          pipeline: {{ .Values.pipeline.timeouts.pipeline }}
          tasks: {{ .Values.pipeline.timeouts.tasks }}
          finally: {{ .Values.pipeline.timeouts.finally }}
        
        # ì„œë¹„ìŠ¤ ì–´ì¹´ìš´íŠ¸
        serviceAccountName: {{ .Values.serviceAccounts.git }}

# ===================================================================
# ğŸ“Š íŠ¸ë¦¬ê±° êµ¬ì„± ìš”ì•½
# ===================================================================
# 
# ğŸ”— TriggerBinding: {{ .Values.global.project_name }}
# - GitHub ì›¹í›… ì´ë²¤íŠ¸ë¥¼ Tekton íŒŒë¼ë¯¸í„°ë¡œ ë³€í™˜
# - ë™ì  ëª¨ë“ˆ ê°ì§€ ë° ë§¤í•‘ ì§€ì›
# 
# ğŸ“‹ TriggerTemplate: {{ .Values.global.project_name }}
# - PipelineRun ë™ì  ìƒì„±
# - ëª¨ë“ˆë³„ íŒŒì´í”„ë¼ì¸ ìë™ ì„ íƒ
# - PVC, ìŠ¤ì¼€ì¤„ë§, ë³´ì•ˆ ì„¤ì • ì ìš©
# 
# ğŸ¯ ì§€ì› ëª¨ë“ˆ:
{{- range $moduleName, $moduleConfig := .Values.modules }}
{{- if $moduleConfig.enabled }}
# - {{ title $moduleName }}: {{ $moduleConfig.git.branch }} â†’ goyoai-gointern-{{ $moduleName }}
{{- end }}
{{- end }}
# 
# EventListenerì™€ ì—°ë™í•˜ì—¬ ì™„ì „í•œ CI/CD íŠ¸ë¦¬ê±° ì²´ì¸ êµ¬ì„±
# ===================================================================
