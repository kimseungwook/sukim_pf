# ëª¨ë“ˆí™”ëœ ë™ì  íƒœìŠ¤í¬ í…œí”Œë¦¿ (aify ì œê±°, ìµœì í™”)
# templates/tasks.yaml
# ===================================================================

# ===================================================================
# ðŸ”§ ê³µí†µ íƒœìŠ¤í¬ë“¤ (ëª¨ë“  ëª¨ë“ˆì—ì„œ ì‚¬ìš©)
# ===================================================================

# íƒ€ìž„ìŠ¤íƒ¬í”„ ìƒì„± íƒœìŠ¤í¬
# ---
# apiVersion: tekton.dev/v1beta1
# kind: Task
# metadata:
#   name: generate-timestamp
#   namespace: tekton-pipelines
#   labels:
#     {{- include "backend-system.labels" . | nindent 4 }}
#     type: utility
#   annotations:
#     description: "í˜„ìž¬ íƒ€ìž„ìŠ¤íƒ¬í”„ë¥¼ ìƒì„±í•˜ì—¬ ì´ë¯¸ì§€ íƒœê¹…ì— ì‚¬ìš©"
# spec:
#   params:
#     - name: project-name
#       type: string
#       description: "í”„ë¡œì íŠ¸ ì´ë¦„"
#   results:
#     - name: timestamp
#       description: "Generated timestamp"
#   steps:
#     - name: generate
#       image: {{ .Values.global.images.alpine }}
#       script: |
#         #!/bin/sh
#         set -e
#         TIMESTAMP=$(date +%Y%m%d-%H%M%S)
#         echo "Generated timestamp: $TIMESTAMP"
#         echo -n "$TIMESTAMP" | tee $(results.timestamp.path)

# Git Clone íƒœìŠ¤í¬
---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: {{ .Values.global.project_name }}-git-clone
  namespace: tekton-pipelines
  labels:
    {{- include "backend-system.labels" . | nindent 4 }}
    type: git-clone
  annotations:
    description: "Git ì €ìž¥ì†Œ í´ë¡  ë° ì›Œí¬ìŠ¤íŽ˜ì´ìŠ¤ ì •ë¦¬"
spec:
  workspaces:
    - name: {{ .Values.global.project_name }}
      description: "ê³µìœ  ì›Œí¬ìŠ¤íŽ˜ì´ìŠ¤"
  params:
    - name: revision
      type: string
      description: "Git revision (branch/tag/commit)"
    - name: giturl
      type: string
      description: "Git repository URL"
    - name: project-name
      type: string
      description: "í”„ë¡œì íŠ¸ ì´ë¦„"
    - name: module-name
      type: string
      description: "ëª¨ë“ˆ ì´ë¦„"
  results:
    - name: commit
      description: "Git commit hash"
  steps:
    - name: clean-workspace
      image: {{ .Values.global.images.alpine }}
      script: |
        #!/bin/sh
        echo "ðŸ§¹ ì›Œí¬ìŠ¤íŽ˜ì´ìŠ¤ ì •ë¦¬ ì¤‘..."
        cd $(workspaces.{{ .Values.global.project_name }}.path)
        rm -rf .git || true
        rm -rf * || true
        rm -rf .* 2>/dev/null || true
        echo "âœ… ì›Œí¬ìŠ¤íŽ˜ì´ìŠ¤ ì •ë¦¬ ì™„ë£Œ"
      
    - name: clone
      image: {{ .Values.global.images.alpine_git }}
      script: |
        #!/bin/sh
        set -e
        echo "ðŸ“‚ Git ì €ìž¥ì†Œ í´ë¡  ì‹œìž‘..."
        echo "  Repository: $(params.giturl)"
        echo "  Revision: $(params.revision)"
        echo "  Module: $(params.module-name)"
        
        cd $(workspaces.{{ .Values.global.project_name }}.path)
        git clone $(params.giturl) .
        git checkout $(params.revision)
        
        COMMIT_SHA=$(git rev-parse HEAD)
        echo "âœ… í´ë¡  ì™„ë£Œ: $COMMIT_SHA"
        echo -n "$COMMIT_SHA" | tee $(results.commit.path)

{{- range $moduleName, $moduleConfig := .Values.modules }}
{{- if $moduleConfig.enabled }}
# ===================================================================
# ðŸ”¹ {{ upper $moduleName }} ëª¨ë“ˆ ì´ë¯¸ì§€ ë¹Œë“œ íƒœìŠ¤í¬
# ===================================================================
---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: {{ $moduleConfig.taskName }}
  namespace: tekton-pipelines
  labels:
    {{- include "backend-system.labels" $ | nindent 4 }}
    module: {{ $moduleName }}
    type: image-build
  annotations:
    description: "{{ title $moduleName }} ëª¨ë“ˆ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ (Gradle + Kaniko)"
spec:
  workspaces:
    - name: {{ $.Values.global.project_name }}
      description: "ì†ŒìŠ¤ ì½”ë“œ ì›Œí¬ìŠ¤íŽ˜ì´ìŠ¤"
    - name: {{ $moduleName }}-gradle-cache
      description: "Gradle ìºì‹œ ({{ title $moduleName }})"
      mountPath: /cache
  params:
    - name: container-registry-url
      type: string
      description: "ì»¨í…Œì´ë„ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ URL"
    - name: container-registry-cache-url
      type: string
      description: "ì»¨í…Œì´ë„ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ìºì‹œ URL"
    - name: project-name
      type: string
      description: "í”„ë¡œì íŠ¸ ì´ë¦„"
    - name: timestamp
      type: string
      description: "ë¹Œë“œ íƒ€ìž„ìŠ¤íƒ¬í”„"
    - name: git-short-sha
      type: string
      description: "Git ì§§ì€ SHA"
    - name: module-name
      type: string
      description: "ëª¨ë“ˆ ì´ë¦„"
    - name: dockerfile-name
      type: string
      description: "Dockerfile ì´ë¦„"
  steps:
    - name: build-and-push
      image: {{ $.Values.global.images.kaniko }}
      args:
        {{- range $.Values.build.kaniko.args }}
        - {{ . }}
        {{- end }}
        - --context=dir://$(workspaces.{{ $.Values.global.project_name }}.path)
        - --dockerfile=$(workspaces.{{ $.Values.global.project_name }}.path)/$(params.dockerfile-name)
        - --destination=$(params.container-registry-url)/$(params.module-name):$(params.timestamp)-$(params.git-short-sha)
        - --cache-repo=$(params.container-registry-cache-url)/$(params.module-name)
      env:
        - name: GRADLE_USER_HOME
          value: {{ $.Values.build.gradle.userHome }}
        - name: GRADLE_OPTS
          value: {{ $.Values.build.gradle.opts }}
      volumeMounts:
        - name: docker-config
          mountPath: /kaniko/.docker
          readOnly: true
  volumes:
    - name: docker-config
      secret:
        secretName: {{ $.Values.global.registry.secret }}
        items:
          - key: .dockerconfigjson
            path: config.json
  sidecars:
    - name: gradle-cache-warmer
      image: {{ $.Values.global.images.alpine }}
      script: |
        #!/bin/sh
        echo "ðŸ”¥ {{ title $moduleName }} Gradle ìºì‹œ ì›Œë°ì—…..."
        mkdir -p /cache/gradle-home
        chmod 755 /cache/gradle-home
        echo "âœ… ìºì‹œ ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì™„ë£Œ"
      volumeMounts:
        - name: {{ $moduleName }}-gradle-cache
          mountPath: /cache

{{- end }}
{{- end }}

# Manifest ì—…ë°ì´íŠ¸ íƒœìŠ¤í¬
---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: {{ .Values.global.project_name }}-manifest
  namespace: tekton-pipelines
  labels:
    {{- include "backend-system.labels" . | nindent 4 }}
    type: manifest-update
  annotations:
    description: "Kubernetes Manifest ì—…ë°ì´íŠ¸ ë° Git í‘¸ì‹œ"
spec:
  workspaces:
    - name: {{ .Values.global.project_name }}
      description: "ìž‘ì—… ì›Œí¬ìŠ¤íŽ˜ì´ìŠ¤"
  params:
    - name: manifest-file-name
      type: string
      description: "ì—…ë°ì´íŠ¸í•  ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ íŒŒì¼ëª…"
    - name: container-registry-url
      type: string
      description: "ì»¨í…Œì´ë„ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ URL"
    - name: commit-message
      type: string
      description: "Git ì»¤ë°‹ ë©”ì‹œì§€"
    - name: revision
      type: string
      description: "ì†ŒìŠ¤ ë¸Œëžœì¹˜"
    - name: project-name
      type: string
      description: "í”„ë¡œì íŠ¸ ì´ë¦„"
    - name: timestamp
      type: string
      description: "ë¹Œë“œ íƒ€ìž„ìŠ¤íƒ¬í”„"
    - name: git-short-sha
      type: string
      description: "Git ì§§ì€ SHA"
    - name: module-name
      type: string
      description: "ëª¨ë“ˆ ì´ë¦„"
  steps:
    - name: update-manifest
      image: {{ .Values.global.images.alpine_git }}
      script: |
        #!/bin/sh
        set -e
        
        echo "ðŸ“ Kubernetes Manifest ì—…ë°ì´íŠ¸ ì‹œìž‘..."
        echo "  íŒŒì¼: $(params.manifest-file-name)"
        echo "  ëª¨ë“ˆ: $(params.module-name)"
        echo "  ì´ë¯¸ì§€ íƒœê·¸: $(params.timestamp)-$(params.git-short-sha)"
        
        cd $(workspaces.{{ .Values.global.project_name }}.path)
        
        # Manifest ì €ìž¥ì†Œ í´ë¡ 
        rm -rf manifest-repo
        git clone {{ .Values.global.kustomize.gitUrl }} manifest-repo
        cd manifest-repo
        
        # ëª¨ë“ˆë³„ Kustomize ë””ë ‰í† ë¦¬ ë™ì  ê²°ì •
        {{- range $moduleName, $moduleConfig := .Values.modules }}
        {{- if $moduleConfig.enabled }}
        if [ "$(params.module-name)" = "{{ $moduleConfig.build.moduleName }}" ]; then
          KUSTOMIZE_DIR="{{ $moduleConfig.kustomize.directory }}"
          DEPLOYMENT_NAME="{{ $moduleConfig.kustomize.deploymentName }}"
          KUSTOMIZE_BRANCH="{{ $moduleConfig.kustomize.branch }}"
        fi
        {{- end }}
        {{- end }}
        
        git checkout $KUSTOMIZE_BRANCH
        cd $KUSTOMIZE_DIR
        
        # ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
        NEW_IMAGE="$(params.container-registry-url)/$(params.module-name):$(params.timestamp)-$(params.git-short-sha)"
        echo "ðŸ”„ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸: $NEW_IMAGE"
        
        # kustomization.yamlì—ì„œ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
        if [ -f kustomization.yaml ]; then
          # ê¸°ì¡´ ì´ë¯¸ì§€ ë¼ì¸ ì°¾ì•„ì„œ êµì²´
          sed -i "s|newTag:.*|newTag: $(params.timestamp)-$(params.git-short-sha)|g" kustomization.yaml
          echo "âœ… kustomization.yaml ì—…ë°ì´íŠ¸ ì™„ë£Œ"
        else
          echo "âŒ kustomization.yaml íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          exit 1
        fi
        
        # ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        git config user.name "Tekton Pipeline"
        git config user.email "tekton@goyoai.com"
        git add .
        
        if git diff --staged --quiet; then
          echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
        else
          git commit -m "$(params.commit-message) [$(params.module-name):$(params.timestamp)-$(params.git-short-sha)]"
          git push origin $KUSTOMIZE_BRANCH
          echo "âœ… Manifest ì—…ë°ì´íŠ¸ ë° í‘¸ì‹œ ì™„ë£Œ"
        fi

# Slack ì•Œë¦¼ íƒœìŠ¤í¬
---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: slack-notification
  namespace: tekton-pipelines
  labels:
    {{- include "backend-system.labels" . | nindent 4 }}
    type: notification
  annotations:
    description: "Slack ì±„ë„ë¡œ ë¹Œë“œ ê²°ê³¼ ì•Œë¦¼ ì „ì†¡"
spec:
  params:
    - name: webhook-url
      type: string
      description: "Slack ì›¹í›… URL"
    - name: message
      type: string
      description: "ì „ì†¡í•  ë©”ì‹œì§€"
    - name: status
      type: string
      description: "ë¹Œë“œ ìƒíƒœ"
      default: "Unknown"
  steps:
    - name: send-notification
      image: {{ .Values.global.images.alpine }}
      script: |
        #!/bin/sh
        set -e
        
        # ìƒíƒœì— ë”°ë¥¸ ì´ëª¨ì§€ ì„¤ì •
        case "$(params.status)" in
          "Succeeded") EMOJI="âœ…" COLOR="good" ;;
          "Failed") EMOJI="âŒ" COLOR="danger" ;;
          *) EMOJI="âš ï¸" COLOR="warning" ;;
        esac
        
        echo "ðŸ“¢ Slack ì•Œë¦¼ ì „ì†¡ ì¤‘..."
        
        # Slack ë©”ì‹œì§€ payload ìƒì„±
        cat > /tmp/payload.json << EOF
        {
          "attachments": [
            {
              "color": "$COLOR",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "$EMOJI Tekton Pipeline ê²°ê³¼"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "$(params.message)"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "*ìƒíƒœ:* $(params.status) | *ì‹œê°„:* $(date)"
                    }
                  ]
                }
              ]
            }
          ]
        }
        EOF
        
        # Slack ì›¹í›…ìœ¼ë¡œ ì „ì†¡
        if [ -n "$(params.webhook-url)" ]; then
          apk add --no-cache curl
          curl -X POST -H 'Content-type: application/json' \
            --data @/tmp/payload.json \
            "$(params.webhook-url)"
          echo "âœ… Slack ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"
        else
          echo "âš ï¸ Slack ì›¹í›… URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
        fi

# ===================================================================
# ðŸ“Š ìƒì„±ëœ íƒœìŠ¤í¬ ìš”ì•½ ì •ë³´
# ===================================================================
# 
# ðŸ”§ ê³µí†µ íƒœìŠ¤í¬:
# 1. generate-timestamp - íƒ€ìž„ìŠ¤íƒ¬í”„ ìƒì„±
# 2. {{ .Values.global.project_name }}-git-clone - Git í´ë¡ 
# 3. {{ .Values.global.project_name }}-manifest - Manifest ì—…ë°ì´íŠ¸
# 4. slack-notification - Slack ì•Œë¦¼
# 
# ðŸ”¹ ëª¨ë“ˆë³„ ë¹Œë“œ íƒœìŠ¤í¬:
{{- range $moduleName, $moduleConfig := .Values.modules }}
{{- if $moduleConfig.enabled }}
# - {{ $moduleConfig.taskName }} ({{ title $moduleName }} ëª¨ë“ˆ)
{{- end }}
{{- end }}
# 
# ê° íƒœìŠ¤í¬ëŠ” ë…¸ë“œ ìŠ¤ì¼€ì¤„ë§, ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸, ë¦¬ì†ŒìŠ¤ ì œí•œ ì ìš©
# PVCë¥¼ í†µí•œ ì›Œí¬ìŠ¤íŽ˜ì´ìŠ¤ ë° ìºì‹œ ê³µìœ 
# ===================================================================
