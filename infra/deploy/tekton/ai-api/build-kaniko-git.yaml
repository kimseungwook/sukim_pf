apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: goyoai-ai-server-image-build
  namespace: tekton-pipelines
  labels:
    app.kubernetes.io/version: "0.6"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Image Build
    tekton.dev/tags: image-build
    tekton.dev/displayName: "Build and upload container image using Kaniko"
    tekton.dev/platforms: "linux/amd64,linux/arm64,linux/ppc64le"
spec:
  description: >-
    This Task builds a simple Dockerfile with kaniko and pushes to a registry.
    This Task stores the image name and digest as results, allowing Tekton Chains to pick up
    that an image was built & sign it.
  params:
    - name: ocir-url
      type: string
    - name: ocir-cache-url
      type: string
    - name: timestamp
      type: string
    - name: project-name
      type: string
      default: goyoai-ai-server
    - name: git-short-sha
      type: string
    - name: EXTRA_ARGS
      type: array
      default: []
  workspaces:
    - name: goyoai-ai-server
      description: Holds the context and Dockerfile
    - name: dockerconfig
      description: Includes a docker `config.json`
      optional: true
      mountPath: /kaniko/.docker

  # results:
  #   - name: IMAGE_DIGEST
  #     description: Digest of the image just built.
  #   - name: IMAGE_URL
  #     description: URL of the image just built.

  steps:
    - name: list-files
      image: icn.ocir.io/cn7ipyag4bte/alpine-linux:64.3.19.1
      # image: alpine
      script: |
        #!/bin/sh
        WORKSPACE_PATH=$(workspaces.goyoai-ai-server.path)
        PROJECT_DIR=$WORKSPACE_PATH/$(params.project-name)-source
        echo "Listing files in $PROJECT_DIR :"
        ls -al $PROJECT_DIR
    # - name: build-start
    #   image: alpine
    #   script: |
    #     #!/bin/sh
    #     # Curl 설치
    #     apk add --no-cache curl
        
    #     # 슬랙 웹훅 URL
    #     SLACK_WEBHOOK_URL="https://hooks.slack.com/services/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"
        
    #     # 슬랙 메시지 내용
    #     SLACK_MESSAGE="$(params.project-name) Docker Build 시작"

    #     # 슬랙에 메시지 전송
    #     curl -X POST -H 'Content-type: application/json' \
    #     --data '{"text":"'"$SLACK_MESSAGE"'"}' \
    #     $SLACK_WEBHOOK_URL

    # - name: verify-docker-config-mount
    #   image: alpine
    #   script: |
    #     #!/bin/sh
    #     CONFIG_PATH="/kaniko/.docker/config.json"
    #     if [ -f "$CONFIG_PATH" ]; then
    #       echo "Found docker config at $CONFIG_PATH:"
    #       cat "$CONFIG_PATH"
    #     else
    #       echo "Docker config not found at $CONFIG_PATH."
    #       exit 1
    #     fi

    # - name: check-docker-config
    #   image: alpine
    #   script: |
    #     #!/bin/sh
    #     echo "Checking mounted Docker config at /kaniko/.docker/"
    #     ls -l /kaniko/.docker/
    #     if [ -f /kaniko/.docker/config.json ]; then
    #       echo "Docker config found:"
    #       cat /kaniko/.docker/config.json
    #     else
    #       echo "Docker config not found."
    #     fi

    - name: build-and-push
      # workingDir: $(workspaces.source.path)
      image: gcr.io/kaniko-project/executor:v1.5.1@sha256:c6166717f7fe0b7da44908c986137ecfeab21f31ec3992f6e128fff8a94be8a5
      command:
          - /kaniko/executor
      args:
        - --context=$(workspaces.goyoai-ai-server.path)/$(params.project-name)-source
        - --dockerfile=$(workspaces.goyoai-ai-server.path)/$(params.project-name)-source/dockerfile-dev
        - --destination=$(params.ocir-url):$(params.git-short-sha)-$(params.timestamp)
        # - --docker-config=/kaniko/.docker/
        - --force
        - --skip-tls-verify
        - --skip-unused-stages # 플래그는 최종 이미지에 필요하지 않은 빌드 단계 skip
        - --use-new-run
        - --cache=true
        - --cache-repo=$(params.ocir-cache-url)
        - --snapshotMode=redo
        - --build-arg=BUILDKIT_INLINE_CACHE=1
        # - --cache-copy-layers
      securityContext:
        runAsUser: 0
      resources:
        limits:
          cpu: 4
          memory: 26Gi
        requests:
          cpu: 2
          memory: 8Gi

    # - name: build-end
    #   image: alpine
    #   script: |
    #     #!/bin/sh
    #     # Curl 설치
    #     apk add --no-cache curl
    #     echo "Listing files in $(workspaces.goyoai-ai-server.path):"
    #     ls -al $(workspaces.goyoai-ai-server.path)
        
    #     # 슬랙 웹훅 URL
    #     SLACK_WEBHOOK_URL="https://hooks.slack.com/services/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"
        
    #     # 슬랙 메시지 내용
    #     SLACK_MESSAGE="$(params.project-name) ECR Docker Image Push 완료"

    #     # 슬랙에 메시지 전송
    #     curl -X POST -H 'Content-type: application/json' \
    #     --data '{"text":"'"$SLACK_MESSAGE"'"}' \
    #     $SLACK_WEBHOOK_URL