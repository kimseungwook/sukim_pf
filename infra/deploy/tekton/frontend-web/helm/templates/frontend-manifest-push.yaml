# Frontend Ï†ÑÏö© Manifest Push Task
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: {{ .Values.project_name }}-manifest
  namespace: tekton-pipelines
spec:
  params:
    - name: container-registry-url
      type: string
    - name: commit-message
      type: string
    - name: kustomize-giturl
      type: string
      default: {{ .Values.kustomize_git_url }}
    - name: project-name
      type: string
      default: {{ .Values.project_name }}
    - name: timestamp
      type: string
    - name: git-short-sha
      type: string
    - name: module-name  # app-nameÏùÑ module-nameÏúºÎ°ú Î∞õÏùå
      type: string
      description: "The frontend app name"
    # ‚úÖ Frontend Ï†ÑÏö© ÏÑ§Ï†ïÎì§
    - name: front-kustomize-directory
      type: string
      default: "{{ .Values.front_kustomize_directory }}"
    - name: front-deployment-name
      type: string
      default: "{{ .Values.front_deployment_name }}"
    - name: front-kustomize-branch
      type: string
      default: "{{ .Values.front_kustomize_git_branch }}"
      
  workspaces:
    - name: {{ .Values.project_name }}
    
  steps:
    - name: clean-workspace
      image: {{ .Values.common_alpine_url }}
      script: |
        #!/bin/sh
        WORKSPACE_PATH=$(workspaces.{{ .Values.project_name }}.path)
        PROJECT_DIR=$WORKSPACE_PATH/$(params.project-name)-manifest
        mkdir -p $PROJECT_DIR
        rm -rf $PROJECT_DIR/.[!.]* $PROJECT_DIR/*
        echo "Workspace cleaned at $PROJECT_DIR"
        
    - name: setup-kustomize-environment
      image: {{ .Values.common_alpine_git_url }}
      script: |
        #!/bin/sh
        set -e
        WORKSPACE_PATH=$(workspaces.{{ .Values.project_name }}.path)
        PROJECT_DIR=$WORKSPACE_PATH/$(params.project-name)-manifest
        GIT_ROOT_PATH=$PROJECT_DIR
        
        # ‚úÖ Frontend Ï†ÑÏö© Ï°∞Í±¥Î¨∏ (goyoai-gointern-webÎßå Ï≤òÎ¶¨)
        if [ "$(params.module-name)" = "goyoai-gointern-web" ]; then
          KUSTOMIZE_DIR="$(params.front-kustomize-directory)"
          DEPLOYMENT_NAME="$(params.front-deployment-name)"
          KUSTOMIZE_BRANCH="$(params.front-kustomize-branch)"
          echo "‚úÖ Frontend app detected: $(params.module-name)"
        else
          echo "‚ùå Unknown frontend module: $(params.module-name)"
          echo "Expected: goyoai-gointern-web"
          exit 1
        fi
        
        echo "üìÅ Kustomize directory: $KUSTOMIZE_DIR"
        echo "üöÄ Deployment name: $DEPLOYMENT_NAME"
        echo "üåø Branch: $KUSTOMIZE_BRANCH"
        
        # Git ÏÑ§Ï†ï
        git config --global user.name "goyoai"
        git config --global user.email "goyo-service_run@goyoai.com"
        
        # Îß§ÎãàÌéòÏä§Ìä∏ Ï†ÄÏû•ÏÜå ÌÅ¥Î°†/ÏóÖÎç∞Ïù¥Ìä∏
        if [ ! -d "$GIT_ROOT_PATH/.git" ]; then
          echo "üì• Cloning manifest repository..."
          git clone --branch $KUSTOMIZE_BRANCH $(params.kustomize-giturl) $GIT_ROOT_PATH
        else
          echo "üîÑ Updating existing repository..."
          git -C $GIT_ROOT_PATH fetch origin
          git -C $GIT_ROOT_PATH checkout $KUSTOMIZE_BRANCH || git -C $GIT_ROOT_PATH checkout -b $KUSTOMIZE_BRANCH
          git -C $GIT_ROOT_PATH reset --hard origin/$KUSTOMIZE_BRANCH
        fi
        
        # Kustomize Ìå®Ïπò ÏÉùÏÑ±
        OVERLAY_PATH="$GIT_ROOT_PATH/$KUSTOMIZE_DIR"
        mkdir -p $OVERLAY_PATH
        cd $OVERLAY_PATH
        
        echo "üìù Creating deployment patch..."
        cat <<EOF > deployment_patches.yaml
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: $DEPLOYMENT_NAME
        spec:
          template:
            spec:
              containers:
                - name: ${DEPLOYMENT_NAME}-container
                  image: $(params.container-registry-url)/$(params.module-name):$(params.git-short-sha)-$(params.timestamp)
                  env:
                    - name: APP_VERSION
                      value: "$(params.git-short-sha)-$(params.timestamp)"
                    - name: BUILD_TIME
                      value: "$(params.timestamp)"
        EOF
        
        echo "üìÑ Generated patch content:"
        cat deployment_patches.yaml
        
        # Git Ïª§Î∞ã Î∞è Ìë∏Ïãú
        git add deployment_patches.yaml
        COMMIT_MESSAGE="üöÄ $(params.commit-message) with image $(params.module-name):$(params.git-short-sha)-$(params.timestamp)"
        git commit -m "$COMMIT_MESSAGE"
        
        echo "‚¨ÜÔ∏è Pushing to remote repository..."
        git push --force-with-lease origin $KUSTOMIZE_BRANCH
        
        echo "‚úÖ Manifest update completed successfully!"
        
    - name: manifest-push-end
      image: {{ .Values.common_alpine_url }}
      script: |
        #!/bin/sh
        # Curl ÏÑ§Ïπò
        apk add --no-cache curl
        
        SLACK_WEBHOOK_URL="{{ .Values.slack_webhook_url }}"
        SLACK_MESSAGE="üéâ Frontend manifest updated - $(params.module-name):$(params.git-short-sha)-$(params.timestamp)"
        
        echo "üì¢ Sending Slack notification..."
        curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"'"$SLACK_MESSAGE"'"}' \
        $SLACK_WEBHOOK_URL
        
        echo "‚úÖ Notification sent successfully!"