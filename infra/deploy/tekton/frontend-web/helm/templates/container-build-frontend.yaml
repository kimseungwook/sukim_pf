# ğŸš€ goyoai-gointern-web ì „ìš© ìµœì í™” Tekton Task
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: {{ .Values.gointern_frontend_build_task_name }}
  namespace: tekton-pipelines
  annotations:
    tekton.dev/version: "2.0.0"
    description: "goyoai-gointern-web ë¹Œë“œ ìµœì í™” (ëª©í‘œ: 90-150ì´ˆ)"
spec:
  description: >-
    ğŸ¯ goyoai-gointern-web ë‹¨ì¼ ì•± ìµœì í™” ë¹Œë“œ
  params:
    - name: container-registry-url
      type: string
    - name: container-registry-cache-url
      type: string
    - name: timestamp
      type: string
    - name: project-name
      type: string
      default: {{ .Values.project_name }}
    - name: git-short-sha
      type: string
      
  workspaces:
    - name: {{ .Values.project_name }}
      description: TurboRepo workspace

  steps:
    # âœ… Step 1: ë¹ ë¥¸ ìºì‹œ ë¶„ì„
    - name: cache-analysis
      image: {{ .Values.common_alpine_url }}
      script: |
        #!/bin/sh
        echo "ğŸ“Š Cache Analysis for goyoai-gointern-web"
        
        # ì‹œì‘ ì‹œê°„ ê¸°ë¡
        echo $(date +%s) > /shared/build_start_time
        
        # ìºì‹œ ìƒíƒœ ë¶„ì„
        PNPM_FILES=$(find /workspace/pnpm-cache -type f 2>/dev/null | wc -l)
        TURBO_FILES=$(find /workspace/turbo-cache -type f 2>/dev/null | wc -l)
        
        # ì˜ˆìƒ ë¹Œë“œ ì‹œê°„
        if [ $PNPM_FILES -gt 1000 ]; then
          echo "ğŸš€ Excellent cache (90-120s expected)"
        elif [ $PNPM_FILES -gt 100 ]; then
          echo "ğŸ‘ Good cache (120-180s expected)"
        else
          echo "ğŸ”µ Cold build (180-300s expected)"
        fi
        
        echo "Cache: PNPM=$PNPM_FILES, Turbo=$TURBO_FILES"
      volumeMounts:
        - name: pnpm-cache-dir
          mountPath: /workspace/pnpm-cache
        - name: turbo-cache-dir
          mountPath: /workspace/turbo-cache
        - name: shared-data
          mountPath: /shared

    # âœ… Step 2: ìµœì í™”ëœ Kaniko ë¹Œë“œ
    - name: kaniko-build
      image: {{ .Values.common_kaniko_url }}
      timeout: "15m"
      args:
        # ê¸°ë³¸ ì„¤ì •
        - --context=$(workspaces.{{ .Values.project_name }}.path)/goyoai-gointern-web/source
        - --dockerfile=dockerfile-b2b-dev
        - --destination=$(params.container-registry-url)/goyoai-gointern-web:$(params.git-short-sha)-$(params.timestamp)
        - --force
        
        # ğŸš€ ì„±ëŠ¥ ìµœì í™”
        - --use-new-run=true
        - --snapshot-mode=time
        - --skip-unused-stages=true
        
        # ğŸ”¥ ìºì‹œ ì „ëµ
        - --cache=true
        - --cache-ttl=168h
        - --cache-repo=$(params.container-registry-cache-url)/goyoai-gointern-web
        - --cache-copy-layers=true
        - --cache-run-layers=true
        - --compressed-caching=false
        - --cache-dir=/cache
        
        # ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì„¤ì •
        - --insecure-registry=gdhb.goyoai.com
        - --push-retry=2
        
        # ê²°ê³¼ ì €ì¥
        - --digest-file=/shared/image-digest
        
      env:
        # Go ìµœì í™” (3Core í™˜ê²½)
        - name: GOGC
          value: "80"
        - name: GOMEMLIMIT
          value: "10GiB"
        - name: GOMAXPROCS
          value: "3"
        
        # Node.js ìµœì í™”
        - name: NODE_OPTIONS
          value: "--max-old-space-size=6144"
        - name: NODE_ENV
          value: "development"
        
        # í…”ë ˆë©”íŠ¸ë¦¬ ë¹„í™œì„±í™”
        - name: TURBO_TELEMETRY_DISABLED
          value: "1"
        - name: NEXT_TELEMETRY_DISABLED
          value: "1"
        
      volumeMounts:
        - name: docker-config
          mountPath: /kaniko/.docker
        - name: pnpm-cache-dir
          mountPath: /workspace/pnpm-cache
        - name: turbo-cache-dir
          mountPath: /workspace/turbo-cache
        - name: kaniko-cache
          mountPath: /cache
        - name: shared-data
          mountPath: /shared
          
      # ë¦¬ì†ŒìŠ¤ í• ë‹¹ (3Core 12GB ìµœì í™”)
      resources:
        requests:
          memory: "8Gi"
          cpu: "2"
        limits:
          memory: "12Gi"
          cpu: "3"

    # âœ… Step 3: ë¹Œë“œ ê²°ê³¼ ê²€ì¦
    - name: build-verification
      image: {{ .Values.common_alpine_url }}
      script: |
        #!/bin/sh
        echo "âœ… Build Verification"
        
        # ë¹Œë“œ ì‹œê°„ ê³„ì‚°
        BUILD_END_TIME=$(date +%s)
        BUILD_START_TIME=$(cat /shared/build_start_time)
        BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
        BUILD_MINUTES=$((BUILD_DURATION / 60))
        BUILD_SECONDS=$((BUILD_DURATION % 60))
        
        echo "â±ï¸  Build Time: ${BUILD_MINUTES}m ${BUILD_SECONDS}s"
        
        # ë¹Œë“œ ì„±ê³µ í™•ì¸
        if [ -f "/shared/image-digest" ]; then
          echo "ğŸ¯ goyoai-gointern-web build SUCCESS"
          echo "Image: $(cat /shared/image-digest)"
        else
          echo "âŒ Build FAILED"
          exit 1
        fi
        
        # ì„±ëŠ¥ ë“±ê¸‰
        if [ $BUILD_DURATION -lt 150 ]; then
          echo "ğŸš€ Performance: EXCELLENT"
        elif [ $BUILD_DURATION -lt 240 ]; then
          echo "ğŸ‘ Performance: GOOD"
        else
          echo "âš ï¸ Performance: NEEDS OPTIMIZATION"
        fi
      volumeMounts:
        - name: shared-data
          mountPath: /shared

  volumes:
    - name: docker-config
      secret:
        secretName: {{ .Values.container_registry_secretName }}
        items:
          - key: .dockerconfigjson
            path: config.json
    - name: pnpm-cache-dir
      persistentVolumeClaim:
        claimName: {{ .Values.gointern_pnpm_cache_pvc_name }}
    - name: turbo-cache-dir
      persistentVolumeClaim:
        claimName: {{ .Values.gointern_turbo_cache_pvc_name }}
    - name: kaniko-cache
      emptyDir: 
        sizeLimit: 8Gi
    - name: shared-data
      emptyDir: 
        sizeLimit: 512Mi