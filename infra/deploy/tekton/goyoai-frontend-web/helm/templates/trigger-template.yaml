# goyo_dev/deploy/tekton/goyoai-frontend-web/helm/templates/trigger-template.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: {{ .Values.project_name }}
  namespace: tekton-pipelines
spec:
  params:
    - name: gitrevision
      description: "Git branch reference (e.g., refs/heads/main)"
    - name: safe-branch-name
      description: "Safe branch name (slashes replaced with hyphens)"
    - name: git-branch
      description: "Git branch name"
    - name: gitrepositoryurl
      description: "Git repository URL"
    - name: git-sha
      description: "Full commit SHA"
    - name: git-short-sha
      description: "Short commit SHA"
    - name: git-repo-name
      description: "Git repository name"
    - name: module-name
      description: "Module name for the build"
    - name: dockerfile-name
      description: "Dockerfile name"
    - name: commit-message
      description: "Commit message"
      default: ""
    - name: author-name
      description: "Commit author name"
      default: "unknown"
    - name: author-email
      description: "Commit author email"
      default: "unknown@example.com"

  resourcetemplates:
    - apiVersion: tekton.dev/v1beta1
      kind: PipelineRun
      metadata:
        generateName: $(tt.params.module-name)-$(tt.params.safe-branch-name)-run-
        namespace: tekton-pipelines
        labels:
          app: {{ .Values.project_name }}
          tekton.dev/pipeline: {{ .Values.project_name }}
          # ⭐ git.branch 레이블 제거 (슬래시 때문에 문제 발생)
          git.commit: $(tt.params.git-short-sha)
          module: $(tt.params.module-name)
          triggered-by: ci-webhook
        annotations:
          # ⭐ 브랜치 정보는 annotation에만 저장 (슬래시 허용됨)
          git.commit.sha: $(tt.params.git-sha)
          git.commit.short-sha: $(tt.params.git-short-sha)
          git.branch: $(tt.params.gitrevision)
          git.repository: $(tt.params.gitrepositoryurl)
          commit.message: $(tt.params.commit-message)
          commit.author.name: $(tt.params.author-name)
          commit.author.email: $(tt.params.author-email)
          build.module: $(tt.params.module-name)
          build.dockerfile: $(tt.params.dockerfile-name)
      spec:
        pipelineRef:
          name: {{ .Values.project_name }}
        params:
          - name: giturl
            value: $(tt.params.gitrepositoryurl)
          - name: container-registry-url
            value: {{ .Values.container_registry_url }}
          - name: container-registry-cache-url
            value: {{ .Values.container_registry_cache_url }}
          - name: manifest-file-name
            value: {{ .Values.manifestFileName }}
          # - name: commit-message
          # value: "Update $(tt.params.git-repo-name):$(tt.params.gitrevision) git hash: $(tt.params.git-short-sha)"
          - name: project-name
            value: $(tt.params.git-repo-name)
          - name: revision
            value: $(tt.params.gitrevision)
          - name: git-short-sha
            value: $(tt.params.git-short-sha)
          - name: module-name
            value: $(tt.params.module-name)
          - name: dockerfile-name
            value: $(tt.params.dockerfile-name)
          - name: author-name
            value: $(tt.params.author-name)
          - name: commit-message
            value: "$(tt.params.commit-message)"
          - name: git-branch
            value: "$(tt.params.git-branch)"
        workspaces:
          - name: {{ .Values.project_name }}
            emptyDir: {}
        serviceAccountName: tekton-ci-token

        podTemplate:
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: workload-type
                        operator: DoesNotExist
                      - key: {{ .Values.trigger_node_selector_key }}
                        operator: In
                        values:
                          - {{ .Values.trigger_node_selector_value }}
          tolerations:
            - key: {{ .Values.trigger_tolerations_key }}
              operator: {{ .Values.trigger_tolerations_operator }}
              value: {{ .Values.trigger_tolerations_value }}
              effect: {{ .Values.trigger_tolerations_effect }}
