apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: {{ .Values.project_name }}-update-gitops
  namespace: {{ .Values.namespace }}
spec:
  params:
    - name: app-name
      type: string
    - name: image-tag
      type: string
    - name: registry
      type: string
    - name: namespace-env
      type: string
    - name: kustomize-git-url
      type: string
    - name: kustomize-git-branch
      type: string
    - name: kustomize-directory
      type: string
  
  workspaces:
    - name: gitops-source
  
  steps:
    - name: clean-workspace
      image: {{ .Values.common_alpine_url }}
      script: |
        #!/bin/sh
        WORKSPACE_PATH=$(workspaces.gitops-source.path)
        PROJECT_DIR=$WORKSPACE_PATH/$(params.app-name)-manifest
        
        # Create project directory if not exists
        mkdir -p $PROJECT_DIR
        
        # Clean the workspace
        rm -rf $PROJECT_DIR/.[!.]* $PROJECT_DIR/*
        
        if [ "$(ls -A $PROJECT_DIR)" ]; then
          echo "Project directory is not empty after cleaning."
          ls -al $PROJECT_DIR
          exit 1
        else
          echo "‚úÖ Project directory is now clean."
        fi

    - name: clone-and-update
      image: {{ .Values.common_alpine_git_url }}
      script: |
        #!/bin/sh
        set -ex
        
        WORKSPACE_PATH=$(workspaces.gitops-source.path)
        PROJECT_DIR=$WORKSPACE_PATH/$(params.app-name)-manifest
        GIT_ROOT_PATH=$PROJECT_DIR
        
        # Configure Git
        git config --global user.name "Tekton Bot"
        git config --global user.email "tekton@goyoai.com"
        
        # Clone the repository
        git clone --branch $(params.kustomize-git-branch) \
          $(params.kustomize-git-url) $GIT_ROOT_PATH
        
        # Navigate to the overlay directory
        OVERLAY_PATH="$GIT_ROOT_PATH/$(params.kustomize-directory)/overlays/$(params.namespace-env)"
        mkdir -p $OVERLAY_PATH
        cd $OVERLAY_PATH
        
        echo "üìù Updating deployment_patches.yaml..."
        
        # Create/Update deployment_patches.yaml
        cat <<EOF > deployment_patches.yaml
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: $(params.app-name)
        spec:
          template:
            spec:
              containers:
                - name: $(params.app-name)-container
                  image: $(params.registry):$(params.image-tag)
        EOF
        
        echo "‚úÖ Updated deployment_patches.yaml:"
        cat deployment_patches.yaml
        
        # Stage, commit, and push the changes
        git add deployment_patches.yaml
        
        COMMIT_MESSAGE="$(params.namespace-env): update $(params.app-name) to $(params.image-tag)

        Image: $(params.registry):$(params.image-tag)
        Updated by Tekton Pipeline"
        
        if git diff --cached --quiet; then
          echo "‚ÑπÔ∏è  No changes to commit"
          exit 0
        fi
        
        git commit -m "$COMMIT_MESSAGE"
        git push origin $(params.kustomize-git-branch)
        
        echo "‚úÖ Changes pushed to GitOps repository"
        echo "‚è≥ ArgoCD will auto-sync in ~3 minutes"