# ðŸŒ Global ClusterTask - generate-timestamp
# ëª¨ë“  í´ëŸ¬ìŠ¤í„° í”„ë¡œì íŠ¸ì—ì„œ ê³µí†µ ì‚¬ìš©
# ===================================================================
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: generate-timestamp
  namespace: tekton-pipelines
  labels:
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/component: "ci-cd"
    tekton.dev/categories: "Utilities"
    tekton.dev/tags: "timestamp-slack-notification"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/displayName: "Generate Timestamp with Slack Notification"
    tekton.dev/platforms: "linux/amd64,linux/arm64"
    description: |
      ðŸ•’ íƒ€ìž„ìŠ¤íƒ¬í”„ ìƒì„± ë° ì„ íƒì  Slack ì•Œë¦¼
      
      âœ¨ ì£¼ìš” ê¸°ëŠ¥:
      - YYYYMMDDHHmmss í˜•ì‹ íƒ€ìž„ìŠ¤íƒ¬í”„ ìƒì„±
      - ì„ íƒì  Slack ì‹œìž‘ ì•Œë¦¼ ì „ì†¡
      - ëª¨ë“  í”„ë¡œì íŠ¸ì—ì„œ ìž¬ì‚¬ìš© ê°€ëŠ¥
      
      ðŸ“‹ ì‚¬ìš© ì˜ˆì‹œ:
      taskRef:
        name: generate-timestamp
        kind: ClusterTask
      params:
        - name: project-name
          value: "my-project"
        - name: slack-webhook-url
          value: "https://hooks.slack.com/..."
spec:
  description: |
    íƒ€ìž„ìŠ¤íƒ¬í”„ë¥¼ ìƒì„±í•˜ê³  ì„ íƒì ìœ¼ë¡œ Slack ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤.
    ëª¨ë“  ë„¤ìž„ìŠ¤íŽ˜ì´ìŠ¤ì—ì„œ ìž¬ì‚¬ìš© ê°€ëŠ¥í•œ ClusterTaskìž…ë‹ˆë‹¤.
  
  params:
    - name: project-name
      type: string
      description: "ë°°í¬í•  í”„ë¡œì íŠ¸ ì´ë¦„"
      default: "unknown-project"
    
    - name: slack-webhook-url
      type: string
      description: "Slack ì›¹í›… URL (ì„ íƒì‚¬í•­, ë¹ˆ ê°’ì´ë©´ ì•Œë¦¼ ìƒëžµ)"
      default: ""
    
    - name: slack-channel
      type: string
      description: "Slack ì±„ë„ëª… (ì„ íƒì‚¬í•­)"
      default: "#ci-cd"
    
    - name: timezone
      type: string
      description: "íƒ€ìž„ì¡´ ì„¤ì •"
      default: "Asia/Seoul"
  
  results:
    - name: timestamp
      description: "ìƒì„±ëœ íƒ€ìž„ìŠ¤íƒ¬í”„ (YYYYMMDDHHmmss)"
    
    - name: timestamp-iso
      description: "ISO 8601 í˜•ì‹ íƒ€ìž„ìŠ¤íƒ¬í”„"
    
    - name: project-name
      description: "í”„ë¡œì íŠ¸ ì´ë¦„ (íŒŒì´í”„ë¼ì¸ì—ì„œ ì°¸ì¡°ìš©)"
  
  steps:
    - name: generate-timestamp
      image: gdhb.goyoai.com/common/alpine:3.20.3
      env:
        - name: TZ
          value: $(params.timezone)
      script: |
        #!/bin/sh
        set -e
        
        echo "ðŸ•’ íƒ€ìž„ìŠ¤íƒ¬í”„ ìƒì„± ì‹œìž‘..."
        echo "  í”„ë¡œì íŠ¸: $(params.project-name)"
        echo "  íƒ€ìž„ì¡´: $(params.timezone)"
        
        # íƒ€ìž„ìŠ¤íƒ¬í”„ ìƒì„±
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        TIMESTAMP_ISO=$(date -Iseconds)
        
        echo "  ìƒì„±ëœ íƒ€ìž„ìŠ¤íƒ¬í”„: $TIMESTAMP"
        echo "  ISO í˜•ì‹: $TIMESTAMP_ISO"
        
        # ê²°ê³¼ ì €ìž¥
        echo -n "$TIMESTAMP" > "$(results.timestamp.path)"
        echo -n "$TIMESTAMP_ISO" > "$(results.timestamp-iso.path)"
        echo -n "$(params.project-name)" > "$(results.project-name.path)"
        
        echo "âœ… íƒ€ìž„ìŠ¤íƒ¬í”„ ìƒì„± ì™„ë£Œ"
    
    - name: slack-notification
      image: gdhb.goyoai.com/common/curl:8.14.1
      script: |
        #!/bin/sh
        set -e
        
        WEBHOOK_URL="$(params.slack-webhook-url)"
        
        if [ -z "$WEBHOOK_URL" ] || [ "$WEBHOOK_URL" = "null" ]; then
          echo "â„¹ï¸  Slack ì›¹í›… URLì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ - ì•Œë¦¼ ìƒëžµ"
          exit 0
        fi
        
        echo "ðŸ“¢ Slack ì•Œë¦¼ ì „ì†¡ ì¤‘..."
        
        # íŒŒë¼ë¯¸í„° í™•ì¸        # íƒ€ìž„ìŠ¤íƒ¬í”„ ì½ê¸°
        TIMESTAMP=$(cat $(results.timestamp.path))
        TIMESTAMP_ISO=$(cat $(results.timestamp-iso.path))
        
        # Slack ë©”ì‹œì§€ êµ¬ì„±
        cat > /tmp/slack-payload.json << EOF
        {
          "channel": "$(params.slack-channel)",
          "username": "Tekton CI/CD",
          "icon_emoji": ":rocket:",
          "attachments": [
            {
              "color": "#36a64f",
              "fields": [
                {
                  "title": "ðŸš€ CI/CD íŒŒì´í”„ë¼ì¸ ì‹œìž‘",
                  "value": "í”„ë¡œì íŠ¸: \`$(params.project-name)\`",
                  "short": true
                },
                {
                  "title": "ðŸ•’ íƒ€ìž„ìŠ¤íƒ¬í”„",
                  "value": "\`$TIMESTAMP\`",
                  "short": true
                },
                {
                  "title": "ðŸ“… ì‹œìž‘ ì‹œê°„",
                  "value": "$TIMESTAMP_ISO",
                  "short": false
                }
              ],
              "footer": "Tekton Pipelines",
              "ts": $(date +%s)
            }
          ]
        }
        EOF
        
        # Slack ì „ì†¡
        if curl -s -X POST \
          -H 'Content-type: application/json' \
          --data @/tmp/slack-payload.json \
          "$WEBHOOK_URL" | grep -q "ok"; then
          echo "âœ… Slack ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"
        else
          echo "âš ï¸  Slack ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨ (íŒŒì´í”„ë¼ì¸ ê³„ì† ì§„í–‰)"
        fi
      
      # Slack ì•Œë¦¼ ì‹¤íŒ¨í•´ë„ íŒŒì´í”„ë¼ì¸ì€ ê³„ì† ì§„í–‰
      onError: continue

# ===================================================================
# ðŸ“š ì‚¬ìš© ê°€ì´ë“œ
# ===================================================================
# 
# ðŸ”¹ ê¸°ë³¸ ì‚¬ìš©ë²•:
# taskRef:
#   name: generate-timestamp
#   kind: ClusterTask
# params:
#   - name: project-name
#     value: "my-awesome-project"
# 
# ðŸ”¹ Slack ì•Œë¦¼ í¬í•¨:
# taskRef:
#   name: generate-timestamp
#   kind: ClusterTask
# params:
#   - name: project-name
#     value: "my-awesome-project"
#   - name: slack-webhook-url
#     value: "https://hooks.slack.com/services/..."
#   - name: slack-channel
#     value: "#deployments"
# 
# ðŸ”¹ ê²°ê³¼ ì‚¬ìš©:
# - $(tasks.generate-timestamp.results.timestamp)
# - $(tasks.generate-timestamp.results.timestamp-iso)
# - $(tasks.generate-timestamp.results.project-name)
# 
# ===================================================================