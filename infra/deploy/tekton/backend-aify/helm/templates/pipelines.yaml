# ëª¨ë“ˆí™”ëœ ë™ì  íŒŒì´í”„ë¼ì¸ í…œí”Œë¦¿ (aify ì œê±°)
# templates/pipelines.yaml
# ===================================================================

{{- range $moduleName, $moduleConfig := .Values.modules }}
{{- if $moduleConfig.enabled }}
# ===================================================================
# ğŸ”¹ {{ upper $moduleName }} ëª¨ë“ˆ íŒŒì´í”„ë¼ì¸
# ===================================================================
---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: aify-backend-{{ $moduleName }}
  namespace: tekton-pipelines
  labels:
    {{- include "aify-backend.labels" $ | nindent 4 }}
    module: {{ $moduleName }}
  annotations:
    description: "{{ title $moduleName }} ëª¨ë“ˆ CI/CD íŒŒì´í”„ë¼ì¸"
spec:
  params:
    - name: giturl
      type: string
      description: "Git repository URL"
    - name: container-registry-url
      type: string
      description: "Container registry URL"
    - name: container-registry-cache-url
      type: string
      description: "Container registry cache URL"
    - name: revision
      type: string
      description: "Git revision"
    - name: manifest-file-name
      type: string
      description: "Kubernetes manifest file name"
    - name: commit-message
      type: string
      default: "{{ $.Values.global.kustomize.commitMessage }}"
      description: "Git commit message"
    - name: project-name
      type: string
      description: "Project name"
    - name: git-short-sha
      type: string
      description: "Short SHA of the commit"
    - name: module-name
      type: string
      description: "Module name"
    - name: dockerfile-name
      type: string
      description: "Dockerfile name"
    - name: slack-webhook-url
      type: string
      description: "Slack webhook URL for notifications"
      default: ""
  
  workspaces:
    - name: {{ $.Values.global.project_name }}
      description: "Shared workspace for the pipeline"
  
  tasks:
    # ğŸ”§ íƒ€ì„ìŠ¤íƒ¬í”„ ìƒì„±
    - name: generate-timestamp
      taskRef:
        name: generate-timestamp
        kind: ClusterTask 
      params:
        - name: project-name
          value: $(params.project-name)
        - name: slack-webhook-url
          value: $(params.slack-webhook-url)
        - name: slack-channel
          value: "#aify-deployments"
    
    # ğŸ“‚ ì†ŒìŠ¤ ì½”ë“œ í´ë¡ 
    - name: clone-repository
      taskRef:
        name: {{ $.Values.global.project_name }}-git-clone
      params:
        - name: giturl
          value: $(params.giturl)
        - name: revision
          value: $(params.revision)
        - name: project-name
          value: $(params.project-name)
        - name: module-name
          value: $(params.module-name)
      runAfter: ["generate-timestamp"]
      workspaces:
        - name: {{ $.Values.global.project_name }}
          workspace: {{ $.Values.global.project_name }}
    
    # ğŸ³ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ
    - name: build-container-image
      taskRef:
        name: {{ $moduleConfig.taskName }}
      params:
        - name: container-registry-url
          value: $(params.container-registry-url)
        - name: container-registry-cache-url
          value: $(params.container-registry-cache-url)
        - name: project-name
          value: $(params.project-name)
        - name: timestamp
          value: $(tasks.generate-timestamp.results.timestamp)
        - name: git-short-sha
          value: $(params.git-short-sha)
        - name: module-name
          value: $(params.module-name)
        - name: dockerfile-name
          value: $(params.dockerfile-name)
      runAfter: ["clone-repository"]
      workspaces:
        - name: {{ $.Values.global.project_name }}
          workspace: {{ $.Values.global.project_name }}
    
    # ğŸ“ Manifest ì—…ë°ì´íŠ¸ ë° Git í‘¸ì‹œ
    - name: manifest-git-push
      taskRef:
        name: {{ $.Values.global.project_name }}-manifest
      params:
        - name: manifest-file-name
          value: $(params.manifest-file-name)
        - name: container-registry-url
          value: $(params.container-registry-url)
        - name: commit-message
          value: $(params.commit-message)
        - name: revision
          value: $(params.revision)
        - name: project-name
          value: $(params.project-name)
        - name: timestamp
          value: $(tasks.generate-timestamp.results.timestamp)
        - name: git-short-sha
          value: $(params.git-short-sha)
        - name: module-name
          value: $(params.module-name)
      runAfter: ["build-container-image"]
      workspaces:
        - name: {{ $.Values.global.project_name }}
          workspace: {{ $.Values.global.project_name }}
  
  # ğŸ Finally íƒœìŠ¤í¬ (ì •ë¦¬ ì‘ì—…)
  finally:
    - name: slack-notify
      taskRef:
        name: slack-notification
      params:
        - name: webhook-url
          value: "{{ $.Values.global.slack.webhook_url }}"
        - name: message
          value: |
            ğŸš€ {{ title $moduleName }} ëª¨ë“ˆ ë¹Œë“œ ì™„ë£Œ!
            ğŸ“¦ ëª¨ë“ˆ: $(params.module-name)
            ğŸ·ï¸ íƒœê·¸: $(tasks.generate-timestamp.results.timestamp)-$(params.git-short-sha)
            ğŸŒ¿ ë¸Œëœì¹˜: $(params.revision)
            â° ì‹œê°„: $(tasks.generate-timestamp.results.timestamp)
        - name: status
          value: $(tasks.status)

{{- end }}
{{- end }}

# ===================================================================
# ğŸ“Š ìƒì„±ëœ íŒŒì´í”„ë¼ì¸ ìš”ì•½ ì •ë³´
# ===================================================================
# 
# í™œì„±í™”ëœ ëª¨ë“ˆë³„ë¡œ ìƒì„±ë˜ëŠ” íŒŒì´í”„ë¼ì¸ë“¤:
{{- range $moduleName, $moduleConfig := .Values.modules }}
{{- if $moduleConfig.enabled }}
# 
# ğŸ”¹ {{ upper $moduleName }} ëª¨ë“ˆ:
#   - íŒŒì´í”„ë¼ì¸: goyoai-gointern-{{ $moduleName }}
#   - ë¹Œë“œ íƒœìŠ¤í¬: {{ $moduleConfig.taskName }}
#   - Git ë¸Œëœì¹˜: {{ $moduleConfig.git.branch }}
#   - ëª¨ë“ˆëª…: {{ $moduleConfig.build.moduleName }}
{{- end }}
{{- end }}
# 
# ê° íŒŒì´í”„ë¼ì¸ì€ ë‹¤ìŒ íƒœìŠ¤í¬ë“¤ì„ í¬í•¨:
# 1. generate-timestamp - íƒ€ì„ìŠ¤íƒ¬í”„ ìƒì„±
# 2. clone-repository - Git í´ë¡ 
# 3. build-container-image - ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ
# 4. manifest-git-push - Manifest ì—…ë°ì´íŠ¸
# 5. slack-notify (finally) - Slack ì•Œë¦¼
# ===================================================================
