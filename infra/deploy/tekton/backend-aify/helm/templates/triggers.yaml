# ì™„ì „íˆ ìˆ˜ì •ëœ ëª¨ë“ˆí™” íŠ¸ë¦¬ê±° í…œí”Œë¦¿
# templates/triggers.yaml
# ===================================================================

# TriggerBinding - ëª¨ë“  ëª¨ë“ˆì—ì„œ ê³µí†µ ì‚¬ìš©
---
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: {{ .Values.global.project_name }}
  namespace: tekton-pipelines
  labels:
    {{- include "aify-backend.labels" . | nindent 4 }}
    type: trigger-binding
  annotations:
    description: "GitHub ì›¹í›… ì´ë²¤íŠ¸ë¥¼ Tekton íŒŒë¼ë¯¸í„°ë¡œ ë°”ì¸ë”©"
spec:
  params:
    - name: gitrevision
      value: $(extensions.branch_name)
    - name: gitrepositoryurl
      value: $(body.repository.clone_url)
    - name: git-repo-name
      value: $(body.repository.name)
    - name: git-sha
      value: $(extensions.sha)
    - name: git-short-sha
      value: $(extensions.short_sha)
    - name: module-name
      value: $(extensions.module_name)
    - name: dockerfile-name
      value: $(extensions.dockerfile_name)
    - name: pvc-name
      value: $(extensions.pvc_name)

{{- range $moduleName, $moduleConfig := .Values.modules }}
{{- if $moduleConfig.enabled }}
# ===================================================================
# ğŸ”¹ {{ upper $moduleName }} ëª¨ë“ˆ TriggerTemplate
# ===================================================================
---
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: {{ $.Values.global.project_name }}-{{ $moduleName }}
  namespace: tekton-pipelines
  labels:
    {{- include "aify-backend.labels" $ | nindent 4 }}
    type: trigger-template
    module: {{ $moduleName }}
  annotations:
    description: "{{ title $moduleName }} ëª¨ë“ˆ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ í…œí”Œë¦¿"
spec:
  params:
    - name: gitrevision
      description: "Git ë¸Œëœì¹˜ëª…"
    - name: gitrepositoryurl
      description: "Git ì €ì¥ì†Œ URL"
    - name: git-repo-name
      description: "Git ì €ì¥ì†Œ ì´ë¦„"
    - name: git-sha
      description: "Git ì»¤ë°‹ SHA"
    - name: git-short-sha
      description: "Git ì§§ì€ SHA"
    - name: module-name
      description: "ë¹Œë“œí•  ëª¨ë“ˆ ì´ë¦„"
    - name: dockerfile-name
      description: "ì‚¬ìš©í•  Dockerfile ì´ë¦„"
    - name: pvc-name
      description: "ì‚¬ìš©í•  PVC ì´ë¦„"
  
  resourcetemplates:
    # {{ title $moduleName }} ëª¨ë“ˆ PipelineRun
    - apiVersion: tekton.dev/v1beta1
      kind: PipelineRun
      metadata:
        generateName: {{ $moduleConfig.git.branch }}-
        namespace: tekton-pipelines
        labels:
          {{- include "aify-backend.labels" $ | nindent 10 }}
          pipeline-type: "ci-cd"
          git-branch: $(tt.params.gitrevision)
          module: {{ $moduleName }}
        annotations:
          triggers.tekton.dev/git-sha: $(tt.params.git-sha)
          triggers.tekton.dev/git-branch: $(tt.params.gitrevision)
          triggers.tekton.dev/module: {{ $moduleName }}
      spec:
        # ëª¨ë“ˆë³„ ê³ ì • íŒŒì´í”„ë¼ì¸ ì°¸ì¡°
        pipelineRef:
          name: aify-backend-{{ $moduleName }}
        
        # íŒŒë¼ë¯¸í„° ì „ë‹¬
        params:
          - name: giturl
            value: $(tt.params.gitrepositoryurl)
          - name: container-registry-url
            value: {{ $.Values.global.registry.url }}
          - name: container-registry-cache-url
            value: {{ $.Values.global.registry.cache_url }}
          - name: revision
            value: $(tt.params.gitrevision)
          - name: manifest-file-name
            value: {{ $.Values.global.kustomize.manifestFileName }}
          - name: commit-message
            value: {{ $.Values.global.kustomize.commitMessage }}
          - name: project-name
            value: {{ $.Values.global.project_name }}
          - name: git-short-sha
            value: $(tt.params.git-short-sha)
          - name: module-name
            value: $(tt.params.module-name)
          - name: dockerfile-name
            value: $(tt.params.dockerfile-name)
          - name: slack-webhook-url
            value: {{ $.Values.global.slack.webhook_url }}
        
        # ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì„¤ì •
        workspaces:
          - name: {{ $.Values.global.project_name }}
            persistentVolumeClaim:
              claimName: $(tt.params.pvc-name)
        
        # ìŠ¤ì¼€ì¤„ë§ ë° ë¦¬ì†ŒìŠ¤ ì„¤ì •
        podTemplate:
          nodeSelector:
            {{- toYaml $.Values.pipeline.nodeSelector | nindent 12 }}
          tolerations:
            {{- toYaml $.Values.pipeline.tolerations | nindent 12 }}
          securityContext:
            {{- toYaml $.Values.security.podSecurityContext | nindent 12 }}
        
        # íƒ€ì„ì•„ì›ƒ ì„¤ì •
        timeouts:
          pipeline: {{ $.Values.pipeline.timeouts.pipeline }}
          tasks: {{ $.Values.pipeline.timeouts.tasks }}
          finally: {{ $.Values.pipeline.timeouts.finally }}
        
        # ì„œë¹„ìŠ¤ ì–´ì¹´ìš´íŠ¸
        serviceAccountName: {{ $.Values.serviceAccounts.git }}

{{- end }}
{{- end }}

# ===================================================================
# ğŸ“Š ìƒì„±ëœ TriggerTemplate ìš”ì•½
# ===================================================================
# 
# ğŸ”— ê³µí†µ TriggerBinding: {{ .Values.global.project_name }}
# 
# ğŸ”¹ ëª¨ë“ˆë³„ TriggerTemplate:
{{- range $moduleName, $moduleConfig := .Values.modules }}
{{- if $moduleConfig.enabled }}
# - {{ $.Values.global.project_name }}-{{ $moduleName }}
#   â””â”€â”€ íŒŒì´í”„ë¼ì¸: aify-backend-{{ $moduleName }}
#   â””â”€â”€ ë¸Œëœì¹˜: {{ $moduleConfig.git.branch }}
{{- end }}
{{- end }}
# 
# EventListenerì—ì„œ ì´ TriggerTemplateë“¤ì„ ì°¸ì¡°í•´ì•¼ í•¨:
# - ref: {{ .Values.global.project_name }}-system
# - ref: {{ .Values.global.project_name }}-portal
# ===================================================================
