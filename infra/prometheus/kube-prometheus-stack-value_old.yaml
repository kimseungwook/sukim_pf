global:
  nodeSelector:
    cpu-type: arm64
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: cpu-type
            operator: In
            values:
            - arm64
          - key: workload-type
            operator: NotIn
            values:
            - build

prometheusOperator:
  nodeSelector:
    cpu-type: arm64
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: cpu-type
            operator: In
            values:
            - arm64
          - key: workload-type
            operator: NotIn
            values:
            - build

  admissionWebhooks:
    patch:
      nodeSelector:
        cpu-type: arm64
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: cpu-type
                operator: In
                values:
                - arm64
              - key: workload-type
                operator: NotIn
                values:
                - build

prometheus:
  enabled: true

  prometheusSpec:
    image:
      registry: quay.io
      repository: prometheus/prometheus
      tag: v3.0.1
      sha: ""

    # Mimir로 메트릭 전송
    remoteWrite:
      - url: "http://mimir-gateway.monitoring.svc.cluster.local:80/api/v1/push"
        headers:
          X-Scope-OrgID: "1"
    
    # Remote Write Receiver 활성화
    enableRemoteWriteReceiver: true
    
    logLevel: info  # debug에서 info로 변경 (운영환경 권장)
    
    # 메트릭 보존 기간
    retention: 10d
    
    # 스크랩 간격
    scrapeInterval: 30s
    evaluationInterval: 30s
    
    # 리소스 제한
    resources:
      requests:
        memory: 400Mi
        cpu: 200m
      limits:
        memory: 800Mi
        cpu: 400m

    # 스토리지 설정
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: standard
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 50Gi

    # Pod 스케줄링
    nodeSelector:
      cpu-type: arm64
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
          - matchExpressions:
            - key: cpu-type
              operator: In
              values:
              - arm64
            - key: workload-type
              operator: NotIn
              values:
              - build

    # 보안 컨텍스트
    securityContext:
      runAsGroup: 2000
      runAsNonRoot: true
      runAsUser: 1000
      fsGroup: 2000
      seccompProfile:
        type: RuntimeDefault

    # Pod 반-어피니티 비활성화 (단일 replica 사용)
    podAntiAffinity: ""

  # 서비스 계정
  serviceAccount:
    create: true
    name: ""
    automountServiceAccountToken: true

  # 서비스 설정
  service:
    type: ClusterIP
    port: 9090
    targetPort: 9090

  # ServiceMonitor
  serviceMonitor:
    selfMonitor: true
    interval: ""
    additionalLabels: {}

  # Ingress 비활성화
  ingress:
    enabled: false

# Alertmanager 설정
alertmanager:
  enabled: true
  
  alertmanagerSpec:
    externalUrl: http://grafana.monitoring.svc.cluster.local:80
    
    # 리소스 제한
    resources:
      requests:
        memory: 200Mi
        cpu: 100m
      limits:
        memory: 400Mi
        cpu: 200m

    # Pod 스케줄링
    nodeSelector:
      cpu-type: arm64
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
          - matchExpressions:
            - key: cpu-type
              operator: In
              values:
              - arm64
            - key: workload-type
              operator: NotIn
              values:
              - build

    # 보안 컨텍스트
    securityContext:
      runAsGroup: 2000
      runAsNonRoot: true
      runAsUser: 1000
      fsGroup: 2000
      seccompProfile:
        type: RuntimeDefault

    # Pod 반-어피니티 비활성화
    podAntiAffinity: ""

  serviceAccount:
    create: true
    name: ""
    automountServiceAccountToken: true

  service:
    type: ClusterIP
    port: 9093
    targetPort: 9093

# Grafana 비활성화 (별도 설치)
grafana:
  enabled: false

# Node Exporter 설정 - Virtual Node만 제외
nodeExporter:
  enabled: true

prometheus-node-exporter:
  # Virtual Node만 제외하는 설정
  # DaemonSet이므로 기본적으로 모든 노드에 배포됨
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        # Virtual Node가 아닌 모든 노드 선택 (cpu-type=virtual인 노드 제외)
        - matchExpressions:
          - key: cpu-type
            operator: NotIn
            values:
            - arm64

  # 모든 노드의 taint를 tolerate
  # Virtual Node의 taint(workload=virtual:NoSchedule)는 tolerate하지 않음
  tolerations:
    # cpu-type=monitoring 노드의 taint만 tolerate
    - key: "cpu-type"
      operator: "Equal"
      value: "monitoring"
      effect: "NoSchedule"
    - key: "cpu-type"
      operator: "Equal"
      value: "deploy"
      effect: "NoSchedule"
    - key: "cpu-type"
      operator: "Equal"
      value: "redis"
      effect: "NoSchedule"
    - key: "cpu-type"
      operator: "Equal"
      value: "amd64"
      effect: "NoSchedule"
    # 기타 일반적인 taint들 tolerate
    - key: "node.kubernetes.io/not-ready"
      operator: "Exists"
      effect: "NoExecute"
    - key: "node.kubernetes.io/unreachable"
      operator: "Exists"
      effect: "NoExecute"
    - key: "node.kubernetes.io/disk-pressure"
      operator: "Exists"
      effect: "NoSchedule"
    - key: "node.kubernetes.io/memory-pressure"
      operator: "Exists"
      effect: "NoSchedule"
    - key: "node.kubernetes.io/pid-pressure"
      operator: "Exists"
      effect: "NoSchedule"
    - key: "node.kubernetes.io/unschedulable"
      operator: "Exists"
      effect: "NoSchedule"
    # workload=virtual taint는 tolerate하지 않음 (Virtual Node 제외)

  # 추가 설정
  extraArgs:
    - --collector.filesystem.mount-points-exclude=^/(dev|proc|sys|var/lib/docker/.+|var/lib/kubelet/.+)($|/)
    - --collector.filesystem.fs-types-exclude=^(autofs|binfmt_misc|bpf|cgroup2?|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|iso9660|mqueue|nsfs|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|selinuxfs|squashfs|sysfs|tracefs|erofs)$

  service:
    portName: http-metrics
    labels:
      jobLabel: node-exporter

  prometheus:
    monitor:
      enabled: true
      jobLabel: jobLabel
      interval: ""
      relabelings: []
      metricRelabelings: []

  # 리소스 제한
  resources:
    requests:
      memory: 50Mi
      cpu: 100m
    limits:
      memory: 100Mi
      cpu: 200m

# Kube State Metrics 설정
kube-state-metrics:
  nodeSelector:
    cpu-type: arm64
    
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: cpu-type
            operator: In
            values:
            - arm64
          - key: workload-type
            operator: NotIn
            values:
            - build
            
  # 커스텀 레이블 추가 (cpu-type, service 레이블 포함)
  extraArgs:
    - --metric-labels-allowlist=nodes=[cpu-type,kubernetes.io/hostname,service,node-type]

  releaseLabel: true

  prometheus:
    monitor:
      enabled: true
      http:
        honorLabels: true
      metrics:
        honorLabels: true

# Kubelet 모니터링 설정 - Virtual Node 고려
kubelet:
  enabled: true
  namespace: kube-system

  serviceMonitor:
    enabled: true
    
    # Virtual Node는 kubelet 메트릭이 다를 수 있으므로
    # cpu-type=virtual 노드 제외
    relabelings:
      - action: replace
        sourceLabels: [__metrics_path__]
        targetLabel: metrics_path
      # Virtual Node 제외 (cpu-type=virtual)
      - sourceLabels: [__meta_kubernetes_node_label_goyo_svc]
        regex: virtual
        action: drop
      # Virtual Node 제외 (service=virtual)
      - sourceLabels: [__meta_kubernetes_node_label_service]
        regex: virtual
        action: drop

    # cAdvisor 설정
    cAdvisor: true
    cAdvisorInterval: 10s
    cAdvisorRelabelings:
      - action: replace
        sourceLabels: [__metrics_path__]
        targetLabel: metrics_path
    
    # 불필요한 메트릭 제거
    cAdvisorMetricRelabelings:
      - sourceLabels: [__name__]
        action: drop
        regex: 'container_cpu_(cfs_throttled_seconds_total|load_average_10s|system_seconds_total|user_seconds_total)'
      - sourceLabels: [__name__]
        action: drop
        regex: 'container_fs_(io_current|io_time_seconds_total|io_time_weighted_seconds_total|reads_merged_total|sector_reads_total|sector_writes_total|writes_merged_total)'
      - sourceLabels: [__name__]
        action: drop
        regex: 'container_memory_(mapped_file|swap)'
      - sourceLabels: [__name__]
        action: drop
        regex: 'container_(file_descriptors|tasks_state|threads_max)'
      - sourceLabels: [__name__, scope]
        action: drop
        regex: 'container_memory_failures_total;hierarchy'
      - sourceLabels: [__name__, interface]
        action: drop
        regex: 'container_network_.*;(cali|cilium|cni|lxc|nodelocaldns|tunl).*'
      - sourceLabels: [__name__]
        action: drop
        regex: 'container_spec.*'
      - sourceLabels: [id, pod]
        action: drop
        regex: '.+;'

    # probes 활성화
    probes: true
    probesRelabelings:
      - action: replace
        sourceLabels: [__metrics_path__]
        targetLabel: metrics_path

    # resource 메트릭 비활성화 (cAdvisor와 중복)
    resource: false

    # 기타 설정
    https: true
    insecureSkipVerify: true
    interval: ""
    honorLabels: true
    honorTimestamps: true
    trackTimestampsStaleness: true

# Kubernetes 컴포넌트 모니터링
kubernetesServiceMonitors:
  enabled: true

# API Server 모니터링
kubeApiServer:
  enabled: true
  tlsConfig:
    serverName: kubernetes
    insecureSkipVerify: false

# Controller Manager 모니터링
kubeControllerManager:
  enabled: true
  service:
    enabled: true
    port: null
    targetPort: null

# Scheduler 모니터링
kubeScheduler:
  enabled: true
  service:
    enabled: true
    port: null
    targetPort: null

# Proxy 모니터링
kubeProxy:
  enabled: true

# CoreDNS 모니터링
coreDns:
  enabled: true

# etcd 모니터링 (OKE는 관리형이므로 비활성화)
kubeEtcd:
  enabled: false

# Windows 모니터링 비활성화
windowsMonitoring:
  enabled: false

# Default Rules
defaultRules:
  create: true
  rules:
    alertmanager: true
    etcd: false  # OKE는 관리형 etcd
    configReloaders: true
    general: true
    k8sContainerCpuUsageSecondsTotal: true
    k8sContainerMemoryCache: true
    k8sContainerMemoryRss: true
    k8sContainerMemorySwap: true
    k8sContainerResource: true
    k8sContainerMemoryWorkingSetBytes: true
    k8sPodOwner: true
    kubeApiserverAvailability: true
    kubeApiserverBurnrate: true
    kubeApiserverHistogram: true
    kubeApiserverSlos: true
    kubeControllerManager: true
    kubelet: true
    kubeProxy: true
    kubePrometheusGeneral: true
    kubePrometheusNodeRecording: true
    kubernetesApps: true
    kubernetesResources: true
    kubernetesStorage: true
    kubernetesSystem: true
    kubeSchedulerAlerting: true
    kubeSchedulerRecording: true
    kubeStateMetrics: true
    network: true
    node: true
    nodeExporterAlerting: true
    nodeExporterRecording: true
    prometheus: true
    prometheusOperator: true
    windows: false

# Thanos Ruler 비활성화
thanosRuler:
  enabled: false