# =============================================================================
# Authentik Helm Values - Customized for sukim-pf
# =============================================================================
# 버전: 2025.8.4 (안정 버전)
# 주의: 2025.10.3은 Worker OOMKilled 버그로 인해 사용 불가
# 참고: redis subchart가 제거됨 - 별도의 Redis/Valkey 설치 필요
# =============================================================================

# -----------------------------------------------------------------------------
# 공통 변수 정의 (YAML Anchors)
# -----------------------------------------------------------------------------
x-common-node-affinity: &common-node-affinity
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
        - matchExpressions:
            - key: service
              operator: In
              values:
                - "tools"
            - key: cpu-type
              operator: In
              values:
                - "arm64"

# =============================================================================
# Global Configuration
# =============================================================================
global:
  # Bitnami 이미지 보안 오버라이드 허용
  security:
    allowInsecureImages: true

  # Authentik 이미지 버전 설정 (2025.8.4 - 안정 버전)
  image:
    repository: ghcr.io/goauthentik/server
    tag: "2025.8.4"
    pullPolicy: IfNotPresent

  # 공통 affinity 설정 사용
  affinity:
    <<: *common-node-affinity
    podAntiAffinity: soft

# =============================================================================
# Authentik Core Configuration
# =============================================================================
authentik:
  # 로그 레벨
  log_level: info

  # Error Reporting (Sentry)
  error_reporting:
    enabled: true
    environment: "dev"
    send_pii: false

  # Secret Key - Secret에서 참조
  # 주의: 이 값은 설치 후 변경하면 안됨
  secret_key: ""  # Secret에서 AUTHENTIK_SECRET_KEY 환경변수로 주입

  # PostgreSQL 설정
  postgresql:
    # host는 기본값 사용: {{ .Release.Name }}-postgresql
    name: "authentik"
    user: "authentik"
    password: ""  # Secret에서 AUTHENTIK_POSTGRESQL__PASSWORD 환경변수로 주입
    port: 5432

  # Valkey(Redis) 설정
  redis:
    host: "authentik-valkey-primary"
    password: ""

# =============================================================================
# Server Configuration
# =============================================================================
server:
  enabled: true
  replicas: 1

  # 리소스 설정 (실제 사용량 기반 증가: CPU 1071m → request 500m/limit 2000m)
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 2000m
      memory: 1Gi

  # Secret에서 민감 정보를 환경변수로 주입
  envFrom:
    - secretRef:
        name: authentik-secrets

  # Shared Memory Volume (dshm) - 공간 부족 문제 해결
  # 중요: /dev/shm은 컨테이너 메모리 limit과 별개로 기본 64Mi 고정
  volumes:
    - name: dshm
      emptyDir:
        medium: Memory
        sizeLimit: 512Mi

  volumeMounts:
    - name: dshm
      mountPath: /dev/shm

  # Metrics & ServiceMonitor
  metrics:
    enabled: true
    service:
      type: ClusterIP
      servicePort: 9300
      portName: metrics
    serviceMonitor:
      enabled: true
      interval: 30s
      scrapeTimeout: 10s
      labels:
        release: prometheus-stack

# =============================================================================
# Worker Configuration  
# =============================================================================
worker:
  enabled: true
  replicas: 1

  # 리소스 설정 (메모리 누수 대응: 10시간 후 OOMKilled 발생)
  resources:
    requests:
      cpu: 100m
      memory: 2Gi
    limits:
      cpu: 500m
      memory: 6Gi  # 메모리 누수 방지를 위한 여유 공간

  # Secret에서 민감 정보를 환경변수로 주입
  envFrom:
    - secretRef:
        name: authentik-secrets

  # 메모리 누수 완화를 위한 환경변수
  env:
    - name: AUTHENTIK_LOG_LEVEL
      value: "info"
    # Worker가 메모리 누수 방지를 위해 주기적으로 재시작
    # dramatiq worker의 max tasks after which worker restarts
    - name: DRAMATIQ_PROCESSES
      value: "2"
    - name: DRAMATIQ_THREADS
      value: "4"

  # Shared Memory Volume (dshm) - 공간 부족 문제 해결
  # 중요: /dev/shm은 컨테이너 메모리 limit과 별개로 기본 64Mi 고정
  # 명시적으로 volume을 마운트해야 크기 조정 가능
  volumes:
    - name: dshm
      emptyDir:
        medium: Memory
        sizeLimit: 512Mi  # Worker 메모리 사용량이 높으므로 512Mi로 증가

  volumeMounts:
    - name: dshm
      mountPath: /dev/shm

  # Metrics & ServiceMonitor
  metrics:
    enabled: true
    service:
      type: ClusterIP
      servicePort: 9300
      portName: metrics
    serviceMonitor:
      enabled: true
      interval: 30s
      scrapeTimeout: 10s
      labels:
        release: prometheus-stack

# =============================================================================
# PostgreSQL Subchart Configuration
# =============================================================================
postgresql:
  enabled: true

  # Bitnami PostgreSQL 이미지 사용 (Chart 호환성 및 권한 문제 해결)
  image:
    registry: docker.io
    repository: bitnamilegacy/postgresql
    tag: "17.6.0-debian-12-r4"

  # 권한 문제 해결을 위한 Init Container 활성화
  volumePermissions:
    enabled: true

  auth:
    username: authentik
    database: authentik
    # 통합 Secret에서 참조
    existingSecret: "authentik-secrets"
    secretKeys:
      userPasswordKey: "password"
      adminPasswordKey: "postgres-password"

  primary:
    # Node Affinity
    affinity:
      <<: *common-node-affinity

    # Recovery를 위한 Probe 설정 완화
    startupProbe:
      enabled: true
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 60
      successThreshold: 1

    livenessProbe:
      enabled: true
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 15
      successThreshold: 1

    readinessProbe:
      enabled: true
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 15
      successThreshold: 1

    # PostgreSQL 설정
    # 기본 차트의 args가 Bitnami 이미지와 충돌하므로 제거 (자동 설정 사용)
    args: []

    configuration: |
      listen_addresses = '*'
      port = '5432'
      wal_level = 'replica'
      fsync = 'on'
      hot_standby = 'on'
      log_connections = 'false'
      log_disconnections = 'false'
      log_hostname = 'false'
      client_min_messages = 'error'
      include_dir = 'conf.d'

    pgHbaConfiguration: |
      host     all             all             0.0.0.0/0               scram-sha-256
      host     all             all             ::/0                    scram-sha-256
      local    all             all                                     scram-sha-256
      host     all             all        127.0.0.1/32                 scram-sha-256
      host     all             all        ::1/128                      scram-sha-256

    extendedConfiguration: |
      max_connections = 500

    extraEnvVars:
      - name: POSTGRES_DB
        value: 'authentik'

    # 리소스
    resourcesPreset: "none"
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        memory: 256Mi

    # Persistence
    persistence:
      enabled: true
      size: 8Gi
      # storageClass: ""

    containerSecurityContext:
      readOnlyRootFilesystem: false

  # 불필요한 컴포넌트 비활성화
  readReplicas:
    resourcesPreset: "none"
  backup:
    resourcesPreset: "none"
  passwordUpdateJob:
    resourcesPreset: "none"
  # volumePermissions:
  #   resourcesPreset: "none"
  metrics:
    resourcesPreset: "none"

# =============================================================================
# Redis Configuration (별도 설치 필요 - 최신 버전에서 subchart 제거됨)
# =============================================================================
# 아래 방법 중 하나를 선택하세요:
#
# 옵션 1: Bitnami Redis Helm Chart 별도 설치
#   helm upgrade --install authentik-redis bitnami/redis -n authentik \
#     --set architecture=standalone \
#     --set auth.enabled=false
#
# 옵션 2: Valkey 사용 (Redis 호환)
#   helm upgrade --install authentik-valkey bitnami/valkey -n authentik --create-namespace
#
# 설치 후 authentik.redis.host 값을 업데이트하세요.
# =============================================================================

# =============================================================================
# Service Account
# =============================================================================
serviceAccount:
  create: true
  annotations: {}
  fullnameOverride: authentik

# =============================================================================
# Monitoring - PrometheusRule
# =============================================================================
prometheus:
  rules:
    enabled: true
    labels:
      release: prometheus-stack