# [User Custom + Slack/Loki/Grafana Integrated]

fullnameOverride: policy-reporter
replicaCount: 1

# -----------------------------------------------------------------------------
# 1. Í∏∞Î≥∏ Î¶¨ÏÜåÏä§ Î∞è Î≥¥Ïïà ÏÑ§Ï†ï
# -----------------------------------------------------------------------------
resources:
  limits:
    cpu: 200m
    memory: 256Mi
  requests:
    cpu: 50m
    memory: 64Mi

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1234
  fsGroup: 1234

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop: ["ALL"]
  readOnlyRootFilesystem: true
  runAsNonRoot: true

rbac:
  enabled: true

# -----------------------------------------------------------------------------
# 2. ÌÉÄÍ≤ü ÏÑ§Ï†ï (Slack ÏïåÎ¶º & Loki Î°úÍ∑∏)
# -----------------------------------------------------------------------------
target:
  # 1) Slack: Ï§ëÏöîÌïú ÏïåÎ¶ºÎßå Î∞õÍ∏∞
  slack:
    enabled: true
    webhook: "https://hooks.slack.com/services/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" # üî¥ Ïã§Ï†ú Webhook URL ÏûÖÎ†• ÌïÑÏöî
    skipExistingOnStartup: true
    minimumSeverity: "fail" # fail, error, critical Îì±Í∏âÎßå Ï†ÑÏÜ°
    filter:
      status:
        exclude: ["pass", "skip", "warn"] # ÌÜµÍ≥ºÎÇò Í≤ΩÍ≥†Îäî ÏïåÎ¶º Ï†úÏô∏
  
  # 2) Loki: Ï†ÑÏ≤¥ Í∞êÏÇ¨ Î°úÍ∑∏ Ï†ÄÏû•
  loki:
    enabled: true
    host: "http://goyo-loki-distributed-gateway.lgtm.svc.cluster.local:80"
    minimumSeverity: "info" # Î™®Îì† Ï†ïÎ≥¥ Ï†ÄÏû•
    skipExistingOnStartup: true
    customFields:
      cluster: "goyoai-dev" # ÌÅ¥Îü¨Ïä§ÌÑ∞ ÏãùÎ≥ÑÏûê

# -----------------------------------------------------------------------------
# 3. ÌïÑÌÑ∞ ÏÑ§Ï†ï (Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Í∑úÏπô)
# -----------------------------------------------------------------------------
reportFilter: {}

sourceFilters:
  # Kyverno: ÏãúÏä§ÌÖú NS Ï†úÏô∏
  - selector:
      sources: [kyverno, KyvernoValidatingPolicy, KyvernoImageValidatingPolicy]
    namespaces:
      exclude:
        - kube-system
        - kube-public
        - kube-node-lease
    disableClusterReports: false
   
  # Trivy: goyoai-web Ìè¨Ìï®
  - selector:
      sources: 
        - trivy-vulnerabilityreport
        - trivy-configauditreport
        - trivy-exposedsecretreport
    namespaces:
      include:
        - goyoai-web
    disableClusterReports: false

worker: 5

rest:
  enabled: true

metrics:
  enabled: true
  mode: detailed

# -----------------------------------------------------------------------------
# 4. Î™®ÎãàÌÑ∞ÎßÅ ÏÑ§Ï†ï (Prometheus & Grafana)
# -----------------------------------------------------------------------------
monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
    namespace: prometheus
    honorLabels: true
    interval: 30s
    scrapeTimeout: 10s
    labels:
      release: goyo-prometheus-stack
  
  # [Ï∂îÍ∞Ä] Grafana ÎåÄÏãúÎ≥¥Îìú ÏûêÎèô ÏÉùÏÑ± (ConfigMap Î∞©Ïãù)
  grafana:
    dashboards:
      enabled: false
      namespace: prometheus # ÎåÄÏãúÎ≥¥Îìú ConfigMapÏù¥ ÏÉùÏÑ±Îê† ÏúÑÏπò

# -----------------------------------------------------------------------------
# 5. ÌîåÎü¨Í∑∏Ïù∏ Ïó∞Í≤∞ (Core -> Plugin)
# -----------------------------------------------------------------------------
plugins:
  trivy:
    host: http://policy-reporter-trivy-plugin:8080
    skipExistingOnStartup: false
    sources:
      - trivy-vulnerabilityreport
      - trivy-configauditreport
      - trivy-exposedsecretreport

  kyverno:
    host: http://policy-reporter-kyverno-plugin:8080

# -----------------------------------------------------------------------------
# 6. UI ÏÑ§Ï†ï
# -----------------------------------------------------------------------------
ui:
  enabled: true
  log:
    level: debug
   
  ingress:
    enabled: true
    annotations:
      nginx.ingress.kubernetes.io/rewrite-target: /$1
    className: nginx
    hosts:
      - host: localhost
        paths:
        - path: "/ui/(.*)"
          pathType: ImplementationSpecific

  # UI -> Plugin ÏßÅÏ†ë Ïó∞Í≤∞
  plugins:
    kyverno:
      host: http://policy-reporter-kyverno-plugin:8080
    trivy:
      host: http://policy-reporter-trivy-plugin:8080
   
  # ÏÜåÏä§ ID Îß§Ìïë
  sources:
    - name: kyverno
      type: result
      exceptions: false
     
    - name: trivy-vulnerabilityreport
      type: severity
      excludes:
        results: [pass, error, skip]
     
    - name: trivy-configauditreport
      type: severity
      excludes:
        results: [pass, error, skip]
     
    - name: trivy-exposedsecretreport
      type: severity

  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 64Mi
   
  service:
    port: 8080
    type: ClusterIP

# -----------------------------------------------------------------------------
# 7. ÌîåÎü¨Í∑∏Ïù∏ Î∞∞Ìè¨ ÏÑ§Ï†ï (Trivy & Kyverno)
# -----------------------------------------------------------------------------
plugin:
  kyverno:
    enabled: true
    replicaCount: 1
    rbac:
      enabled: true
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 1234
      fsGroup: 1234
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
      readOnlyRootFilesystem: true
   
  trivy:
    enabled: true
    replicaCount: 1
    image:
      registry: ghcr.io
      repository: kyverno/policy-reporter/trivy-plugin
      pullPolicy: IfNotPresent
      tag: "0.4.11"
    cli:
      image:
        registry: ghcr.io
        repository: aquasecurity/trivy
        pullPolicy: IfNotPresent
        tag: "0.66.0"
    rbac:
      enabled: true
    serviceAccount:
      create: true
      name: policy-reporter-trivy-plugin
    resources:
      limits:
        cpu: 500m
        memory: 1Gi
      requests:
        cpu: 100m
        memory: 512Mi
    skipExistingOnStartup: false
    scanInterval: 60
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 1234
      fsGroup: 1234
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
      readOnlyRootFilesystem: true